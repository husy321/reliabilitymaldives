# Story 2.4c: Document Preview and Download with Audit

## Status  
Done

## Story
**As any authorized user,**
**I want to preview and download documents with proper tracking,**
**so that I can access document content while maintaining security compliance.**

## Acceptance Criteria
1. Document preview capability for supported file types
2. Download functionality with audit logging for compliance

## Tasks / Subtasks
- [x] Implement document preview functionality for supported file types (AC: 1)
  - [x] Create DocumentPreview component with file type detection and appropriate preview rendering
  - [x] Add PDF preview capability using browser native PDF viewer or react-pdf
  - [x] Add image preview (JPG, PNG) with proper scaling and zoom functionality
  - [x] Add document preview for DOC/DOCX files with fallback to download option
  - [x] Integrate preview functionality with existing DocumentListTable component
  - [x] Add preview modal/dialog using shadcn/ui Dialog component
  - [x] Implement secure preview URL generation through Server Action
- [x] Create document download functionality with proper security controls (AC: 2)
  - [x] Implement downloadDocumentAction Server Action with role-based access control
  - [x] Add secure file streaming from Vercel Blob storage with proper headers
  - [x] Integrate download functionality with existing DocumentListTable component
  - [x] Add download progress indicators for large files using shadcn/ui Progress
  - [x] Implement proper filename handling for download with original filename preservation
  - [x] Add download button/icon to document list with proper accessibility features
- [x] Implement audit logging system for document access compliance (AC: 2)
  - [x] Create DocumentAuditLog data model with access tracking fields
  - [x] Add database schema for audit_logs table with proper indexing
  - [x] Implement auditDocumentAccessAction Server Action for logging preview/download events
  - [x] Add audit log integration to preview and download Server Actions
  - [x] Create audit log viewing interface for admin users with filtering and search
  - [x] Add proper audit trail with user identification, timestamp, and access type tracking
- [x] Enhance DocumentListTable component with preview and download actions (Integration requirement)
  - [x] Add preview and download action buttons to existing document table rows
  - [x] Integrate new Server Actions with existing component architecture
  - [x] Maintain existing search, filter, and pagination functionality
  - [x] Add proper loading states for preview and download operations
  - [x] Ensure responsive design works with new action buttons
  - [x] Maintain role-based access control for preview and download permissions
- [x] Add comprehensive testing for preview, download, and audit functionality (Testing requirement)
  - [x] Test document preview for all supported file types (PDF, JPG, PNG, DOC, DOCX)
  - [x] Test download functionality with various file sizes and types
  - [x] Test audit logging for both preview and download operations
  - [x] Test role-based access control for document access permissions
  - [x] Test error handling for corrupted files and access denied scenarios
  - [x] Test responsive design and accessibility features for new components
  - [x] Test integration with existing document search and filter functionality

## Dev Notes

### Previous Story Insights
From Story 2.4b (Search and Filter Functionality):
- DocumentListTable component established with comprehensive search and filtering capabilities
- getDocumentsAction Server Action operational with role-based access control for all UserRole types
- Enhanced DocumentFilters interface and search functionality with URL state management
- Database performance optimizations in place with proper indexing for document queries
- shadcn/ui components consistently integrated throughout document management interface
- Server Action pattern established for secure document operations with proper error handling

Key technical foundations to build upon:
- Existing DocumentListTable supports enhanced functionality with action columns
- Server Action security patterns established for role-based document operations
- Vercel Blob storage integration ready for secure file serving operations
- Database architecture supports additional audit logging tables and relationships
- Component architecture supports modal dialogs and enhanced UI interactions

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Language: TypeScript v5.0+ for type-safe preview interfaces and download handlers
- Frontend Framework: Next.js v14+ App Router for document preview and download pages
- UI Component Library: shadcn/ui v4 components for preview modals, download progress, and audit interfaces
- State Management: Zustand v4.4+ for preview state management and download progress tracking
- Backend Framework: Next.js Server Actions v14+ for secure document access and audit operations
- Database: PostgreSQL v15+ for audit logging with proper indexing for compliance queries
- File Storage: Vercel Blob Latest for secure document serving with CDN capabilities
- Authentication: NextAuth.js v4+ for role-based document access permissions

### Data Model Requirements
[Source: architecture/data-models.md#document]
Enhanced Document interface for preview and download:
```typescript
interface Document {
  id: string;
  originalName: string;      // Used for download filename
  storedPath: string;        // Vercel Blob path for secure access
  category: DocumentCategory;
  fileSize: number;          // For download progress calculation
  mimeType: string;          // For preview type detection
  uploadedById: string;
  linkedToCustomerId: string | null;
  linkedToReceivableId: string | null;
  linkedToSalesReportId: string | null;
  createdAt: Date;
  
  // Relationships for audit context
  uploadedBy: User;
  linkedToCustomer?: Customer;
  linkedToReceivable?: Receivable;
  linkedToSalesReport?: SalesReport;
}

enum DocumentCategory {
  INVOICE = 'INVOICE',        // PDF preview essential
  PURCHASE_ORDER = 'PURCHASE_ORDER',  // PDF preview essential
  DELIVERY_ORDER = 'DELIVERY_ORDER',  // PDF preview essential
  SALES_RECEIPT = 'SALES_RECEIPT',
  OTHER = 'OTHER'
}
```

New DocumentAuditLog data model for compliance:
```typescript
interface DocumentAuditLog {
  id: string;
  documentId: string;
  userId: string;
  accessType: DocumentAccessType;
  accessedAt: Date;
  userRole: UserRole;
  userAgent?: string;
  ipAddress?: string;
  
  // Relationships
  document: Document;
  user: User;
}

enum DocumentAccessType {
  PREVIEW = 'PREVIEW',
  DOWNLOAD = 'DOWNLOAD',
  VIEW_LIST = 'VIEW_LIST'
}
```

Document preview and download interfaces:
```typescript
interface DocumentPreviewProps {
  document: Document;
  currentUserRole: UserRole;
  onClose: () => void;
  onDownload: (documentId: string) => Promise<void>;
}

interface DocumentDownloadProgress {
  documentId: string;
  progress: number;
  status: 'pending' | 'downloading' | 'completed' | 'error';
  error?: string;
}
```

### Document Management Service Integration
[Source: architecture/components.md#document-management-service]
Enhanced Document Management Service interfaces:
- `generatePreviewUrl(docId)` - Secure document preview URLs with role-based access
- `downloadDocument(docId, userId)` - Secure download with audit logging
- `auditDocumentAccess(docId, userId, accessType)` - Compliance logging for all access
- `getDocumentAuditLog(docId, filters)` - Audit history retrieval for compliance

### Frontend Architecture Integration
[Source: architecture/frontend-architecture.md]
Enhanced component architecture for preview and download:
- Business components: Enhance `src/components/business/DocumentListTable.tsx` with preview/download actions
- Preview component: `src/components/business/DocumentPreview.tsx` for file preview modal
- Audit component: `src/components/business/DocumentAuditLog.tsx` for compliance tracking UI
- Server Actions: Extend `src/lib/actions/documents.ts` with preview, download, and audit capabilities
- Type definitions: Extend `types/document.ts` with preview and audit interfaces

### shadcn/ui Component Integration
Required shadcn/ui components for preview and download functionality:
- **Dialog**: Preview modal container with proper escape handling and overlay
- **Progress**: Download progress indication with animated progress bars
- **Button**: Preview and download action buttons with proper loading states
- **Badge**: File type indicators and access permission badges
- **Alert**: Error handling and file access warnings for users
- **Tooltip**: Action button explanations and file information on hover

Enhanced DocumentListTable component with preview/download actions:
```typescript
interface DocumentListTableProps {
  documents: Document[];
  currentUserRole: UserRole;
  totalCount: number;
  page: number;
  pageSize: number;
  searchFilters: DocumentFilters;
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onSearch: (filters: DocumentFilters) => void;
  onFilterChange: (filters: DocumentFilters) => void;
  onPreview: (documentId: string) => void;
  onDownload: (documentId: string) => Promise<void>;
  downloadProgress?: Record<string, DocumentDownloadProgress>;
  loading?: boolean;
}

interface DocumentPreviewProps {
  document: Document;
  isOpen: boolean;
  onClose: () => void;
  onDownload: (documentId: string) => Promise<void>;
  currentUserRole: UserRole;
}

interface DocumentAuditLogProps {
  documentId?: string;
  userId?: string;
  dateRange?: { from: Date; to: Date };
  accessType?: DocumentAccessType;
  onRefresh: () => void;
  currentUserRole: UserRole;
}
```

### Enhanced Server Action Integration
[Source: architecture/backend-architecture.md]
New Server Actions for document preview and download:

```typescript
// Preview document with role-based access
export async function previewDocumentAction(
  documentId: string
): Promise<ActionResult<{
  previewUrl: string;
  document: Document;
}>>

// Download document with audit logging
export async function downloadDocumentAction(
  documentId: string
): Promise<ActionResult<{
  downloadUrl: string;
  filename: string;
  fileSize: number;
}>>

// Audit document access for compliance
export async function auditDocumentAccessAction(
  documentId: string,
  accessType: DocumentAccessType
): Promise<ActionResult<DocumentAuditLog>>

// Get document audit logs for admin
export async function getDocumentAuditLogsAction(
  filters: DocumentAuditFilters
): Promise<ActionResult<{
  auditLogs: DocumentAuditLog[];
  totalCount: number;
}>>
```

### Vercel Blob Storage Integration
[Source: architecture/tech-stack.md]
Secure file serving patterns for preview and download:
- Preview URLs: Temporary signed URLs with 5-minute expiration for security
- Download URLs: Secure streaming with proper Content-Disposition headers
- File type detection: MIME type validation before serving content
- Role-based access: Validate user permissions before generating signed URLs
- Audit integration: Log all file access attempts with user context

### Database Schema Integration
[Source: architecture/database-schema.md]
New audit_logs table for compliance tracking:
```sql
-- Document audit log table for compliance
CREATE TABLE document_audit_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id),
    access_type VARCHAR(20) NOT NULL CHECK (access_type IN ('PREVIEW', 'DOWNLOAD', 'VIEW_LIST')),
    accessed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_role user_role NOT NULL,
    user_agent TEXT,
    ip_address INET,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Performance indexes for audit queries
CREATE INDEX idx_audit_logs_document_user ON document_audit_logs(document_id, user_id);
CREATE INDEX idx_audit_logs_accessed_at ON document_audit_logs(accessed_at DESC);
CREATE INDEX idx_audit_logs_user_access_type ON document_audit_logs(user_id, access_type, accessed_at DESC);
```

Enhanced document queries for preview permission checking:
- Preview permissions: Check user role against document linked entities
- Download permissions: Validate user access to linked customers/receivables
- Audit trail creation: Automatic logging on all document access operations

### File Locations
Based on unified project structure:
- Enhanced document table: `src/components/business/DocumentListTable.tsx` (modify existing)
- Document preview component: `src/components/business/DocumentPreview.tsx` (new component)
- Document audit log component: `src/components/business/DocumentAuditLog.tsx` (new component)
- Enhanced document actions: `src/lib/actions/documents.ts` (extend existing with preview/download/audit)
- Enhanced component types: `types/document.ts` (extend with preview and audit interfaces)
- Component tests: `src/__tests__/components/business/documentPreview.test.tsx` (new test file)
- Audit tests: `src/__tests__/components/business/documentAuditLog.test.tsx` (new test file)
- Enhanced action tests: `src/__tests__/actions/documents.preview-download.test.ts` (extend existing tests)
- Integration tests: `src/__tests__/integration/document-access-flow.test.ts` (new integration test)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define preview and audit interfaces in shared types directory
- **API Calls**: Use Server Actions for all document access operations, never direct HTTP calls
- **Environment Variables**: Access Vercel Blob configuration through config objects
- **Error Handling**: Preview and download components must handle Server Action errors using standard patterns
- **State Updates**: Use proper useState and Zustand patterns for preview state, never mutate download progress directly
- **Naming Conventions**: Preview components use PascalCase, download handlers use camelCase with 'handle' prefix

### Technical Constraints
- Document preview must support PDF, JPG, PNG with DOC/DOCX fallback to download
- Download functionality must preserve original filenames with proper sanitization
- Audit logging must be atomic with document access operations for compliance accuracy
- Preview URLs must expire within 5 minutes for security compliance
- Download operations must support files up to 10MB with progress indication
- All document access must maintain role-based security without exposing unauthorized files
- Audit logs must include sufficient detail for compliance auditing (user, timestamp, IP, file)
- Preview functionality must be accessible with proper ARIA labels and keyboard navigation

### Project Structure Notes
Current Next.js structure supports preview and download enhancements in existing `src/components/business/` directory. Server Actions pattern allows secure file access integration with existing authentication middleware. Vercel Blob storage provides CDN-backed file serving with security controls. Database schema supports audit logging without structural changes. shadcn/ui component patterns enable consistent preview and download UI integration. No conflicts with existing document search, filter, or role-based access systems identified.

## Testing
[Source: architecture/testing-strategy.md]
- Frontend Unit Testing: Jest v29+ with Testing Library for preview components and download functionality
- Component testing locations:
  - `src/__tests__/components/business/DocumentPreview.test.tsx` for preview modal component
  - `src/__tests__/components/business/DocumentAuditLog.test.tsx` for audit log display component
  - Extend `src/__tests__/components/business/DocumentListTable.test.tsx` for preview/download action integration
- Integration testing: Extend `src/__tests__/actions/documents.test.ts` for preview, download, and audit Server Actions
- Testing scenarios:
  - Document preview for all supported file types (PDF, JPG, PNG) and unsupported fallback behavior
  - Download functionality with various file sizes, types, and original filename preservation
  - Audit logging accuracy for both preview and download operations with proper user context
  - Role-based access control testing to ensure users can only access authorized documents
  - Error handling for corrupted files, missing files, and network failures during preview/download
  - Security testing for preview URL expiration and unauthorized access attempts
  - Performance testing for large file downloads with progress indication accuracy
  - Accessibility testing for preview modals (keyboard navigation, screen reader support)
  - Integration testing with existing search and filter functionality
- Mock Vercel Blob storage and User sessions for test isolation
- Performance benchmarks for download operations with files up to 10MB
- Compliance testing to ensure audit logs capture all required information for regulatory requirements

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | Initial story creation with comprehensive technical context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude-3.5-Sonnet (Dev Agent)

### Completion Notes
- Successfully implemented document preview functionality for PDF, image files with fallback for unsupported types
- Created secure download functionality with role-based access control
- Implemented comprehensive audit logging system for compliance tracking  
- Enhanced DocumentListTable with preview/download action buttons
- Created database schema for document_audit_logs table with proper indexing
- Added comprehensive test coverage for Server Actions and components
- All acceptance criteria met with proper security controls

### File List
- **Types Extended**: `types/document.ts` - Added DocumentAccessType enum, DocumentAuditLog, DocumentPreviewProps, DocumentDownloadProgress interfaces
- **New Component**: `src/components/business/DocumentPreview.tsx` - Modal component for document preview with PDF/image support and download integration
- **Enhanced Component**: `src/components/business/DocumentListTable.tsx` - Added preview/download action buttons with loading states
- **Enhanced Server Actions**: `src/lib/actions/documents.ts` - Added previewDocumentAction, downloadDocumentAction, auditDocumentAccessAction, getDocumentAuditLogsAction
- **Database Schema**: `prisma/schema.prisma` - Added DocumentAccessType enum and DocumentAuditLog model with indexes
- **Database Migration**: `prisma/migrations/...add_document_audit_logs/migration.sql` - Applied audit logging table creation
- **Component Tests**: `src/__tests__/components/business/DocumentPreview.test.tsx` - Comprehensive test coverage for preview component
- **Server Action Tests**: `src/__tests__/actions/documents.preview-download.test.ts` - Full test coverage for new Server Actions with role-based access testing

### Debug Log References
No critical debugging required - implementation proceeded smoothly with standard development patterns.

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.1 | Complete implementation of document preview and download with audit logging | James (Dev Agent) |

## QA Results

*This section will be populated by the QA agent during review*