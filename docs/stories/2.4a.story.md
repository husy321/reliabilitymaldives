# Story 2.4a: Document Storage and Basic Listing

## Status  
done

## Story
**As any authorized user,**
**I want to view uploaded documents in an organized list,**
**so that I can see what documents are available in the system.**

## Acceptance Criteria
1. Document listing interface using shadcn/ui DataTable component
2. Role-based access permissions for document visibility

## Tasks / Subtasks
- [x] Implement Document listing DataTable component using shadcn/ui (AC: 1)
  - [x] Create DocumentListTable component with proper TypeScript interfaces
  - [x] Integrate shadcn/ui DataTable with columns for filename, category, upload date, uploaded by
  - [x] Add proper TypeScript interface for table data structure
  - [x] Implement table sorting, pagination, and filtering capabilities
  - [x] Connect to existing Document database model from previous stories
- [x] Build document data fetching Server Action (AC: 1)
  - [x] Create getDocumentsAction Server Action with proper TypeScript return types
  - [x] Implement database queries using Prisma ORM for Document model
  - [x] Add pagination support for large document lists
  - [x] Include proper error handling for database query failures
  - [x] Return formatted data compatible with DataTable component
- [x] Implement role-based access control for document visibility (AC: 2)
  - [x] Add user role checking in getDocumentsAction Server Action
  - [x] Filter documents based on UserRole enum permissions from authentication
  - [x] Implement proper authorization middleware for document access
  - [x] Add role-specific document visibility rules (user can see own uploads + role permissions)
  - [x] Handle unauthorized access attempts with proper error responses
- [x] Create document listing page and routing integration (Integration requirement)
  - [x] Create document listing page using Next.js App Router
  - [x] Integrate DocumentListTable component with page layout
  - [x] Add proper loading states and error boundaries
  - [x] Implement responsive design for mobile and desktop viewing
  - [x] Connect to existing navigation structure from previous stories
- [x] Add comprehensive component and integration testing (Testing requirement)
  - [x] Test DocumentListTable rendering with various document datasets
  - [x] Test role-based filtering with different UserRole enum values
  - [x] Test pagination, sorting, and filtering functionality
  - [x] Test Server Action integration and error handling
  - [x] Test responsive design and accessibility features
  - [x] Test integration with existing authentication and navigation systems

## Dev Notes

### Previous Story Insights
From Story 2.3b (Category Confirmation and Fallback UI):
- Document database model established with DocumentCategory enum and proper relationships
- Upload workflow completed with category confirmation and storage to Vercel Blob
- Server Actions pattern established for document operations
- Document metadata stored with user accountability (uploadedById) and customer linking
- shadcn/ui components successfully integrated with consistent styling

From Story 2.2 (Drag-and-Drop Upload Interface):
- User authentication and role tracking operational for document uploads
- File validation and security measures implemented (max 10MB, supported formats)
- Upload progress and success feedback patterns established

Key integration requirements:
- Document listing must display previously uploaded documents from existing database
- Role-based access must work with established UserRole enum and authentication
- DataTable must handle large document collections with proper pagination
- Component must integrate with existing shadcn/ui styling and layout patterns

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Language: TypeScript v5.0+ for type-safe DataTable props and document interfaces
- Frontend Framework: Next.js v14+ with App Router for document listing page
- UI Component Library: shadcn/ui v4 DataTable component with business styling consistency
- State Management: Zustand v4.4+ for client state, React Query for server state if needed
- Backend Framework: Next.js API Routes v14+ with Server Actions for document fetching
- Database: PostgreSQL v15+ with existing document storage from previous stories

### Data Model Requirements
[Source: architecture/data-models.md#document]
Document interface for DataTable display:
```typescript
interface Document {
  id: string;
  originalName: string;
  storedPath: string;
  category: DocumentCategory;
  fileSize: number;
  mimeType: string;
  uploadedById: string;
  linkedToCustomerId: string | null;
  linkedToReceivableId: string | null;
  linkedToSalesReportId: string | null;
  createdAt: Date;
  
  // Relationships for display
  uploadedBy: User;
  linkedToCustomer?: Customer;
  linkedToReceivable?: Receivable;
  linkedToSalesReport?: SalesReport;
}

enum DocumentCategory {
  INVOICE = 'INVOICE',        // INV.xxxx/xx pattern from Story 2.3a
  PURCHASE_ORDER = 'PURCHASE_ORDER',  // PO.xxxx/xx pattern from Story 2.3a
  DELIVERY_ORDER = 'DELIVERY_ORDER',  // DO.xxxx/xx pattern from Story 2.3a
  SALES_RECEIPT = 'SALES_RECEIPT',
  OTHER = 'OTHER'
}
```

UserRole enum for access control:
```typescript
enum UserRole {
  ADMIN = 'ADMIN',        // Full document access
  SALES = 'SALES',        // Sales-related documents + own uploads
  ACCOUNTS = 'ACCOUNTS',  // Financial documents + own uploads
  MANAGER = 'MANAGER',    // Management reports + own uploads
  ACCOUNTANT = 'ACCOUNTANT' // Financial documents + own uploads
}
```

### Frontend Architecture Integration
[Source: architecture/frontend-architecture.md]
Component placement within established architecture:
- Business components: `src/components/business/DocumentListTable.tsx` for main DataTable component
- Page components: `app/documents/page.tsx` for document listing page using App Router
- Server Actions: Extend `src/lib/actions/documents.ts` with getDocumentsAction
- Type definitions: `types/document.ts` for DataTable-specific interfaces

### Database Schema Integration
[Source: architecture/database-schema.md]
Existing documents table structure to query:
```sql
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    original_name VARCHAR(500) NOT NULL,
    stored_path VARCHAR(1000) NOT NULL,
    category document_category NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    uploaded_by_id UUID NOT NULL REFERENCES users(id),
    linked_to_customer_id UUID REFERENCES customers(id),
    linked_to_receivable_id UUID REFERENCES receivables(id),
    linked_to_sales_report_id UUID REFERENCES sales_reports(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

Performance indexes available for document queries:
- `idx_documents_category_customer` for category and customer filtering
- Standard created_at ordering for chronological listing
- User relationship for uploadedBy filtering

### shadcn/ui DataTable Component Specifications
[Source: architecture/components.md#document-management-service]
Required shadcn/ui components for document listing:
- **DataTable**: Main component for document display with sorting, filtering, pagination
  - Column configuration for filename, category, upload date, uploaded by
  - Built-in sorting capabilities for chronological and alphabetical ordering
  - Search/filter functionality for filename and category
  - Pagination controls for large document collections
- **Badge**: Category display with consistent DocumentCategory enum styling
- **Button**: Action buttons for view/download functionality (future stories)
- **Avatar**: User display for uploaded by column with proper user information

### Component Architecture Requirements
DocumentListTable component specification:
```typescript
interface DocumentListTableProps {
  documents: Document[];
  currentUserRole: UserRole;
  totalCount: number;
  page: number;
  pageSize: number;
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onFilter: (filters: DocumentFilters) => void;
}

interface DocumentFilters {
  category?: DocumentCategory;
  uploadedBy?: string;
  filename?: string;
  dateRange?: { start: Date; end: Date };
}
```

### Server Action Integration Pattern
getDocumentsAction Server Action specification:
```typescript
interface GetDocumentsParams {
  page?: number;
  pageSize?: number;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
  filters?: DocumentFilters;
}

export async function getDocumentsAction(
  params: GetDocumentsParams
): Promise<ActionResult<{
  documents: Document[];
  totalCount: number;
  page: number;
  pageSize: number;
}>>
```

Role-based filtering logic:
- ADMIN: Access to all documents in system
- SALES/ACCOUNTS/MANAGER/ACCOUNTANT: Access to own uploads + role-relevant documents
- Security: Never expose documents user doesn't have permission to see

### Backend Architecture Integration
[Source: architecture/backend-architecture.md]
Prisma ORM queries for document listing:
- Use established Document model with relationships
- Include proper joins for uploadedBy User relationship
- Apply role-based WHERE clauses for security
- Implement pagination with offset/limit for performance
- Use established error handling patterns for database failures

### File Locations
Based on flat Next.js project structure:
- Document listing table: `src/components/business/DocumentListTable.tsx` (new component)
- Document listing page: `app/documents/page.tsx` (new App Router page)
- Enhanced document actions: `src/lib/actions/documents.ts` (extend with getDocumentsAction)
- Component types: `types/document.ts` (extend with DataTable interfaces)
- Tests: `src/__tests__/components/business/documentListTable.test.tsx` (new test file)
- Integration tests: `src/__tests__/actions/documents.listing.test.ts` (extend existing tests)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define DocumentListTableProps and filtering interfaces in shared types directory
- **API Calls**: Use Server Actions for data fetching, never direct HTTP calls in components
- **Environment Variables**: Access configuration through config objects if needed
- **Error Handling**: DataTable components must handle Server Action errors using standard patterns
- **State Updates**: Use proper useState patterns for pagination and filtering, never mutate state directly
- **Naming Conventions**: Component functions use PascalCase, action handlers use camelCase

### Technical Constraints
- Document listing must handle large datasets with efficient pagination (500+ documents)
- Role-based filtering must be secure and performant with proper database indexing
- DataTable must be responsive and accessible with proper ARIA labels
- Component must integrate seamlessly with existing shadcn/ui styling patterns
- Server Actions must follow established error handling and security patterns
- Database queries must use existing indexes for optimal performance

### Project Structure Notes
Current flat Next.js structure accommodates DataTable components in `src/components/business/` following established business component pattern. App Router page structure supports document listing at `/documents` route. Integration with existing Server Actions maintains consistency with current architecture. No conflicts with existing document upload or authentication systems identified.

## Testing
[Source: architecture/testing-strategy.md]
- Frontend Unit Testing: Jest v29+ with Testing Library for DataTable component rendering and interactions
- Component testing location: `src/__tests__/components/business/DocumentListTable.test.tsx` for new DataTable component
- Integration testing: Extend existing `src/__tests__/actions/documents.test.ts` for getDocumentsAction Server Action
- Testing scenarios:
  - DataTable rendering with various document datasets (empty, small, large collections)
  - Role-based filtering with all UserRole enum values and permission boundaries
  - Pagination, sorting, and filtering functionality with edge cases
  - Server Action integration and error handling (network failures, database errors)
  - Responsive design and accessibility testing (keyboard navigation, screen readers)
  - Integration with existing authentication and navigation systems
- Mock Prisma queries and User sessions for test isolation
- Ensure proper TypeScript types in all test files for Document interfaces
- Test performance with large datasets to validate pagination efficiency

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-08 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude-3.5-Sonnet (claude-sonnet-4-20250514)

### Debug Log References
- Fixed Avatar component import from AvatarInitials to AvatarFallback (src/components/business/DocumentListTable.tsx:26)
- Corrected app directory structure from /app to /src/app for Next.js 14+ (src/app/documents/page.tsx)
- Added TanStack React Table dependency for advanced DataTable functionality
- Enhanced document Server Action with role-based access control and pagination

### Completion Notes List
- Successfully implemented DocumentListTable component with full sorting, filtering, and pagination capabilities
- Enhanced getDocumentsAction Server Action with comprehensive role-based access control for all UserRole types (ADMIN, SALES, ACCOUNTS, MANAGER, ACCOUNTANT)
- Created responsive document listing page with loading states and error handling
- Added comprehensive test coverage for both component behavior and Server Action functionality
- Integration with existing shadcn/ui component library maintained consistency with project design system

### File List
**New Files Created:**
- `src/components/business/DocumentListTable.tsx` - Main DataTable component with sorting, filtering, pagination
- `src/app/documents/page.tsx` - Document listing page with state management
- `src/__tests__/components/business/DocumentListTable.test.tsx` - Component tests (21 test cases)
- `src/__tests__/actions/documents.listing.test.ts` - Server Action tests for enhanced functionality

**Modified Files:**
- `types/document.ts` - Added DocumentWithUser, DocumentFilters, GetDocumentsParams, GetDocumentsResult interfaces
- `src/lib/actions/documents.ts` - Enhanced getDocumentsAction with role-based filtering, pagination, and sorting

**Dependencies Added:**
- `@tanstack/react-table` - Advanced table functionality
- `jest-mock-extended` - Enhanced mocking for tests (dev dependency)

## QA Results

*This section will be populated by the QA agent during review*