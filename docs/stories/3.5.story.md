# Story 3.5: Conversation Logging and Export

## Status
Draft

## Story
**As an Accounts team member,**
**I want to log customer conversations and export follow-up records,**
**so that I can maintain comprehensive communication records.**

## Acceptance Criteria
1. Conversation logging interface with rich text input for detailed notes
2. Export functionality for follow-up logs in PDF format with professional formatting
3. Conversation search and filtering capabilities

## Tasks / Subtasks
- [ ] Create rich text conversation logging interface (AC: 1)
  - [ ] Build ConversationLogger component with rich text editor capabilities
  - [ ] Implement conversation entry form with customer and receivable context
  - [ ] Add timestamp, conversation type, and participant information fields
  - [ ] Integrate conversation logging with existing follow-up management system
  - [ ] Add conversation categorization and tagging functionality
- [ ] Implement PDF export functionality for follow-up records (AC: 2)
  - [ ] Create FollowUpExportService for PDF generation with professional formatting
  - [ ] Build export interface with date range and filter selection
  - [ ] Generate comprehensive follow-up reports with customer details and conversation history
  - [ ] Add company branding and letterhead to exported PDF documents
  - [ ] Implement export preview functionality before final generation
- [ ] Build comprehensive search and filtering system (AC: 3)
  - [ ] Create advanced search interface for conversation content and metadata
  - [ ] Implement filtering by date range, conversation type, customer, and status
  - [ ] Add full-text search capabilities for conversation notes and details
  - [ ] Create saved search functionality for frequently used filter combinations
  - [ ] Add search result highlighting and relevance scoring

## Dev Notes

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- UI Component Library: shadcn/ui v4 for professional business UI with rich text input components
- Frontend Language: TypeScript 5.0+ for type-safe development
- Database: PostgreSQL 15+ with full-text search capabilities for conversation content

### Frontend Architecture Requirements
[Source: architecture/frontend-architecture.md]
- Component Organization: Business-specific components in src/components/business/receivables/
- State Management: Zustand for conversation state management
- Form Components: Server Actions integration for conversation logging

### Database Schema Enhancement
Building on existing follow-up schema with conversation-specific enhancements:
```sql
-- Extend follow_ups table for rich conversation logging
ALTER TABLE follow_ups ADD COLUMN conversation_participants TEXT[];
ALTER TABLE follow_ups ADD COLUMN conversation_summary TEXT;
ALTER TABLE follow_ups ADD COLUMN conversation_tags TEXT[];
ALTER TABLE follow_ups ADD COLUMN conversation_duration INTEGER; -- minutes

-- Add full-text search index for conversation content
CREATE INDEX idx_follow_ups_fulltext ON follow_ups USING gin(to_tsvector('english', notes || ' ' || COALESCE(conversation_summary, '')));

-- Conversation export tracking
CREATE TABLE follow_up_exports (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    exported_by_id UUID NOT NULL REFERENCES users(id),
    export_parameters JSONB NOT NULL,
    file_path VARCHAR(1000),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### PDF Generation Requirements
[Source: architecture/components.md#pdf-generation-service]
PDF Generation Service for follow-up exports:
- Company branding integration with letterhead and professional formatting
- Comprehensive conversation history with chronological ordering
- Customer context and receivable details
- Export metadata and generation timestamp

### Data Model Extension
Extending existing FollowUp model for conversation logging:
```typescript
interface FollowUp {
  id: string;
  customerId: string;
  receivableId: string | null;
  userId: string;
  followUpDate: Date;
  followUpType: FollowUpType;
  notes: string; // Rich text content
  conversationSummary?: string;
  conversationParticipants?: string[];
  conversationTags?: string[];
  conversationDuration?: number; // minutes
  status: FollowUpStatus;
  createdAt: Date;
  updatedAt: Date;
}
```

### Coding Standards
[Source: architecture/coding-standards.md]
- Components: Use PascalCase naming (ConversationLogger.tsx, FollowUpExport.tsx)
- API Routes: Use kebab-case for conversation endpoints (/api/conversations)
- Type Sharing: Define conversation types in shared types directory

### File Locations
- Conversation logger: `src/components/business/receivables/ConversationLogger.tsx`
- Export interface: `src/components/business/receivables/FollowUpExport.tsx`
- Search interface: `src/components/business/receivables/ConversationSearch.tsx`
- Export service: `src/services/followUpExportService.ts`
- Conversation API: `app/api/conversations/route.ts`
- Export API: `app/api/follow-ups/export/route.ts`
- Types: `types/conversation.ts`

### Testing Requirements
[Source: architecture/testing-strategy.md]
- Frontend Testing: Jest + Testing Library for rich text input and export interface testing
- Backend Testing: Jest + Supertest for conversation logging and export API testing
- PDF generation testing with various conversation data scenarios

## Testing
[Source: architecture/testing-strategy.md]
- Test file location: `src/__tests__/components/business/receivables/ConversationLogger.test.tsx`
- Test standards: Jest + Testing Library for React components, Jest + Supertest for API testing
- Testing frameworks: Jest 29+ and Testing Library 13+ with TypeScript support
- Specific requirements: Test rich text input, conversation search, PDF export generation, filtering capabilities, and full-text search functionality

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation for conversation logging and export | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes
*This section will be populated by the development agent during implementation*

### File List
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*