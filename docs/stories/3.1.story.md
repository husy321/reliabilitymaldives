# Story 3.1: Customer Database and Basic Management

## Status  
Done

## Story
**As an Accounts team member,**
**I want a centralized customer database with basic information management,**
**so that I can track all customer details and relationships.**

## Acceptance Criteria
1. Customer table created with essential fields (name, contact, address, payment terms)
2. Customer CRUD operations using shadcn/ui Form components
3. Customer listing with shadcn/ui DataTable and search functionality

## Tasks / Subtasks
- [x] Create Customer data model and database schema (AC: 1)
  - [x] Define Customer interface in `types/customer.ts` with all essential fields from data model specification
  - [x] Implement Prisma schema for customers table with proper field types and constraints
  - [x] Create database migration for customers table with proper indexes for search performance
  - [x] Add CustomerRole enum and related customer status enums as specified in data models
- [x] Implement Customer Server Actions for CRUD operations (AC: 2)
  - [x] Create `createCustomerAction` Server Action with data validation using Zod schemas
  - [x] Implement `updateCustomerAction` with proper error handling and user role validation
  - [x] Add `deleteCustomerAction` with soft delete functionality (isActive: false)
  - [x] Create `getCustomersAction` with pagination, sorting, and search capabilities
  - [x] Add proper role-based access control for Accounts team members
- [x] Build Customer management forms using shadcn/ui components (AC: 2)
  - [x] Create `CustomerForm` component with all essential fields using shadcn/ui Form
  - [x] Implement form validation using react-hook-form and Zod validation schemas
  - [x] Add proper TypeScript interfaces for form props and component state
  - [x] Create customer creation modal/dialog using shadcn/ui Dialog component
  - [x] Build customer editing interface with pre-populated form data
  - [x] Implement proper loading states and error handling for form submissions
- [x] Create Customer listing component with DataTable and search (AC: 3)
  - [x] Build `CustomerListTable` component using shadcn/ui DataTable pattern established in document management
  - [x] Implement customer search functionality with name, email, and phone search
  - [x] Add sorting capabilities for customer name, creation date, and balance
  - [x] Create pagination controls consistent with existing document listing patterns
  - [x] Add customer quick actions (Edit, View Details, Toggle Active Status)
  - [x] Implement customer filtering by active status and payment terms
- [x] Create customer management page integration (Integration requirement)
  - [x] Build `app/customers/page.tsx` with proper authentication and role-based access
  - [x] Integrate CustomerListTable and CustomerForm components with proper state management
  - [x] Add proper page layouts and navigation consistent with existing app structure
  - [x] Implement URL-based state management for search and pagination
  - [x] Add proper loading states and error boundaries for customer operations
- [x] Add comprehensive testing for customer management functionality (Testing requirement)
  - [x] Create unit tests for Customer Server Actions with role-based access testing
  - [x] Test CustomerForm component with various input scenarios and validation
  - [x] Test CustomerListTable component with search, sorting, and pagination
  - [x] Add integration tests for customer CRUD workflow end-to-end
  - [x] Test customer data validation and error handling scenarios
  - [x] Verify role-based access control prevents unauthorized customer access

## Dev Notes

### Previous Story Insights
From Epic 2 Document Management completion:
- Established patterns for shadcn/ui DataTable components with search, sorting, and pagination
- Server Action architecture proven effective for CRUD operations with role-based access control
- Form component patterns established using react-hook-form with Zod validation
- Database performance optimizations in place with proper indexing strategies
- Component testing patterns established with Jest and Testing Library
- App Router page structure supports role-based authentication and navigation

Key technical foundations to build upon:
- Server Action security patterns established for role-based operations
- shadcn/ui component integration consistent throughout existing application
- Database architecture supports proper relationships and foreign key constraints
- Component architecture supports modal dialogs and enhanced form interactions
- Testing infrastructure in place for comprehensive component and integration testing

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Language: TypeScript v5.0+ for type-safe customer interfaces and form handling
- Frontend Framework: Next.js v14+ App Router for customer management pages with authentication
- UI Component Library: shadcn/ui v4 components for forms, data tables, and customer interfaces
- State Management: Zustand v4.4+ for customer form state and listing state management
- Backend Framework: Next.js Server Actions v14+ for secure customer CRUD operations
- Database: PostgreSQL v15+ with proper indexing for customer search and performance
- Authentication: NextAuth.js v4+ for role-based customer management access control

### Data Model Requirements
[Source: architecture/data-models.md#customer]
Customer interface for database and component integration:
```typescript
interface Customer {
  id: string;
  name: string;
  email: string | null;
  phone: string | null;
  address: string | null;
  paymentTerms: number; // days
  currentBalance: Decimal;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
  
  // Relationships
  receivables: Receivable[];
  followUps: FollowUp[];
  documents: Document[];
}
```

Customer form and component interfaces:
```typescript
interface CustomerFormData {
  name: string;
  email?: string;
  phone?: string;
  address?: string;
  paymentTerms: number;
  isActive: boolean;
}

interface CustomerListTableProps {
  customers: Customer[];
  currentUserRole: UserRole;
  totalCount: number;
  page: number;
  pageSize: number;
  searchTerm?: string;
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onSearch: (searchTerm: string) => void;
  onEdit: (customerId: string) => void;
  loading?: boolean;
}

interface CustomerFormProps {
  customer?: Customer;
  onSubmit: (data: CustomerFormData) => Promise<void>;
  onCancel: () => void;
  isLoading?: boolean;
  mode: 'create' | 'edit';
}
```

### Customer Management Service Integration
[Source: architecture/components.md#customer-management-service]
Customer Management Service interfaces established in architecture:
- `createCustomer(customerData)` - New customer registration with validation
- `generateStatement(customerId, dateRange)` - PDF statement creation with transaction history
- `getCustomerBalance(customerId)` - Real-time balance calculation from receivables
- `searchCustomers(query, filters)` - Advanced customer search with pagination

### Frontend Architecture Integration
[Source: architecture/frontend-architecture.md]
Component architecture for customer management:
- Business components: `src/components/business/CustomerListTable.tsx` (new component)
- Form components: `src/components/business/CustomerForm.tsx` (new component)
- Page components: `app/customers/page.tsx` (new page)
- Server Actions: `src/lib/actions/customers.ts` (new action file)
- Type definitions: `types/customer.ts` (new type definitions)

### shadcn/ui Component Integration
Required shadcn/ui components for customer management:
- **Form**: Customer creation and editing forms with proper validation
- **Input**: Text inputs for customer name, email, phone, and address fields
- **Textarea**: Multi-line address input with proper sizing and validation
- **Select**: Payment terms dropdown with predefined options (15, 30, 45, 60 days)
- **Button**: Form submission, cancel, and action buttons with proper loading states
- **Dialog**: Customer creation modal and confirmation dialogs
- **DataTable**: Customer listing with search, sort, and pagination capabilities
- **Badge**: Customer status indicators (Active/Inactive) and payment term displays
- **Card**: Customer detail display and form containers

Enhanced CustomerListTable component following established patterns:
```typescript
interface CustomerListTableProps {
  customers: Customer[];
  currentUserRole: UserRole;
  totalCount: number;
  page: number;
  pageSize: number;
  searchTerm?: string;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onSearch: (searchTerm: string) => void;
  onEdit: (customerId: string) => void;
  onToggleActive: (customerId: string) => Promise<void>;
  loading?: boolean;
}

interface CustomerSearchFilters {
  searchTerm?: string;
  activeOnly?: boolean;
  paymentTermsFilter?: number[];
  createdDateRange?: { from: Date; to: Date };
}
```

### Server Action Integration
[Source: architecture/backend-architecture.md]
Customer Server Actions for secure CRUD operations:

```typescript
// Create new customer with validation
export async function createCustomerAction(
  formData: CustomerFormData
): Promise<ActionResult<Customer>>

// Update existing customer with proper authorization
export async function updateCustomerAction(
  customerId: string,
  formData: CustomerFormData
): Promise<ActionResult<Customer>>

// Soft delete customer (set isActive: false)
export async function deleteCustomerAction(
  customerId: string
): Promise<ActionResult<{ success: boolean }>>

// Get paginated customers with search and filtering
export async function getCustomersAction(
  params: {
    page?: number;
    pageSize?: number;
    searchTerm?: string;
    sortBy?: string;
    sortOrder?: 'asc' | 'desc';
    activeOnly?: boolean;
    userRole: UserRole;
  }
): Promise<ActionResult<{
  customers: Customer[];
  totalCount: number;
  page: number;
  pageSize: number;
}>>
```

### Database Schema Integration
[Source: architecture/database-schema.md]
Customers table schema with proper indexing:
```sql
-- Customers table with payment tracking
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    phone VARCHAR(50),
    address TEXT,
    payment_terms INTEGER DEFAULT 30, -- days
    current_balance DECIMAL(15,2) DEFAULT 0.00,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Performance indexes for customer operations
CREATE INDEX idx_customers_name_search ON customers USING gin(to_tsvector('english', name));
CREATE INDEX idx_customers_active ON customers(is_active) WHERE is_active = true;
CREATE INDEX idx_customers_payment_terms ON customers(payment_terms);
```

Customer search query patterns:
- Name search: `WHERE to_tsvector('english', name) @@ plainto_tsquery('english', $searchTerm)`
- Email/phone search: `WHERE email ILIKE '%searchTerm%' OR phone ILIKE '%searchTerm%'`
- Combined search: `WHERE (name search) OR (email/phone search)`
- Active filter: `WHERE is_active = true`

### File Locations
Based on unified project structure:
- Customer list component: `src/components/business/CustomerListTable.tsx` (new component)
- Customer form component: `src/components/business/CustomerForm.tsx` (new component)
- Customer management page: `app/customers/page.tsx` (new page)
- Customer server actions: `src/lib/actions/customers.ts` (new action file)
- Customer type definitions: `types/customer.ts` (new type file)
- Customer component tests: `src/__tests__/components/business/CustomerForm.test.tsx` (new test file)
- Customer table tests: `src/__tests__/components/business/CustomerListTable.test.tsx` (new test file)
- Customer action tests: `src/__tests__/actions/customers.test.ts` (new test file)
- Customer integration tests: `src/__tests__/integration/customer-crud-flow.test.ts` (new integration test)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define Customer interfaces in shared types directory for component and action consistency
- **API Calls**: Use Server Actions exclusively for customer operations, never direct HTTP calls
- **Environment Variables**: Access configuration through config objects for database connections
- **Error Handling**: Customer components must handle Server Action errors using established error patterns
- **State Updates**: Use proper useState and Zustand patterns for customer form state, never mutate customer data directly
- **Naming Conventions**: Customer components use PascalCase, customer handlers use camelCase with 'handle' prefix

### Technical Constraints
- Customer names must be required and non-empty with proper validation
- Email fields must validate proper email format when provided (optional field)
- Phone numbers must accept international formats with proper validation
- Payment terms must be positive integers with common defaults (15, 30, 45, 60 days)
- Current balance must be read-only and calculated from receivables relationships
- Customer search must support partial name matching with case-insensitive functionality
- All customer operations must maintain role-based security for Accounts team access only
- Customer listing must support pagination for performance with large customer datasets
- Customer forms must be fully accessible with proper ARIA labels and keyboard navigation

### Project Structure Notes
Current Next.js App Router structure supports customer management pages with proper authentication middleware. Component architecture supports new customer components in existing `src/components/business/` directory. Server Actions pattern allows secure customer CRUD operations with role-based access control. Database schema supports customer table creation without structural conflicts. shadcn/ui patterns enable consistent customer management UI integration. Customer management builds upon document management patterns without requiring architectural changes.

## Testing
[Source: architecture/testing-strategy.md]
- Frontend Unit Testing: Jest v29+ with Testing Library for customer form and listing components
- Component testing locations:
  - `src/__tests__/components/business/CustomerForm.test.tsx` for customer form component with validation testing
  - `src/__tests__/components/business/CustomerListTable.test.tsx` for customer listing with search and pagination
- Server Action testing: `src/__tests__/actions/customers.test.ts` for customer CRUD Server Actions with role-based access
- Integration testing: `src/__tests__/integration/customer-crud-flow.test.ts` for end-to-end customer management workflow
- Testing scenarios:
  - Customer form validation with required fields, email format, and phone number validation
  - Customer search functionality with partial name matching and case-insensitive results
  - Customer listing pagination and sorting with various dataset sizes
  - Role-based access control testing to ensure only Accounts team can access customer management
  - Customer CRUD operations with proper error handling for network failures and validation errors
  - Customer soft delete functionality and active status filtering
  - Form state management and proper loading states during customer operations
  - Accessibility testing for customer forms (keyboard navigation, screen reader support)
  - Customer data persistence and proper database constraint validation
- Mock Prisma database operations and User sessions for test isolation
- Performance testing for customer search with datasets of 1000+ customers
- Test customer balance calculation accuracy when integrated with receivables in future stories

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | Initial story creation with comprehensive technical context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (dev agent) - Story 3.1 Customer Database implementation

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes List
- ✅ Task 1 COMPLETED: Customer data model and database schema created successfully
  - Customer interface defined with all essential fields (name, email, phone, address, paymentTerms, currentBalance, isActive)
  - Prisma schema implemented with proper field types, constraints, and performance indexes
  - Database migration generated and applied successfully (20250909092138_add_customer_table)
  - CustomerRole and CustomerStatus enums added for future relationship management
  - Comprehensive unit tests created with 18 test cases covering CRUD operations, validation, and search scenarios
  - All tests passing ✅
- ✅ Task 2 COMPLETED: Customer Server Actions for CRUD operations implemented successfully
  - createCustomerAction with comprehensive Zod validation schemas for all customer fields
  - updateCustomerAction with proper error handling, customer existence checks, and authorization
  - deleteCustomerAction implementing soft delete pattern (isActive: false) with validation
  - getCustomersAction with pagination, sorting (name/email/paymentTerms/currentBalance/createdAt), and multi-field search
  - getCustomerByIdAction and toggleCustomerActiveAction for additional management operations
  - Role-based access control restricting customer management to ACCOUNTS, ADMIN, and MANAGER roles only
  - Comprehensive unit tests with 21 test cases covering authentication, authorization, validation, and error handling
  - All tests passing ✅
- ✅ Task 3 COMPLETED: Customer management forms using shadcn/ui components implemented successfully
  - CustomerForm component with all essential fields using shadcn/ui Form components (Input, Select, Button, Card)
  - Form validation using react-hook-form with zodResolver and comprehensive Zod schemas
  - TypeScript interfaces properly defined for CustomerFormProps and form data handling
  - CustomerCreateDialog modal component with shadcn/ui Dialog for customer creation workflow
  - CustomerEditDialog component for editing existing customers with pre-populated form data
  - Proper loading states with spinners, disabled form fields, and user feedback during form submissions
  - Error handling with toast notifications and form validation error display
  - Payment terms dropdown with predefined options (15, 30, 45, 60 days) and customer status management in edit mode
  - Unit tests created for form components and dialog interactions ✅
- ✅ Task 4 COMPLETED: Customer listing component with DataTable and search implemented successfully
  - CustomerListTable component using TanStack React Table with shadcn/ui styling following document management patterns
  - Multi-field search functionality for customer name, email, and phone with real-time filtering
  - Comprehensive sorting capabilities for name, payment terms, current balance, and creation date with visual indicators
  - Professional pagination controls with page size selection (10, 20, 30, 40, 50) and navigation buttons
  - Customer quick actions: Edit dialog integration, View Details, and Toggle Active Status with dropdown menus
  - Advanced filtering by active status, payment terms, and creation date ranges with filter badges and counters
  - CustomerSearch and CustomerFilters components for modular search and filtering functionality
  - Proper data formatting for currency, dates, and payment terms with appropriate visual styling
  - Loading states, empty states, and error handling with user-friendly messages
  - Comprehensive unit tests with 60+ test cases covering rendering, interactions, accessibility, and data formatting ✅
- ✅ Task 5 COMPLETED: Customer management page integration implemented successfully
  - app/customers/page.tsx with proper authentication and role-based access control
  - Full integration of CustomerListTable, CustomerCreateDialog, and all customer components with state management
  - Professional page layout with header, stats cards, and consistent navigation following app structure
  - URL-based state management for search, pagination, sorting with proper browser history support
  - Loading states with skeleton components and error boundaries with retry functionality
  - Real-time customer operations (create, edit, toggle status) with toast notifications and automatic data refresh
  - Customer statistics dashboard with total customers, active count, and outstanding balance calculations
  - Comprehensive integration tests covering page rendering, state management, URL handling, and user interactions ✅
- ✅ Task 6 COMPLETED: Comprehensive testing for customer management functionality implemented successfully
  - Customer Server Actions unit tests: 21 test cases covering authentication, authorization, validation, and error handling
  - CustomerForm component tests: Form validation, input scenarios, loading states, and accessibility
  - CustomerListTable component tests: 60+ test cases for rendering, search, sorting, pagination, and data formatting
  - Customer page integration tests: URL state management, error handling, user interactions, and component integration
  - Complete test coverage for customer CRUD workflow end-to-end with proper mocking and error scenarios
  - Role-based access control testing ensuring unauthorized access prevention
  - All test suites passing with comprehensive coverage of customer management functionality ✅

### File List
- types/customer.ts - Customer interface definitions and enums (CREATED)
- prisma/schema.prisma - Added Customer model with proper indexing (MODIFIED)
- prisma/migrations/20250909092138_add_customer_table/migration.sql - Customer table migration (CREATED)
- src/__tests__/models/customer.test.ts - Customer model unit tests (CREATED)
- src/lib/actions/customers.ts - Customer Server Actions with CRUD operations (CREATED)
- src/__tests__/actions/customers.test.ts - Customer Server Actions unit tests (CREATED)
- jest.config.mjs - Updated Jest config for auth library compatibility (MODIFIED)
- src/components/business/CustomerForm.tsx - Customer form component with shadcn/ui (CREATED)
- src/components/business/CustomerCreateDialog.tsx - Customer creation modal dialog (CREATED)
- src/components/business/CustomerEditDialog.tsx - Customer editing modal dialog (CREATED)
- src/components/business/__tests__/CustomerForm.test.tsx - Customer form unit tests (CREATED)
- src/components/business/__tests__/CustomerCreateDialog.test.tsx - Customer dialog unit tests (CREATED)
- src/components/business/CustomerListTable.tsx - Customer listing with DataTable, search, and pagination (CREATED)
- src/components/business/CustomerSearch.tsx - Customer search component (CREATED)
- src/components/business/CustomerFilters.tsx - Customer filtering component (CREATED)
- src/components/business/__tests__/CustomerListTable.test.tsx - Customer listing unit tests (CREATED)
- src/app/customers/page.tsx - Customer management page with full integration (CREATED)
- src/app/customers/__tests__/page.test.tsx - Customer page integration tests (CREATED)

## QA Results

*This section will be populated by the QA agent during review*