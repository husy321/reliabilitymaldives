# Story 2.4b: Search and Filter Functionality

## Status  
Done

## Story
**As any authorized user,**
**I want to search and filter documents efficiently,**
**so that I can quickly find specific documents I need.**

## Acceptance Criteria
1. Search functionality by filename, category, and upload date
2. Filter options for document categories and date ranges

## Tasks / Subtasks
- [x] Enhance DocumentListTable component with search functionality (AC: 1)
  - [x] Add search input field with debounced search functionality for filename search
  - [x] Integrate category search dropdown with DocumentCategory enum options
  - [x] Add upload date search with date range picker component using shadcn/ui
  - [x] Update existing DocumentFilters interface to include comprehensive search parameters
  - [x] Maintain existing sorting and pagination while adding search capabilities
  - [x] Ensure search works with role-based access control from previous story
- [x] Enhance getDocumentsAction Server Action with search capabilities (AC: 1, 2)
  - [x] Extend Server Action to handle filename search with ILIKE pattern matching
  - [x] Add category filtering with DocumentCategory enum validation
  - [x] Implement upload date range filtering with proper SQL date comparison
  - [x] Optimize database queries with proper indexing for search performance
  - [x] Maintain role-based access control while adding search filtering
  - [x] Add proper error handling for invalid search parameters
- [x] Implement filter UI components for document categories and date ranges (AC: 2)
  - [x] Create category filter dropdown with multi-select capability using shadcn/ui Select
  - [x] Build date range picker component with predefined quick filters (last 7 days, last 30 days, etc.)
  - [x] Add clear filters functionality to reset search state
  - [x] Implement filter state management with proper state persistence
  - [x] Ensure filter UI integrates seamlessly with existing DataTable layout
  - [x] Add visual indicators for active filters and search terms
- [x] Update document listing page with enhanced search and filter integration (Integration requirement)
  - [x] Integrate enhanced DocumentListTable component with new search capabilities
  - [x] Add proper loading states for search operations with debounced updates
  - [x] Implement URL state management for bookmarkable search results
  - [x] Add search result count and performance feedback to users
  - [x] Ensure responsive design works with new search and filter components
  - [x] Maintain existing accessibility features with new search functionality
- [x] Add comprehensive testing for search and filter functionality (Testing requirement)
  - [x] Test filename search with various search terms and edge cases
  - [x] Test category filtering with single and multiple category selections
  - [x] Test date range filtering with various date combinations
  - [x] Test combined search and filter operations for complex queries
  - [x] Test role-based access with search functionality to ensure security
  - [x] Test performance with large datasets to validate search optimization
  - [x] Test responsive design and accessibility features for new search components

## Dev Notes

### Previous Story Insights
From Story 2.4a (Document Storage and Basic Listing):
- DocumentListTable component established with shadcn/ui DataTable, sorting, and pagination
- getDocumentsAction Server Action operational with role-based access control for all UserRole types
- DocumentFilters interface partially defined with basic filtering structure
- Database queries optimized with proper indexing for document listing performance
- Role-based filtering works with UserRole enum (ADMIN, SALES, ACCOUNTS, MANAGER, ACCOUNTANT)
- Component integration with App Router page and state management established

Key technical foundations to build upon:
- Existing DataTable supports column sorting and pagination that must be preserved
- Server Action pattern established for secure document operations with proper error handling
- shadcn/ui styling consistency maintained throughout document management interface
- Database performance optimizations already in place for document queries

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Language: TypeScript v5.0+ for type-safe search interfaces and filter components
- Frontend Framework: Next.js v14+ App Router for enhanced document listing page
- UI Component Library: shadcn/ui v4 components for search inputs, date pickers, and filter dropdowns
- State Management: Zustand v4.4+ for search state management and filter persistence
- Backend Framework: Next.js Server Actions v14+ for enhanced document search operations
- Database: PostgreSQL v15+ with text search capabilities and proper indexing for performance

### Data Model Requirements
[Source: architecture/data-models.md#document]
Enhanced DocumentFilters interface for comprehensive search:
```typescript
interface DocumentFilters {
  // Existing filters from 2.4a
  category?: DocumentCategory | DocumentCategory[];
  uploadedBy?: string;
  filename?: string;
  dateRange?: { start: Date; end: Date };
  
  // Enhanced search functionality
  filenameSearch?: string;        // Full-text search in originalName
  categoryFilter?: DocumentCategory[];  // Multi-select category filtering
  uploadDateRange?: { from: Date; to: Date };  // Specific date range
  quickDateFilter?: 'last7days' | 'last30days' | 'last90days' | 'thisYear';
}

interface DocumentSearchParams extends DocumentFilters {
  searchTerm?: string;           // Combined search across filename and content
  sortBy?: 'filename' | 'category' | 'uploadDate' | 'uploadedBy';
  sortOrder?: 'asc' | 'desc';
  page?: number;
  pageSize?: number;
}
```

Document model for search operations:
```typescript
interface Document {
  id: string;
  originalName: string;      // Primary search field
  storedPath: string;
  category: DocumentCategory; // Filter field
  fileSize: number;
  mimeType: string;
  uploadedById: string;      // Filter by uploader
  linkedToCustomerId: string | null;
  linkedToReceivableId: string | null;
  linkedToSalesReportId: string | null;
  createdAt: Date;          // Date range filtering
  
  // Relationships for display
  uploadedBy: User;         // User information for search
  linkedToCustomer?: Customer;
  linkedToReceivable?: Receivable;
  linkedToSalesReport?: SalesReport;
}

enum DocumentCategory {
  INVOICE = 'INVOICE',        // INV.xxxx/xx pattern
  PURCHASE_ORDER = 'PURCHASE_ORDER',  // PO.xxxx/xx pattern
  DELIVERY_ORDER = 'DELIVERY_ORDER',  // DO.xxxx/xx pattern
  SALES_RECEIPT = 'SALES_RECEIPT',
  OTHER = 'OTHER'
}
```

### Frontend Architecture Integration
[Source: architecture/frontend-architecture.md]
Enhanced component architecture for search functionality:
- Business components: Enhance `src/components/business/DocumentListTable.tsx` with search UI
- Search components: `src/components/business/DocumentSearch.tsx` for dedicated search interface
- Filter components: `src/components/business/DocumentFilters.tsx` for advanced filtering UI
- Page components: Update `app/documents/page.tsx` with search state management
- Server Actions: Extend `src/lib/actions/documents.ts` with enhanced search capabilities
- Type definitions: Extend `types/document.ts` with comprehensive search interfaces

### shadcn/ui Component Integration
[Source: architecture/components.md#document-management-service]
Required shadcn/ui components for search and filtering:
- **Input**: Search input field with debounced functionality and search icon
- **Select**: Category filter dropdown with multi-select capability
- **Calendar**: Date range picker for upload date filtering
- **Badge**: Active filter display with clear functionality
- **Button**: Clear filters and search actions with proper icons
- **Popover**: Advanced filter options container for date ranges and categories

Enhanced DocumentListTable component with search:
```typescript
interface DocumentListTableProps {
  documents: Document[];
  currentUserRole: UserRole;
  totalCount: number;
  page: number;
  pageSize: number;
  searchFilters: DocumentFilters;
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onSearch: (filters: DocumentFilters) => void;
  onFilterChange: (filters: DocumentFilters) => void;
  loading?: boolean;
}

interface DocumentSearchProps {
  onSearch: (searchTerm: string) => void;
  onClear: () => void;
  placeholder?: string;
  initialValue?: string;
  debounceMs?: number;
}

interface DocumentFiltersProps {
  availableCategories: DocumentCategory[];
  selectedCategories: DocumentCategory[];
  dateRange: { from?: Date; to?: Date };
  onCategoryChange: (categories: DocumentCategory[]) => void;
  onDateRangeChange: (range: { from?: Date; to?: Date }) => void;
  onQuickFilter: (filter: 'last7days' | 'last30days' | 'last90days' | 'thisYear') => void;
  onClearFilters: () => void;
}
```

### Enhanced Server Action Integration
[Source: architecture/backend-architecture.md]
Enhanced getDocumentsAction Server Action specification:
```typescript
interface GetDocumentsParams {
  page?: number;
  pageSize?: number;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
  
  // Enhanced search parameters
  searchTerm?: string;
  filenameSearch?: string;
  categoryFilter?: DocumentCategory[];
  uploadDateRange?: { from: Date; to: Date };
  uploadedBySearch?: string;
  
  // Existing role-based filtering
  userRole: UserRole;
  userId: string;
}

export async function getDocumentsAction(
  params: GetDocumentsParams
): Promise<ActionResult<{
  documents: Document[];
  totalCount: number;
  page: number;
  pageSize: number;
  appliedFilters: DocumentFilters;
}>>
```

Database query optimization for search:
- Full-text search on originalName using PostgreSQL ILIKE for case-insensitive matching
- Category filtering with IN clause for multi-select functionality
- Date range filtering with proper timezone handling
- Combined WHERE clauses maintaining role-based security
- Proper indexing on searchable fields for performance

### Database Schema Integration
[Source: architecture/database-schema.md]
Enhanced database indexes for search performance:
```sql
-- Existing indexes from Story 2.4a
CREATE INDEX idx_documents_category_customer ON documents(category, linked_to_customer_id);
CREATE INDEX idx_documents_created_at ON documents(created_at);
CREATE INDEX idx_documents_uploaded_by ON documents(uploaded_by_id);

-- New indexes for search functionality
CREATE INDEX idx_documents_filename_search ON documents USING gin(to_tsvector('english', original_name));
CREATE INDEX idx_documents_category_date ON documents(category, created_at);
CREATE INDEX idx_documents_filename_pattern ON documents(original_name text_pattern_ops);
```

Search query patterns for PostgreSQL:
- Filename search: `WHERE original_name ILIKE '%searchTerm%'`
- Category filtering: `WHERE category = ANY($categoryArray)`
- Date range: `WHERE created_at BETWEEN $startDate AND $endDate`
- Combined search with role security: `WHERE ... AND (user role conditions)`

### File Locations
Based on unified project structure:
- Enhanced document table: `src/components/business/DocumentListTable.tsx` (modify existing)
- Document search component: `src/components/business/DocumentSearch.tsx` (new component)
- Document filters component: `src/components/business/DocumentFilters.tsx` (new component)
- Enhanced document page: `app/documents/page.tsx` (modify existing)
- Enhanced document actions: `src/lib/actions/documents.ts` (extend existing with search)
- Enhanced component types: `types/document.ts` (extend with search interfaces)
- Component tests: `src/__tests__/components/business/documentSearch.test.tsx` (new test file)
- Filter tests: `src/__tests__/components/business/documentFilters.test.tsx` (new test file)
- Enhanced integration tests: `src/__tests__/actions/documents.search.test.ts` (extend existing tests)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define enhanced DocumentFilters and search interfaces in shared types directory
- **API Calls**: Use Server Actions for search operations, never direct HTTP calls in components
- **Environment Variables**: Access configuration through config objects for search performance tuning
- **Error Handling**: Search components must handle Server Action errors using standard patterns
- **State Updates**: Use proper useState and Zustand patterns for search state, never mutate search filters directly
- **Naming Conventions**: Search component functions use PascalCase, search handlers use camelCase with 'handle' prefix

### Technical Constraints
- Search functionality must maintain sub-500ms response time for typical document collections
- Filename search must support partial matching with case-insensitive functionality
- Category filtering must support multi-select with proper UI feedback
- Date range filtering must handle timezone considerations for accurate results
- Search must maintain role-based security without exposing unauthorized documents
- Search state must be bookmarkable through URL parameters for user convenience
- All search components must be fully accessible with proper ARIA labels and keyboard navigation

### Project Structure Notes
Current flat Next.js structure supports search enhancements in existing `src/components/business/` directory. App Router page structure allows for URL-based search state management. Integration with existing Server Actions maintains architectural consistency. Search functionality builds upon existing shadcn/ui patterns without requiring structural changes. No conflicts with existing authentication or document management systems identified.

## Testing
[Source: architecture/testing-strategy.md]
- Frontend Unit Testing: Jest v29+ with Testing Library for search components and filter interactions
- Component testing locations:
  - `src/__tests__/components/business/DocumentSearch.test.tsx` for search input component
  - `src/__tests__/components/business/DocumentFilters.test.tsx` for filter component functionality
  - Extend `src/__tests__/components/business/DocumentListTable.test.tsx` for enhanced table functionality
- Integration testing: Extend `src/__tests__/actions/documents.test.ts` for search Server Action functionality
- Testing scenarios:
  - Filename search with partial matches, case sensitivity, and special characters
  - Category filtering with single and multiple selections, including edge cases
  - Date range filtering with various date combinations and timezone considerations
  - Combined search operations testing multiple filters simultaneously
  - Performance testing with large document datasets to validate search optimization
  - Role-based access control testing to ensure search respects user permissions
  - URL state management testing for bookmarkable search results
  - Error handling for invalid search parameters and database connection issues
  - Accessibility testing for search components (keyboard navigation, screen readers)
  - Responsive design testing for mobile and tablet search interfaces
- Mock Prisma queries and User sessions for test isolation
- Performance benchmarks for search operations with datasets of 1000+ documents
- Test debounced search functionality to prevent excessive API calls

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-08 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude-3.5-Sonnet (claude-sonnet-4-20250514)

### Debug Log References
- Enhanced DocumentFilters interface with comprehensive search parameters (types/document.ts:64-83)
- Created dedicated DocumentSearch component with debounced search functionality (src/components/business/DocumentSearch.tsx)
- Implemented DocumentFilters component with multi-select categories and date range picker (src/components/business/DocumentFilters.tsx)
- Added required shadcn/ui components: Calendar, Checkbox, Popover with proper dependencies
- Fixed DocumentListTable component mock name collision during testing integration
- Updated getDocumentsAction Server Action with enhanced search logic and role-based filtering preservation

### Completion Notes List
- Successfully implemented debounced filename search with 300ms delay to prevent excessive API calls
- Enhanced DocumentListTable component with dedicated search and filter components maintaining existing functionality
- Created comprehensive filter system supporting multi-select categories and flexible date range filtering with quick filters
- Enhanced getDocumentsAction Server Action with backward-compatible search parameters and proper role-based access control
- Implemented URL state management for bookmarkable search results with proper encoding/decoding of filter parameters
- Added comprehensive test coverage for search components (DocumentSearch: 9 tests, DocumentFilters: 14 tests, DocumentListTable: 24 tests)
- Maintained existing sorting, pagination, and role-based security while adding advanced search capabilities

### File List
**New Files Created:**
- `src/components/business/DocumentSearch.tsx` - Debounced search input component with clear functionality
- `src/components/business/DocumentFilters.tsx` - Advanced filter component with category multi-select and date range picker
- `src/lib/hooks/useDebounce.ts` - Custom React hook for debouncing search input
- `src/__tests__/components/business/DocumentSearch.test.tsx` - Comprehensive search component tests (9 test cases)
- `src/__tests__/components/business/DocumentFilters.test.tsx` - Filter component tests (14 test cases)
- `src/__tests__/actions/documents.search.test.ts` - Server Action enhanced search functionality tests
- `src/__mocks__/prisma.ts` - Prisma mock for testing

**Modified Files:**
- `types/document.ts` - Enhanced DocumentFilters interface with comprehensive search parameters and new DocumentSearchParams interface
- `src/components/business/DocumentListTable.tsx` - Integrated search and filter components, updated props interface for enhanced functionality
- `src/lib/actions/documents.ts` - Enhanced getDocumentsAction with advanced search capabilities, role-based filtering, and applied filters response
- `src/app/documents/page.tsx` - Added URL state management, integrated enhanced search and filter functionality with bookmarkable results
- `src/__tests__/components/business/DocumentListTable.test.tsx` - Updated existing tests and added enhanced search and filter test coverage

**Dependencies Added:**
- `@radix-ui/react-checkbox` - Multi-select checkbox functionality for category filters
- `@radix-ui/react-popover` - Popover container for advanced filter options
- `react-day-picker` - Calendar component for date range selection (automatically added with shadcn calendar)

## QA Results

*This section will be populated by the QA agent during review*