# Story 4.6: Correction Cycle Management

## Status
Pending

## Story
**As a manager,**
**I want clear correction workflows when reports are rejected,**
**so that I can quickly identify and fix issues.**

## Acceptance Criteria
1. Rejected report notification with specific correction requirements
2. Report editing capability with change tracking and resubmission
3. Correction history display showing previous rejection reasons

## Tasks / Subtasks
- [ ] Create rejected report notification system (AC: 1)
  - [ ] Build RejectionNotification component with detailed correction requirements display
  - [ ] Implement notification delivery through existing Notification Service integration
  - [ ] Add correction requirement parsing and structured display of rejection feedback
  - [ ] Create notification action buttons for quick access to correction interface
  - [ ] Integrate with manager dashboard for prominent rejected report alerts
- [ ] Implement report editing with change tracking (AC: 2)
  - [ ] Build SalesReportCorrection component extending original upload interface
  - [ ] Add change tracking system highlighting modified fields from original submission
  - [ ] Implement version comparison showing original vs corrected values
  - [ ] Add correction comments field for explaining changes made
  - [ ] Create resubmission workflow with validation and duplicate prevention
- [ ] Build correction history display interface (AC: 3)
  - [ ] Create CorrectionHistory component showing chronological rejection timeline
  - [ ] Display previous rejection reasons with categorization and detailed feedback
  - [ ] Show correction attempts and changes made in response to rejections
  - [ ] Add visual indicators for correction cycle progress and resolution status
  - [ ] Implement expandable rejection details with full accountant feedback
- [ ] Create server actions for correction cycle operations (AC: 1, 2, 3)
  - [ ] Build getCorrectionRequirements server action for rejection detail retrieval
  - [ ] Build resubmitCorrectedReport server action with change tracking and validation
  - [ ] Build getCorrectionHistory server action for historical rejection data
  - [ ] Implement database operations for correction tracking and audit trails
  - [ ] Add validation for correction permissions and report ownership verification
- [ ] Integrate with Sales Report Workflow and Notification Services (AC: 1, 2, 3)
  - [ ] Connect correction workflow with Sales Report Workflow Service status management
  - [ ] Integrate with Notification Service for rejection alerts and resubmission confirmations
  - [ ] Implement correction cycle notifications to keep accountants informed of resubmissions
  - [ ] Add escalation notifications for repeated rejection cycles requiring intervention
  - [ ] Create notification templates for consistent correction communication
- [ ] Create comprehensive testing for correction cycle workflow (Testing requirement)
  - [ ] Create unit tests for RejectionNotification component and correction requirement display
  - [ ] Test SalesReportCorrection component change tracking and validation logic
  - [ ] Test CorrectionHistory component timeline display and rejection detail expansion
  - [ ] Test server actions for correction operations and change tracking
  - [ ] Test integration with notification service and workflow state management
  - [ ] Test role-based permissions and report ownership validation for corrections

## Dev Notes

### Previous Story Dependencies
From Story 4.5 Approval and Rejection Workflow:
- ApprovalActions component provides rejection system with categorized feedback
- RejectionReasonSelector establishes rejection categorization structure for correction guidance
- Approval audit trail system provides foundation for correction history tracking
- Notification integration established for real-time approval/rejection communication
- Database schema extensions for approval tracking support correction cycle requirements

From Story 4.2 Manager Sales Report Upload Interface:
- Sales report submission form provides foundation for correction interface
- Document attachment capability supports correction documentation requirements
- Server actions established for sales report operations and validation
- Protected routes and role-based access control for manager operations
- Form validation patterns established for data integrity and business rules

From Story 4.4a Basic Split-Screen Review Layout:
- SalesReportReview component provides accountant review interface context
- Status indicator system supports correction cycle status tracking
- Document viewer integration enables correction verification workflows
- Review interface patterns establish foundation for correction interfaces

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Framework: Next.js v14+ App Router for correction workflow routing and Server Components
- UI Component Library: shadcn/ui v4 for correction interface components and change tracking displays
- State Management: Zustand v4.4+ for correction workflow state and change tracking management
- Database: PostgreSQL v15+ for correction history storage and change audit trails
- Backend Framework: Next.js Server Actions for correction processing with transaction support
- Authentication: NextAuth.js v4+ for role-based correction permissions and report ownership validation
- Frontend Testing: Jest + Testing Library v29+/13+ for correction workflow component testing

### Component Architecture Requirements
[Source: architecture/components.md and frontend-architecture.md]
**Correction Component Location**: `src/components/corrections/` directory for correction workflow components
**Integration Pattern**: Extend existing report components with correction capabilities
**State Management**: React Query for server state management, Zustand for UI state and change tracking
**Form Handling**: React Hook Form for correction validation and change tracking
**Notification Integration**: Use existing notification patterns for correction alerts

### Sales Report Workflow Service Integration
[Source: architecture/components.md#sales-report-workflow-service]
**Enhanced Service Interfaces Required**:
- `getCorrectionRequirements(reportId)` - Retrieve detailed rejection feedback and correction instructions
- `resubmitCorrectedReport(reportId, correctedData, changes)` - Process corrected report with change tracking
- `getCorrectionHistory(reportId)` - Historical correction attempts and rejection reasons
- `validateCorrectionPermissions(userId, reportId)` - Ensure user can correct specific report
**Dependencies**: Document Management Service (correction documents), Authentication Service (ownership verification), Notification Service
**Technology Stack**: Server Actions for correction processing, shadcn/ui for correction interface components

### Notification Service Integration
[Source: architecture/components.md#notification-service]
**Required Notification Interfaces**:
- `sendNotification(managerId, rejectionAlert, 'REJECTION_ALERT')` - Immediate rejection notification with correction guidance
- `sendNotification(accountantId, resubmissionAlert, 'RESUBMISSION')` - Alert accountant of corrected report resubmission
- `scheduleAlert(reportId, escalationDate, correctionReminder)` - Follow-up alerts for outstanding corrections
- `broadcastToRole('SUPERVISOR', escalationMessage)` - Escalation for repeated rejection cycles
**Integration Requirements**: Real-time notifications for correction cycle events with actionable links to correction interface

### Database Schema Requirements
**Enhanced Correction Tracking Tables**:
```sql
-- Extend existing approval_history table for correction tracking
ALTER TABLE approval_history ADD COLUMN correction_attempt_number INTEGER DEFAULT 1;
ALTER TABLE approval_history ADD COLUMN correction_instructions TEXT;
ALTER TABLE approval_history ADD COLUMN requires_document_update BOOLEAN DEFAULT FALSE;

-- Create correction attempts tracking table
CREATE TABLE correction_attempts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sales_report_id UUID REFERENCES sales_reports(id) NOT NULL,
  attempt_number INTEGER NOT NULL,
  original_data JSONB NOT NULL,
  corrected_data JSONB NOT NULL,
  changes_summary TEXT,
  correction_comments TEXT,
  submitted_by UUID REFERENCES users(id) NOT NULL,
  submitted_at TIMESTAMPTZ DEFAULT now(),
  status VARCHAR(20) DEFAULT 'PENDING' -- 'PENDING', 'APPROVED', 'REJECTED'
);

-- Create correction change tracking table
CREATE TABLE correction_changes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  correction_attempt_id UUID REFERENCES correction_attempts(id) NOT NULL,
  field_name VARCHAR(100) NOT NULL,
  original_value TEXT,
  corrected_value TEXT,
  change_reason TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Create correction notifications table
CREATE TABLE correction_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sales_report_id UUID REFERENCES sales_reports(id) NOT NULL,
  notification_type VARCHAR(50) NOT NULL, -- 'REJECTION_ALERT', 'RESUBMISSION', 'ESCALATION'
  recipient_id UUID REFERENCES users(id) NOT NULL,
  message TEXT NOT NULL,
  action_url TEXT,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_correction_attempts_report ON correction_attempts(sales_report_id);
CREATE INDEX idx_correction_attempts_user ON correction_attempts(submitted_by);
CREATE INDEX idx_correction_changes_attempt ON correction_changes(correction_attempt_id);
CREATE INDEX idx_correction_notifications_recipient ON correction_notifications(recipient_id);
CREATE INDEX idx_correction_notifications_report ON correction_notifications(sales_report_id);
```

### Data Model Extensions
[Source: Previous stories and sales-report types]
**Enhanced SalesReport Interface with Correction Data**:
```typescript
interface SalesReportWithCorrections extends SalesReport {
  correctionAttempts: CorrectionAttempt[];
  currentAttemptNumber: number;
  requiresCorrection: boolean;
  lastRejectionReason?: string;
  lastRejectionCategory?: RejectionCategory;
  correctionInstructions?: string;
}

interface CorrectionAttempt {
  id: string;
  attemptNumber: number;
  originalData: SalesReportData;
  correctedData: SalesReportData;
  changesSummary: string;
  correctionComments?: string;
  submittedBy: User;
  submittedAt: Date;
  status: CorrectionStatus;
  changes: CorrectionChange[];
}

interface CorrectionChange {
  id: string;
  fieldName: string;
  originalValue: string | number;
  correctedValue: string | number;
  changeReason?: string;
  isSignificant: boolean; // Major changes requiring additional review
}

enum CorrectionStatus {
  PENDING = 'PENDING',
  APPROVED = 'APPROVED',
  REJECTED = 'REJECTED'
}

interface CorrectionRequirement {
  reportId: string;
  rejectionCategory: RejectionCategory;
  rejectionReason: string;
  correctionInstructions: string;
  requiredFields: string[];
  documentsRequired: boolean;
  deadline?: Date;
  attemptNumber: number;
}

interface CorrectionSubmission {
  reportId: string;
  correctedData: SalesReportData;
  changes: CorrectionChangeInput[];
  correctionComments: string;
  newDocuments?: File[];
}

interface CorrectionChangeInput {
  fieldName: string;
  newValue: string | number;
  changeReason: string;
}
```

### Correction Component Design
**RejectionNotification Component Structure**:
```typescript
interface RejectionNotificationProps {
  correctionRequirement: CorrectionRequirement;
  onStartCorrection: (reportId: string) => void;
  onDismiss: (notificationId: string) => void;
  priority: 'HIGH' | 'MEDIUM' | 'LOW';
}
```

**SalesReportCorrection Component Structure**:
```typescript
interface SalesReportCorrectionProps {
  report: SalesReportWithCorrections;
  correctionRequirement: CorrectionRequirement;
  onSubmitCorrection: (correction: CorrectionSubmission) => Promise<void>;
  onCancel: () => void;
}
```

**CorrectionHistory Component Structure**:
```typescript
interface CorrectionHistoryProps {
  reportId: string;
  correctionAttempts: CorrectionAttempt[];
  approvalHistory: ApprovalHistoryEntry[];
  expandedAttempt?: string;
  onExpandAttempt: (attemptId: string) => void;
}
```

### Correction Workflow States
**Rejection Alert Flow**:
- **Initial State**: Display prominent rejection notification with correction requirements
- **Review Flow**: Show detailed rejection feedback with categorized correction instructions
- **Action Flow**: Quick access buttons to start correction or view detailed requirements
- **Escalation Flow**: Progressive notifications for overdue corrections

**Correction Editing Flow**:
- **Setup State**: Load original report data and rejection requirements
- **Editing State**: Highlight required fields with change tracking visualization
- **Validation State**: Real-time validation against business rules and rejection requirements
- **Submission State**: Change summary review and correction comment input
- **Confirmation State**: Resubmission confirmation with change tracking summary

**History Display Flow**:
- **Timeline View**: Chronological display of all rejection and correction events
- **Detail View**: Expandable rejection details with full accountant feedback
- **Change View**: Side-by-side comparison of original vs corrected values
- **Progress View**: Visual indicators of correction cycle resolution progress

### Change Tracking Implementation
**Visual Change Indicators**:
- Modified fields highlighted with distinct color coding and change icons
- Original vs corrected value comparison with inline diff display
- Change reason tooltips explaining modifications made
- Significance indicators for major changes requiring additional review
- Change timestamp tracking for audit trail documentation

**Change Detection Logic**:
- Automatic detection of field modifications with deep object comparison
- Custom change detection for complex fields (amounts, dates, documents)
- Change categorization by significance and business impact
- Change validation against rejection requirements and business rules
- Change aggregation for summary display and reporting

### Notification Templates and Timing
**Rejection Alert Notifications**:
- **Immediate**: Real-time notification upon report rejection with correction requirements
- **Template**: "Report rejected: [Outlet] - [Date]. Requires: [Correction Summary]. Click to correct."
- **Priority**: HIGH for calculation errors, MEDIUM for missing documents, LOW for minor issues
- **Action**: Direct link to correction interface with pre-populated rejection context

**Escalation Notifications**:
- **24 Hours**: First reminder for uncorrected rejections
- **48 Hours**: Escalation to outlet supervisor with correction assistance offer
- **72 Hours**: Final escalation to regional manager with intervention requirement
- **Progressive**: Increasing urgency indicators and expanded recipient lists

### User Interface Design Requirements
**Rejection Notification Interface**:
- Prominent dashboard alerts with color-coded priority indicators
- Expandable notification cards showing correction requirements summary
- Quick action buttons for immediate correction access and detailed review
- Notification management with mark as read and dismiss functionality
- Mobile-responsive design for manager accessibility across devices

**Correction Form Interface**:
- Form pre-populated with original data and highlighted required correction fields
- Side-by-side comparison view showing original vs current values during editing
- Real-time validation feedback with correction requirement compliance indicators
- Change tracking panel showing all modifications with reasoning input
- Document re-upload capability for correction supporting evidence

**History Display Interface**:
- Timeline visualization with rejection and correction attempt markers
- Expandable history entries with detailed rejection feedback and correction responses
- Color-coded status indicators for correction attempt outcomes
- Change detail modals with full field-by-field comparison and reasoning
- Export capability for correction cycle documentation and analysis

### File Locations
[Source: architecture/unified-project-structure.md]
- Correction Components: `src/components/corrections/` directory (new)
  - `RejectionNotification.tsx` - Rejection alert and correction requirement display
  - `SalesReportCorrection.tsx` - Main correction form with change tracking
  - `CorrectionHistory.tsx` - Historical rejection and correction timeline
  - `ChangeTrackingPanel.tsx` - Change visualization and comparison display
  - `CorrectionSummary.tsx` - Pre-submission change summary and confirmation
- Enhanced Manager Dashboard: `src/components/dashboard/ManagerDashboard.tsx` (modify existing)
- Server Actions: `app/actions/correction-actions.ts` (new file)
- Type Definitions: `types/correction.ts` (new file), extend existing `types/sales-report.ts`
- Test Files: `src/__tests__/components/corrections/` directory (new)
- Database Migrations: `prisma/migrations/add-correction-tracking.sql` (new)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Component Naming**: Use PascalCase for correction components (`SalesReportCorrection.tsx`)
- **API Routes**: Use kebab-case for correction routes if needed (`/api/corrections`)
- **Type Sharing**: Define correction types in `types/correction.ts` for consistent interfaces
- **Error Handling**: All correction operations must use standard error handling patterns
- **State Updates**: Use proper state management patterns with immutable updates for change tracking
- **Validation**: Implement comprehensive input validation for corrections and change tracking

### Authentication and Role-Based Access
[Source: architecture/components.md#authentication-service]
**Required Role Validation**:
- Correction actions restricted to MANAGER role with report ownership validation
- Correction access limited to reports submitted by the authenticated manager
- Correction history access controlled through proper report ownership verification
- User session validation before processing correction operations
- Audit trail tracking for all correction attempts with manager identification

### Performance Considerations
**Optimization Requirements**:
- Debounce change tracking updates to prevent excessive re-renders during editing
- Implement pagination for correction history display for reports with many attempts
- Cache correction requirements and validation rules for efficient form processing
- Optimize database queries for correction history with proper indexing and joins
- Use React.memo for correction components to prevent unnecessary re-renders during change tracking

### Integration with Existing Workflow
**Manager Dashboard Enhancement**:
- Priority section for rejected reports requiring immediate correction
- Correction queue with deadline tracking and urgency indicators
- Quick access links to correction interfaces from dashboard alerts
- Correction statistics display showing resolution rates and cycle times

**Notification System Integration**:
- Real-time alerts for new rejections with prominent dashboard indicators
- Progressive escalation notifications for overdue corrections
- Confirmation notifications for successful resubmissions and approvals
- Integration with existing notification preferences and delivery methods

**Workflow State Management**:
- Update report status to 'CORRECTION_PENDING' upon rejection notification
- Track correction attempt numbers for escalation and analysis purposes
- Maintain workflow state consistency across correction cycles
- Trigger appropriate workflow transitions upon successful correction approval

### Business Rules and Validation
**Correction Validation Rules**:
- Required field corrections must address specific rejection requirements
- Calculation validation ensures mathematical accuracy in corrected amounts
- Document requirements validation for reports requiring supporting evidence updates
- Change magnitude validation for significant corrections requiring additional approval
- Deadline compliance validation for time-sensitive correction requirements

**Escalation Rules**:
- Automatic escalation after 48 hours for uncorrected calculation errors
- Supervisor notification for reports with 3+ correction attempts
- Regional manager escalation for correction cycles exceeding 5 days
- Special handling for month-end and quarter-end correction deadlines

### Project Structure Notes
Correction cycle management builds on established approval workflow patterns while extending capabilities for manager-focused correction workflows. Change tracking system provides transparency and audit trail for compliance requirements. Notification integration ensures timely correction processing and escalation management. Database schema extensions maintain referential integrity while supporting complex correction history tracking. User interface components follow established design patterns for consistency across the sales report workflow system.

## Testing
[Source: architecture/testing-strategy.md]
- **Frontend Unit Testing**: Jest + Testing Library v29+/13+ for correction workflow component validation
- **Integration Testing**: Jest + Supertest for correction server actions and database operations
- **E2E Testing**: Playwright for complete correction cycle workflow validation across user roles
- **Test Locations**:
  - `src/__tests__/components/corrections/RejectionNotification.test.tsx` - Rejection alert display and interaction testing
  - `src/__tests__/components/corrections/SalesReportCorrection.test.tsx` - Correction form and change tracking testing
  - `src/__tests__/components/corrections/CorrectionHistory.test.tsx` - History timeline and detail display testing
  - `src/__tests__/components/corrections/ChangeTrackingPanel.test.tsx` - Change visualization and comparison testing
  - `src/__tests__/actions/correction-actions.test.ts` - Server action testing for correction operations
  - `tests/e2e/correction-cycle.spec.ts` - End-to-end correction workflow testing
- **Testing Scenarios**:
  - Rejection notification display with correction requirement parsing and action buttons
  - Correction form pre-population with original data and change tracking functionality
  - Change detection and validation against rejection requirements and business rules
  - Correction history timeline display with expandable rejection details
  - Server action validation for correction operations and change tracking persistence
  - Integration with notification service for correction alerts and resubmission confirmations
  - Role-based permissions and report ownership validation for correction access
  - Database transaction integrity for correction attempt tracking and audit trails
  - Error handling for failed correction operations and validation failures
  - Performance testing for change tracking with large datasets and complex corrections

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation for correction cycle management | Claude Code |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent

### Implementation Status
**PENDING** - Story ready for development

### Completion Notes
*This section will be populated during implementation*

### File List
*This section will be populated during implementation*

### Debug Log References
*This section will be populated during implementation*

## QA Results

*This section will be populated by the QA agent during review*