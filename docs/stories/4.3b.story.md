# Story 4.3b: Batch Upload and Bulk Operations

## Status  
Done

## Story
**As a manager handling multiple outlets,**
**I want batch processing capabilities for efficiency,**
**so that I can handle multiple reports in one session.**

## Acceptance Criteria
1. Batch upload functionality for multiple dates or outlets
2. Bulk action capabilities for common operations

## Tasks / Subtasks
- [x] Implement batch date range selection for reports (AC: 1)
  - [x] Create BatchDatePicker component with multi-date and date range selection
  - [x] Add date range validation ensuring no gaps in required dates
  - [x] Implement date range display with clear visual indicators
  - [x] Add date range persistence using sessionStorage for session continuity
- [x] Build batch report entry interface (AC: 1)
  - [x] Create BatchSalesReportForm component extending SalesReportForm patterns
  - [x] Implement bulk data entry with spreadsheet-like interface
  - [x] Add data validation for batch entries with duplicate detection
  - [x] Implement bulk attachment management for multiple reports
- [x] Create bulk action management system (AC: 2)
  - [x] Build BulkActionToolbar component with operation selection
  - [x] Implement bulk submit functionality for multiple draft reports
  - [x] Add bulk delete capabilities with confirmation dialogs
  - [x] Create bulk status update operations for report management
- [x] Integrate with existing multi-outlet functionality (AC: 1, 2)
  - [x] Extend OutletContextSwitcher for batch operations across outlets
  - [x] Update useMultiOutletSelection hook to support batch processing
  - [x] Add outlet-specific batch validation and permission checks
  - [x] Implement batch data segregation by outlet context
- [x] Add comprehensive batch operation testing (Testing requirement)
  - [x] Create unit tests for BatchDatePicker multi-date selection logic
  - [x] Test BatchSalesReportForm bulk data entry and validation
  - [x] Test BulkActionToolbar operations and confirmation flows
  - [x] Test integration with multi-outlet selection and permission validation
  - [x] Test batch data persistence and session management

## Dev Notes

### Previous Story Insights
From Story 4.3a completion:
- OutletContextSwitcher component available with multi-outlet selection and switching
- useMultiOutletSelection hook implemented with outlet permission validation (managerId === user.id)
- SalesReportForm component with outlet context integration and form data persistence
- Zustand store for outlet context state management with localStorage persistence
- Existing sales report submission patterns using submitSalesReportAction server action
- Form data persistence during outlet switches using sessionStorage

### Tech Stack Requirements  
[Source: architecture/tech-stack.md]
- Frontend Framework: Next.js v14+ App Router for batch processing interfaces
- UI Components: shadcn/ui v4 for batch selection components, data tables, and bulk action toolbars
- State Management: Zustand v4.4+ for batch operation state management across components
- Form Processing: React Hook Form with batch validation patterns extending SalesReportForm
- Frontend Testing: Jest + Testing Library v29+/13+ for batch operation testing

### Component Architecture Requirements
[Source: architecture/frontend-architecture.md]
**Component Organization**: 
- Batch components in `src/components/business/` following established patterns
- Form extensions in `src/components/forms/` extending existing SalesReportForm
- Enhanced hooks in `src/hooks/` extending multi-outlet selection capabilities
- Bulk action toolbars in `src/components/ui/` for reusable bulk operations

### Sales Report Data Model Integration
[Source: types/sales-report.ts]
**SalesReport Model Usage**:
```typescript
interface SalesReport {
  id: string;
  outletId: string;
  date: Date;
  cashDeposits: number;
  cardSettlements: number;
  totalSales: number;
  submittedById: string;
  status: SalesReportStatus;
  createdAt: Date;
  updatedAt: Date;
}

enum SalesReportStatus {
  DRAFT = 'DRAFT',
  SUBMITTED = 'SUBMITTED', 
  APPROVED = 'APPROVED',
  REJECTED = 'REJECTED'
}
```

### Batch Processing Interface Requirements
**BatchDatePicker Component**:
- Multi-date selection with calendar interface using shadcn/ui components
- Date range selection with visual start/end indicators
- Validation for business rules (no future dates, required date ranges)
- Integration with existing DatePicker component patterns

**BatchSalesReportForm Component**:
- Spreadsheet-like data entry interface using shadcn/ui Table components
- Row-based entry with outlet, date, cash deposits, and card settlements
- Real-time total calculations across all rows
- Bulk validation with error highlighting per row
- Document attachment management per report entry

**BulkActionToolbar Component**:
- Operation selection dropdown with icons (Submit All, Delete Selected, etc.)
- Selection state management for individual and bulk operations
- Confirmation dialogs for destructive actions
- Progress indicators for bulk operations

### Batch State Management Architecture
[Source: architecture/frontend-architecture.md and existing patterns]
**Batch Operation State Management**:
- Zustand store extending outletContextStore for batch operation state
- Session storage for batch form data persistence during navigation
- Local state management for selection states in bulk operations
- Integration with existing outlet context state for permission validation

### Server Action Integration
[Source: architecture/api-specification.md and existing patterns]
**Batch Server Actions**:
- Extend existing submitSalesReportAction for batch processing
- Implement transaction handling for multiple report submissions
- Add batch validation to prevent duplicate submissions
- Maintain existing permission validation patterns (managerId === user.id)

### File Locations
[Source: architecture/unified-project-structure.md]
- Batch Date Picker: `src/components/business/BatchDatePicker.tsx` (new file)
- Batch Form: `src/components/forms/BatchSalesReportForm.tsx` (new file)
- Bulk Actions: `src/components/ui/BulkActionToolbar.tsx` (new file)
- Batch Store: `src/stores/batchOperationStore.ts` (new file using Zustand)
- Enhanced Hook: Extend existing `src/hooks/useMultiOutletSelection.ts`
- Types: Extend existing `types/sales-report.ts` with batch interfaces
- Test Files: `src/__tests__/components/BatchDatePicker.test.tsx` (new file)
- Test Files: `src/__tests__/components/BatchSalesReportForm.test.tsx` (new file)
- Test Files: `src/__tests__/components/BulkActionToolbar.test.tsx` (new file)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Component Naming**: Use PascalCase for all batch components
- **Hook Extensions**: Follow existing useMultiOutletSelection patterns
- **Type Sharing**: Extend types in existing `types/sales-report.ts`
- **State Updates**: Use proper Zustand patterns, never mutate state directly
- **Error Handling**: Follow existing error handling patterns from SalesReportForm

### Authentication and Role-Based Access
[Source: architecture/components.md#authentication-service and previous story insights]
**Role Validation Requirements**:
- Batch operations available only to managers with appropriate outlet permissions
- Outlet validation for each report in batch: managerId === user.id
- Bulk operations validate permissions before execution
- Session-based batch data isolation per manager

### API Integration Requirements
**Existing Server Actions Usage**:
- `getUserOutletsAction()` for fetching manager's outlets in batch context
- `submitSalesReportAction()` extended for batch processing with transaction support
- Maintain existing outlet permission validation for all batch operations
- Document upload integration for batch report attachments

### Project Structure Notes
Batch components integrate with existing Next.js App Router structure. Components extend established SalesReportForm and OutletContextSwitcher patterns. State management follows existing Zustand patterns with session persistence. Testing follows established Jest + Testing Library patterns from previous stories.

## Testing
[Source: architecture/testing-strategy.md]
- **Frontend Unit Testing**: Jest + Testing Library v29+/13+ for batch component and logic testing
- **Test Locations**:
  - `src/__tests__/components/BatchDatePicker.test.tsx` - Multi-date selection and validation logic
  - `src/__tests__/components/BatchSalesReportForm.test.tsx` - Bulk data entry and validation testing
  - `src/__tests__/components/BulkActionToolbar.test.tsx` - Bulk operation testing and confirmation flows
- **Testing Scenarios**:
  - Multi-date and date range selection with validation
  - Bulk form data entry with real-time validation and calculations
  - Bulk action operations with permission validation
  - Integration with multi-outlet selection and context switching
  - Session persistence for batch operation state
  - Error handling for batch operation failures
  - Performance testing for large batch operations
  - Integration with existing outlet permission validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-10 | 1.0 | Initial story creation for batch upload and bulk operations | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent (James)

### Debug Log References
No critical issues encountered during development. Implementation proceeded smoothly with all components integrating properly.

### Completion Notes
âœ… **All Requirements Completed Successfully**

**Implemented Components:**
- BatchDatePicker: Multi-date and date range selection with validation and session persistence
- BatchSalesReportForm: Spreadsheet-like bulk data entry with real-time calculations and validation
- BulkActionToolbar: Comprehensive bulk operations with confirmation dialogs and progress tracking
- batchOperationStore: Zustand store with session persistence for batch state management

**Key Features Delivered:**
- Multi-date and date range selection with business rule validation
- Bulk data entry interface supporting multiple outlets and dates simultaneously
- Batch validation preventing duplicate entries and enforcing business rules
- Session persistence maintaining form state across page refreshes
- Integration with existing multi-outlet selection and permission systems
- Comprehensive bulk actions (submit, delete, approve, reject) with confirmation flows
- Real-time total calculations and validation feedback
- Responsive design following established UI patterns

**Testing Coverage:**
- Unit tests for all major components (BatchDatePicker, BatchSalesReportForm, BulkActionToolbar)
- Integration tests for multi-outlet selection and permission validation
- Session persistence and state management testing
- Form validation and error handling coverage

All acceptance criteria satisfied with robust, production-ready implementation following coding standards.

### File List
**New Components Created:**
- `src/components/business/BatchDatePicker.tsx` - Multi-date/range picker with validation
- `src/components/forms/BatchSalesReportForm.tsx` - Bulk report entry form
- `src/components/ui/BulkActionToolbar.tsx` - Reusable bulk action component
- `src/stores/batchOperationStore.ts` - Batch operation state management

**Type Extensions:**
- `types/sales-report.ts` - Extended with batch processing interfaces

**Test Files Created:**
- `src/__tests__/components/BatchDatePicker.test.tsx` - Unit tests for date picker
- `src/__tests__/components/BatchSalesReportForm.test.tsx` - Form component tests  
- `src/__tests__/components/BulkActionToolbar.test.tsx` - Bulk action tests
- `src/__tests__/integration/BatchOperationsIntegration.test.tsx` - Integration tests

## QA Results

*This section will be populated by the QA agent during review*