# Story 3.9: Cross-Team Notifications and Alerts

## Status
Draft

## Story
**As a team member,**
**I want notifications when the other team takes actions on shared customers,**
**so that I stay informed of coordination activities.**

## Acceptance Criteria
1. Real-time notifications when other team updates customer records
2. Action-specific alerts (payment received, follow-up completed, handoff requested)

## Tasks / Subtasks
- [ ] Implement real-time cross-team notification system (AC: 1)
  - [ ] Build CrossTeamNotificationService extending existing Notification Service
  - [ ] Create notification triggers for customer record updates across teams
  - [ ] Implement role-based notification routing (Sales â†” Accounts coordination)
  - [ ] Add notification batching to prevent alert flooding during bulk operations
  - [ ] Build notification preference management for cross-team alerts
- [ ] Create action-specific alert system with detailed context (AC: 2)
  - [ ] Implement payment received notifications with amount and customer details
  - [ ] Create follow-up completion alerts with summary and next action recommendations
  - [ ] Build handoff request notifications with customer context and urgency indicators
  - [ ] Add receivable status change alerts (overdue, disputed, resolved)
  - [ ] Create customer assignment change notifications with responsibility context
- [ ] Build notification delivery and management interface (AC: 1, 2)
  - [ ] Extend notification center with cross-team notification categories
  - [ ] Create notification filtering by team, action type, and priority level
  - [ ] Implement notification read/unread status tracking for team coordination
  - [ ] Add notification archive functionality for completed coordination items
  - [ ] Build team notification dashboard showing coordination activity

## Dev Notes

### Notification Service Extension
[Source: architecture/components.md#notification-service]
Building on existing Notification Service:
- `sendNotification(userId, message, type)` - Direct user notification with persistence
- `broadcastToRole(role, message)` - Role-based team notifications
- `getNotificationStream(userId)` - SSE connection for real-time updates
- Dependencies: Authentication Service (user/role targeting), Vercel KV (notification queue), PostgreSQL (notification persistence)

### Cross-Team Notification Types
```typescript
enum CrossTeamNotificationType {
  PAYMENT_RECEIVED = 'PAYMENT_RECEIVED',
  FOLLOW_UP_COMPLETED = 'FOLLOW_UP_COMPLETED',
  HANDOFF_REQUESTED = 'HANDOFF_REQUESTED',
  HANDOFF_APPROVED = 'HANDOFF_APPROVED',
  RECEIVABLE_STATUS_CHANGED = 'RECEIVABLE_STATUS_CHANGED',
  CUSTOMER_ASSIGNMENT_CHANGED = 'CUSTOMER_ASSIGNMENT_CHANGED',
  OVERDUE_ESCALATION = 'OVERDUE_ESCALATION',
  INTERNAL_NOTE_TAGGED = 'INTERNAL_NOTE_TAGGED'
}

interface CrossTeamNotification {
  id: string;
  type: CrossTeamNotificationType;
  customerId: string;
  relatedEntityId: string; // receivableId, followUpId, handoffId, etc.
  fromUserId: string;
  fromUserRole: UserRole;
  targetRole: UserRole; // Which team should be notified
  title: string;
  message: string;
  actionData: NotificationActionData;
  priority: NotificationPriority;
  isRead: boolean;
  createdAt: Date;

  // Relationships
  customer: Customer;
  fromUser: User;
}

interface NotificationActionData {
  customerName: string;
  amount?: Decimal;
  invoiceNumber?: string;
  followUpType?: string;
  previousStatus?: string;
  newStatus?: string;
  handoffReason?: string;
  notePreview?: string;
}

enum NotificationPriority {
  LOW = 'LOW',
  MEDIUM = 'MEDIUM',
  HIGH = 'HIGH',
  URGENT = 'URGENT'
}
```

### Database Schema for Cross-Team Notifications
```sql
-- Cross-team notification types
CREATE TYPE cross_team_notification_type AS ENUM (
  'PAYMENT_RECEIVED',
  'FOLLOW_UP_COMPLETED',
  'HANDOFF_REQUESTED',
  'HANDOFF_APPROVED',
  'RECEIVABLE_STATUS_CHANGED',
  'CUSTOMER_ASSIGNMENT_CHANGED',
  'OVERDUE_ESCALATION',
  'INTERNAL_NOTE_TAGGED'
);

CREATE TYPE notification_priority AS ENUM ('LOW', 'MEDIUM', 'HIGH', 'URGENT');

-- Cross-team notifications table
CREATE TABLE cross_team_notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    type cross_team_notification_type NOT NULL,
    customer_id UUID NOT NULL REFERENCES customers(id),
    related_entity_id UUID NOT NULL,
    from_user_id UUID NOT NULL REFERENCES users(id),
    from_user_role user_role NOT NULL,
    target_role user_role NOT NULL,
    title VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    action_data JSONB NOT NULL,
    priority notification_priority DEFAULT 'MEDIUM',
    is_read BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Notification read status per user
CREATE TABLE notification_read_status (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    notification_id UUID NOT NULL REFERENCES cross_team_notifications(id),
    user_id UUID NOT NULL REFERENCES users(id),
    read_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    UNIQUE(notification_id, user_id)
);

CREATE INDEX idx_cross_team_notifications_target ON cross_team_notifications(target_role, created_at DESC);
CREATE INDEX idx_cross_team_notifications_customer ON cross_team_notifications(customer_id, created_at DESC);
CREATE INDEX idx_notification_read_status_user ON notification_read_status(user_id, read_at DESC);
```

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Cache: Vercel KV (Redis) Latest for notification queue and real-time delivery
- Backend Framework: Next.js API Routes 14+ with Server-Sent Events for real-time notifications
- State Management: Zustand 4.4+ for notification state management

### Notification Triggers Implementation
Integration points for automatic notification generation:
1. **Payment Recording**: Trigger PAYMENT_RECEIVED when receivable payment is updated
2. **Follow-up Completion**: Trigger FOLLOW_UP_COMPLETED when follow-up status changes
3. **Handoff Management**: Trigger HANDOFF_REQUESTED/APPROVED during team coordination
4. **Status Changes**: Trigger RECEIVABLE_STATUS_CHANGED for important status updates
5. **Assignment Changes**: Trigger CUSTOMER_ASSIGNMENT_CHANGED during responsibility handoffs

### Coding Standards
[Source: architecture/coding-standards.md]
- Components: Use PascalCase naming (CrossTeamNotificationCenter.tsx, NotificationAlert.tsx)
- API Routes: Use kebab-case for notification endpoints (/api/notifications/cross-team)
- State Updates: Use proper Zustand patterns for notification state management

### File Locations
- Notification center: `src/components/business/notifications/CrossTeamNotificationCenter.tsx`
- Notification alerts: `src/components/business/notifications/NotificationAlert.tsx`
- Notification service: `src/services/crossTeamNotificationService.ts`
- Notification API: `app/api/notifications/cross-team/route.ts`
- SSE endpoint: `app/api/notifications/stream/route.ts`
- Notification hooks: `src/hooks/useNotifications.ts`
- Types: `types/crossTeamNotification.ts`

### Testing Requirements
[Source: architecture/testing-strategy.md]
- Frontend Testing: Jest + Testing Library for notification display and interaction
- Backend Testing: Jest + Supertest for notification generation and delivery
- Real-time testing for Server-Sent Events and notification streaming

## Testing
[Source: architecture/testing-strategy.md]
- Test file location: `src/__tests__/components/business/notifications/CrossTeamNotificationCenter.test.tsx`
- Test standards: Jest + Testing Library for React components, Jest + Supertest for API testing
- Testing frameworks: Jest 29+ and Testing Library 13+ with TypeScript support
- Specific requirements: Test real-time notification delivery, action-specific alert generation, cross-team coordination workflow, notification filtering, and read status management

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation for cross-team notifications and alerts | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes
*This section will be populated by the development agent during implementation*

### File List
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*