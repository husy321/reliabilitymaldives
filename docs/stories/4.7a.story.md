# Story 4.7a: Real-time Workflow Notifications

## Status
Pending

## Story
**As a manager or accountant,**
**I want real-time notifications for workflow changes,**
**so that I'm immediately informed of status updates.**

## Acceptance Criteria
1. Real-time notifications for report submissions, approvals, and rejections

## Tasks / Subtasks
- [ ] Create real-time notification system for workflow events (AC: 1)
  - [ ] Build WorkflowNotificationProvider component with SSE connection management
  - [ ] Implement real-time event listeners for report submissions, approvals, and rejections
  - [ ] Add notification display system with toast notifications and persistent notification panel
  - [ ] Create notification persistence layer with read/unread status tracking
  - [ ] Integrate with existing authentication system for user-specific notification targeting
- [ ] Implement report submission notifications (AC: 1)
  - [ ] Build submission notification logic triggering on new report creation
  - [ ] Create notification templates for report submission events with outlet and date details
  - [ ] Implement accountant targeting for submission notifications based on outlet assignments
  - [ ] Add notification queuing system for offline users with delivery confirmation
  - [ ] Create notification aggregation for multiple submissions to prevent notification spam
- [ ] Build approval workflow notification system (AC: 1)
  - [ ] Implement approval notification triggers for successful report approvals
  - [ ] Create approval notification templates with approver details and timestamp information
  - [ ] Add manager targeting for approval notifications based on report ownership
  - [ ] Implement notification delivery confirmation and retry mechanisms
  - [ ] Create approval notification aggregation for batch approval operations
- [ ] Create rejection workflow notification system (AC: 1)
  - [ ] Build rejection notification triggers with detailed feedback and correction requirements
  - [ ] Create rejection notification templates with category-specific messaging and action links
  - [ ] Implement manager targeting for rejection notifications with correction guidance
  - [ ] Add escalation notification logic for repeated rejections and overdue corrections
  - [ ] Create rejection notification persistence for correction workflow integration
- [ ] Implement Server-Sent Events infrastructure (AC: 1)
  - [ ] Build SSE endpoint for real-time notification delivery with user authentication
  - [ ] Create notification event streaming with proper connection management and reconnection logic
  - [ ] Implement event filtering and user-specific notification targeting
  - [ ] Add connection health monitoring and automatic reconnection for network interruptions
  - [ ] Create notification event aggregation and rate limiting to prevent overwhelming users
- [ ] Build notification management interface (AC: 1)
  - [ ] Create NotificationCenter component with notification list and management controls
  - [ ] Implement mark as read/unread functionality with bulk operations
  - [ ] Add notification filtering and sorting by type, date, and read status
  - [ ] Create notification settings interface for user preferences and delivery options
  - [ ] Implement notification archiving and retention policies for storage management
- [ ] Create server actions for notification operations (AC: 1)
  - [ ] Build sendWorkflowNotification server action for workflow event processing
  - [ ] Build getNotifications server action for notification retrieval with pagination
  - [ ] Build markNotificationRead server action for status updates
  - [ ] Build updateNotificationPreferences server action for user settings management
  - [ ] Implement notification cleanup operations for expired and archived notifications
- [ ] Integrate with Sales Report Workflow Service (AC: 1)
  - [ ] Connect notification system with existing workflow state changes and event triggers
  - [ ] Implement workflow event hooks for report submission, approval, and rejection notifications
  - [ ] Add notification context data extraction from workflow events for detailed messaging
  - [ ] Create workflow-specific notification templates with actionable links and context
  - [ ] Integrate notification delivery with workflow timing and business rules
- [ ] Create comprehensive testing for real-time notification system (Testing requirement)
  - [ ] Create unit tests for WorkflowNotificationProvider and notification component interactions
  - [ ] Test SSE connection management, reconnection logic, and event filtering
  - [ ] Test notification template generation and user targeting logic
  - [ ] Test server actions for notification operations and persistence management
  - [ ] Test integration with workflow service and notification delivery confirmation
  - [ ] Test role-based notification targeting and permission validation
  - [ ] Test notification aggregation and rate limiting functionality

## Dev Notes

### Previous Story Dependencies
From Story 4.5 Approval and Rejection Workflow:
- ApprovalActions component provides approval/rejection events that trigger real-time notifications
- Approval audit trail system provides event data for notification content and context
- Notification service integration established provides foundation for enhanced real-time capabilities
- Role-based approval permissions support notification targeting based on user roles and responsibilities
- Database schema for approval tracking supports notification event data extraction and context

From Story 4.6 Correction Cycle Management:
- Rejection notification system provides foundation for real-time rejection alert enhancement
- Correction workflow events (resubmission, correction approval) require real-time notification support
- Correction history tracking provides context for escalation notifications and repeated rejection alerts
- Manager dashboard integration establishes patterns for prominent real-time notification display
- Correction timing and escalation rules provide business logic for notification prioritization

From Story 4.2 Manager Sales Report Upload Interface:
- Sales report submission events trigger real-time notifications to accountants
- Upload completion confirmation provides event timing for immediate notification delivery
- Outlet-specific context supports targeted notifications based on accountant outlet assignments
- Document attachment events provide additional notification context for review prioritization
- Form validation events support notification content generation with submission details

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Framework: Next.js v14+ App Router for SSE endpoint implementation and Server Components
- UI Component Library: shadcn/ui v4 for notification toast components and notification center interface
- State Management: Zustand v4.4+ for notification state management and real-time event handling
- Database: PostgreSQL v15+ for notification persistence and user preference storage
- Cache: Vercel KV (Redis) for notification queuing and delivery confirmation tracking
- Backend Framework: Next.js API Routes for SSE endpoints and notification processing
- Authentication: NextAuth.js v4+ for user-specific notification targeting and permission validation
- Frontend Testing: Jest + Testing Library v29+/13+ for notification component and SSE connection testing

### Component Architecture Requirements
[Source: architecture/components.md and frontend-architecture.md]
**Notification Component Location**: `src/components/notifications/` directory for real-time notification components
**Integration Pattern**: Context provider pattern for global notification state with component-level consumers
**State Management**: React Query for server state management, Zustand for real-time notification state and SSE connections
**Event Handling**: Custom hooks for SSE connection management and notification event processing
**Toast System**: shadcn/ui Sonner for transient notifications, custom NotificationCenter for persistent management

### Notification Service Integration
[Source: architecture/components.md#notification-service]
**Enhanced Service Interfaces Required**:
- `sendRealtimeNotification(userId, event, data)` - Real-time notification delivery with SSE streaming
- `subscribeToWorkflowEvents(userId, eventTypes)` - User-specific event subscription management
- `getNotificationHistory(userId, filters)` - Historical notification retrieval with filtering and pagination
- `updateNotificationPreferences(userId, preferences)` - User notification settings management
- `aggregateNotifications(userId, timeframe)` - Notification aggregation to prevent spam and improve UX
**Dependencies**: Sales Report Workflow Service (event triggers), Authentication Service (user targeting), Vercel KV (message queue)
**Technology Stack**: Server-Sent Events via Next.js API routes, React hooks for frontend integration, Vercel KV for queuing

### Sales Report Workflow Service Integration
[Source: architecture/components.md#sales-report-workflow-service]
**Enhanced Service Interfaces for Real-time Events**:
- `onReportSubmitted(reportId, metadata)` - Event hook for submission notifications with context data
- `onReportApproved(reportId, approver, comments)` - Event hook for approval notifications with approver details
- `onReportRejected(reportId, rejector, feedback)` - Event hook for rejection notifications with correction guidance
- `onCorrectionSubmitted(reportId, corrector, changes)` - Event hook for correction resubmission notifications
**Event Data Requirements**: User targeting data, notification content context, actionable links for workflow continuation
**Real-time Requirements**: Immediate event processing with millisecond-level delivery for critical workflow events

### Database Schema Requirements
**Real-time Notification Tables**:
```sql
-- Create enhanced notifications table for real-time workflow events
CREATE TABLE workflow_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) NOT NULL,
  event_type VARCHAR(50) NOT NULL, -- 'SUBMISSION', 'APPROVAL', 'REJECTION', 'CORRECTION_SUBMITTED'
  event_source VARCHAR(50) NOT NULL, -- 'SALES_REPORT_WORKFLOW'
  source_id UUID NOT NULL, -- sales_report_id or other source entity
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  action_url TEXT,
  priority VARCHAR(20) DEFAULT 'MEDIUM', -- 'HIGH', 'MEDIUM', 'LOW'
  is_read BOOLEAN DEFAULT FALSE,
  is_delivered BOOLEAN DEFAULT FALSE,
  delivered_at TIMESTAMPTZ,
  metadata JSONB, -- Additional context data for notification
  created_at TIMESTAMPTZ DEFAULT now(),
  expires_at TIMESTAMPTZ DEFAULT (now() + interval '30 days')
);

-- Create notification preferences table
CREATE TABLE notification_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) NOT NULL UNIQUE,
  email_notifications BOOLEAN DEFAULT TRUE,
  push_notifications BOOLEAN DEFAULT TRUE,
  realtime_notifications BOOLEAN DEFAULT TRUE,
  submission_alerts BOOLEAN DEFAULT TRUE,
  approval_alerts BOOLEAN DEFAULT TRUE,
  rejection_alerts BOOLEAN DEFAULT TRUE,
  correction_alerts BOOLEAN DEFAULT TRUE,
  aggregation_window INTEGER DEFAULT 300, -- Seconds for notification aggregation
  quiet_hours_start TIME,
  quiet_hours_end TIME,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Create notification delivery log for tracking and debugging
CREATE TABLE notification_delivery_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  notification_id UUID REFERENCES workflow_notifications(id) NOT NULL,
  delivery_method VARCHAR(20) NOT NULL, -- 'SSE', 'EMAIL', 'PUSH'
  delivery_status VARCHAR(20) NOT NULL, -- 'SENT', 'DELIVERED', 'FAILED', 'RETRY'
  delivery_attempt INTEGER DEFAULT 1,
  error_message TEXT,
  delivered_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Create notification aggregation rules table
CREATE TABLE notification_aggregation_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type VARCHAR(50) NOT NULL,
  aggregation_window INTEGER NOT NULL, -- Seconds
  max_notifications INTEGER DEFAULT 10,
  template TEXT NOT NULL, -- Aggregated notification template
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_workflow_notifications_user ON workflow_notifications(user_id);
CREATE INDEX idx_workflow_notifications_type ON workflow_notifications(event_type);
CREATE INDEX idx_workflow_notifications_source ON workflow_notifications(source_id);
CREATE INDEX idx_workflow_notifications_read ON workflow_notifications(is_read);
CREATE INDEX idx_workflow_notifications_delivered ON workflow_notifications(is_delivered);
CREATE INDEX idx_workflow_notifications_created ON workflow_notifications(created_at);
CREATE INDEX idx_notification_preferences_user ON notification_preferences(user_id);
CREATE INDEX idx_notification_delivery_log_notification ON notification_delivery_log(notification_id);
```

### Data Model Extensions
[Source: Previous stories and notification architecture]
**Real-time Notification Interface Definitions**:
```typescript
interface WorkflowNotification {
  id: string;
  userId: string;
  eventType: WorkflowEventType;
  eventSource: 'SALES_REPORT_WORKFLOW' | 'RECEIVABLES_WORKFLOW' | 'HR_ATTENDANCE';
  sourceId: string; // Reference to source entity (sales_report_id, etc.)
  title: string;
  message: string;
  actionUrl?: string; // Link to take action on the notification
  priority: NotificationPriority;
  isRead: boolean;
  isDelivered: boolean;
  deliveredAt?: Date;
  metadata?: NotificationMetadata;
  createdAt: Date;
  expiresAt: Date;
}

enum WorkflowEventType {
  SUBMISSION = 'SUBMISSION',
  APPROVAL = 'APPROVAL',
  REJECTION = 'REJECTION',
  CORRECTION_SUBMITTED = 'CORRECTION_SUBMITTED',
  CORRECTION_APPROVED = 'CORRECTION_APPROVED',
  ESCALATION = 'ESCALATION'
}

enum NotificationPriority {
  HIGH = 'HIGH',     // Rejections, escalations
  MEDIUM = 'MEDIUM', // Submissions, approvals
  LOW = 'LOW'        // System notifications, reminders
}

interface NotificationMetadata {
  outletName?: string;
  reportDate?: string;
  approverName?: string;
  rejectionCategory?: string;
  correctionDeadline?: Date;
  attemptNumber?: number;
  batchSize?: number;
  [key: string]: any;
}

interface NotificationPreferences {
  id: string;
  userId: string;
  emailNotifications: boolean;
  pushNotifications: boolean;
  realtimeNotifications: boolean;
  submissionAlerts: boolean;
  approvalAlerts: boolean;
  rejectionAlerts: boolean;
  correctionAlerts: boolean;
  aggregationWindow: number; // Seconds
  quietHoursStart?: string;
  quietHoursEnd?: string;
  createdAt: Date;
  updatedAt: Date;
}

interface NotificationDeliveryLog {
  id: string;
  notificationId: string;
  deliveryMethod: 'SSE' | 'EMAIL' | 'PUSH';
  deliveryStatus: 'SENT' | 'DELIVERED' | 'FAILED' | 'RETRY';
  deliveryAttempt: number;
  errorMessage?: string;
  deliveredAt?: Date;
  createdAt: Date;
}

interface RealtimeNotificationEvent {
  type: WorkflowEventType;
  notification: WorkflowNotification;
  timestamp: Date;
  connectionId: string;
}

interface NotificationAggregation {
  eventType: WorkflowEventType;
  count: number;
  latestNotification: WorkflowNotification;
  timeframe: string;
  aggregatedMessage: string;
}
```

### Real-time Notification Component Design
**WorkflowNotificationProvider Component Structure**:
```typescript
interface WorkflowNotificationProviderProps {
  children: React.ReactNode;
  userId: string;
  preferences: NotificationPreferences;
}

interface NotificationContextValue {
  notifications: WorkflowNotification[];
  unreadCount: number;
  isConnected: boolean;
  markAsRead: (notificationId: string) => Promise<void>;
  markAllAsRead: () => Promise<void>;
  deleteNotification: (notificationId: string) => Promise<void>;
  updatePreferences: (preferences: Partial<NotificationPreferences>) => Promise<void>;
}
```

**NotificationCenter Component Structure**:
```typescript
interface NotificationCenterProps {
  isOpen: boolean;
  onClose: () => void;
  maxDisplayNotifications?: number;
  showFilters?: boolean;
}

interface NotificationItemProps {
  notification: WorkflowNotification;
  onRead: (notificationId: string) => void;
  onDelete: (notificationId: string) => void;
  onAction?: (actionUrl: string) => void;
}
```

**NotificationToast Component Structure**:
```typescript
interface NotificationToastProps {
  notification: WorkflowNotification;
  onDismiss: () => void;
  autoHideDuration?: number;
  showActions?: boolean;
}
```

### Server-Sent Events Implementation
**SSE Endpoint Design**:
```typescript
// app/api/notifications/stream/route.ts
interface SSEConnection {
  userId: string;
  response: Response;
  controller: ReadableStreamDefaultController;
  connectionId: string;
  connectedAt: Date;
  lastHeartbeat: Date;
  eventFilters: WorkflowEventType[];
}

interface SSEMessage {
  id: string;
  event: string;
  data: any;
  retry?: number;
}
```

**Connection Management**:
- Automatic reconnection with exponential backoff for network interruptions
- Connection health monitoring with periodic heartbeat messages
- User authentication validation for each SSE connection
- Event filtering based on user permissions and preferences
- Connection cleanup and resource management for terminated sessions

### Notification Event Triggers
**Workflow Event Integration Points**:
```typescript
// Integration with Sales Report Workflow Service
class WorkflowNotificationService {
  async onReportSubmitted(reportId: string, submitterId: string, outletId: string): Promise<void> {
    const accountants = await this.getAccountantsForOutlet(outletId);
    const notification = this.createSubmissionNotification(reportId, submitterId, outletId);

    for (const accountant of accountants) {
      await this.sendRealtimeNotification(accountant.id, notification);
    }
  }

  async onReportApproved(reportId: string, approverId: string, managerId: string): Promise<void> {
    const notification = this.createApprovalNotification(reportId, approverId);
    await this.sendRealtimeNotification(managerId, notification);
  }

  async onReportRejected(reportId: string, rejectorId: string, managerId: string, feedback: RejectionData): Promise<void> {
    const notification = this.createRejectionNotification(reportId, rejectorId, feedback);
    await this.sendRealtimeNotification(managerId, notification);
  }
}
```

### Notification Templates and Content
**Dynamic Notification Templates**:
```typescript
interface NotificationTemplate {
  eventType: WorkflowEventType;
  priority: NotificationPriority;
  titleTemplate: string;
  messageTemplate: string;
  actionUrlTemplate?: string;
  aggregationTemplate?: string;
}

const NOTIFICATION_TEMPLATES: Record<WorkflowEventType, NotificationTemplate> = {
  SUBMISSION: {
    eventType: WorkflowEventType.SUBMISSION,
    priority: NotificationPriority.MEDIUM,
    titleTemplate: "New Report: {{outletName}} - {{reportDate}}",
    messageTemplate: "{{managerName}} submitted a sales report for {{outletName}} on {{reportDate}}. Ready for review.",
    actionUrlTemplate: "/reports/review/{{reportId}}",
    aggregationTemplate: "{{count}} new reports submitted for review"
  },
  APPROVAL: {
    eventType: WorkflowEventType.APPROVAL,
    priority: NotificationPriority.MEDIUM,
    titleTemplate: "Report Approved: {{outletName}} - {{reportDate}}",
    messageTemplate: "Your sales report for {{outletName}} on {{reportDate}} has been approved by {{approverName}}.",
    actionUrlTemplate: "/reports/{{reportId}}",
    aggregationTemplate: "{{count}} reports approved"
  },
  REJECTION: {
    eventType: WorkflowEventType.REJECTION,
    priority: NotificationPriority.HIGH,
    titleTemplate: "Report Rejected: {{outletName}} - {{reportDate}}",
    messageTemplate: "Your sales report requires correction: {{rejectionCategory}}. {{correctionInstructions}}",
    actionUrlTemplate: "/reports/correct/{{reportId}}",
    aggregationTemplate: "{{count}} reports require correction"
  }
};
```

### Notification Aggregation and Rate Limiting
**Aggregation Rules**:
- Aggregate similar notifications within 5-minute windows to prevent spam
- Group notifications by event type and source entity
- Combine multiple submissions from same outlet into single aggregated notification
- Merge batch approval notifications into summary notifications
- Apply user-specific aggregation preferences and quiet hours

**Rate Limiting Implementation**:
- Maximum 10 notifications per user per 5-minute window
- Priority-based rate limiting (HIGH priority notifications bypass limits)
- User preference-based delivery timing and frequency controls
- Escalation bypass for critical notifications requiring immediate attention

### User Interface Design Requirements
**Notification Display System**:
- Real-time toast notifications for immediate events with auto-hide timers
- Persistent notification center accessible from global header with unread count badge
- Notification list with filtering by type, priority, and read status
- Expandable notification details with full context and actionable buttons
- Mobile-responsive notification interface with swipe actions and touch optimization

**Notification Management Interface**:
- Mark as read/unread functionality with bulk operations
- Notification archiving and deletion with undo functionality
- Notification search and filtering with date range and keyword support
- Notification preferences panel with granular control over delivery and timing
- Export functionality for notification history and audit trail

**Visual Design Elements**:
- Priority-based color coding (red for high, blue for medium, gray for low)
- Event type icons (checkmark for approvals, warning for rejections, document for submissions)
- Real-time connection status indicator with reconnection progress
- Loading states for notification actions and preference updates
- Empty states for no notifications with helpful guidance and quick actions

### File Locations
[Source: architecture/unified-project-structure.md]
- Notification Components: `src/components/notifications/` directory (new)
  - `WorkflowNotificationProvider.tsx` - Context provider for global notification state
  - `NotificationCenter.tsx` - Main notification management interface
  - `NotificationToast.tsx` - Transient notification display component
  - `NotificationItem.tsx` - Individual notification display component
  - `NotificationPreferences.tsx` - User notification settings interface
  - `SSEConnection.tsx` - Server-Sent Events connection management
- SSE API Endpoint: `app/api/notifications/stream/route.ts` (new file)
- Server Actions: `app/actions/notification-actions.ts` (new file)
- Type Definitions: `types/notification.ts` (new file), extend existing workflow types
- Custom Hooks: `src/hooks/useNotifications.ts`, `src/hooks/useSSEConnection.ts` (new files)
- Test Files: `src/__tests__/components/notifications/` directory (new)
- Database Migrations: `prisma/migrations/add-realtime-notifications.sql` (new)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Component Naming**: Use PascalCase for notification components (`WorkflowNotificationProvider.tsx`)
- **API Routes**: Use kebab-case for notification routes (`/api/notifications/stream`)
- **Type Sharing**: Define notification types in `types/notification.ts` for consistent interfaces
- **Error Handling**: All notification operations must use standard error handling patterns
- **State Updates**: Use proper state management patterns with immutable updates for real-time state
- **Event Handling**: Implement proper cleanup and memory management for SSE connections

### Authentication and Role-Based Access
[Source: architecture/components.md#authentication-service]
**Required Role Validation**:
- Notification access restricted to authenticated users with valid session tokens
- Role-based notification targeting (managers receive different notifications than accountants)
- User-specific notification filtering based on outlet assignments and permissions
- SSE connection authentication with token validation and session management
- Audit trail tracking for all notification delivery and read operations

### Performance Considerations
**Optimization Requirements**:
- Efficient SSE connection management with connection pooling and resource cleanup
- Notification aggregation to prevent overwhelming users and reduce database load
- Lazy loading for notification history with pagination and virtual scrolling
- Debounced notification status updates to prevent excessive database writes
- Caching of user preferences and notification templates for fast delivery

**Scalability Considerations**:
- Horizontal scaling support for SSE connections across multiple server instances
- Message queue integration for reliable notification delivery during server restarts
- Database connection pooling for high-volume notification operations
- CDN integration for notification assets and static content delivery

### Integration with Existing Workflow
**Dashboard Integration**:
- Real-time notification badges in manager and accountant dashboards
- Prominent display of high-priority notifications requiring immediate action
- Integration with existing workflow status displays and pending queues
- Notification-driven dashboard updates for real-time workflow state changes

**Mobile and Cross-Device Support**:
- Progressive Web App notification support for mobile devices
- Cross-device notification synchronization with read status persistence
- Mobile-optimized notification interface with touch-friendly interactions
- Background notification delivery with service worker integration

### Project Structure Notes
Real-time notification system builds on established notification service patterns while adding comprehensive SSE infrastructure for immediate delivery. Component architecture follows provider pattern for global state management with context-based consumption. Server actions leverage existing patterns for database operations and user authentication. Integration with workflow services maintains event-driven architecture with proper separation of concerns. Performance optimizations ensure scalability for high-volume notification scenarios.

## Testing
[Source: architecture/testing-strategy.md]
- **Frontend Unit Testing**: Jest + Testing Library v29+/13+ for notification component and SSE connection testing
- **Integration Testing**: Jest + Supertest for notification server actions and SSE endpoint validation
- **E2E Testing**: Playwright for complete real-time notification workflow validation across user roles
- **Test Locations**:
  - `src/__tests__/components/notifications/WorkflowNotificationProvider.test.tsx` - Provider state and SSE connection testing
  - `src/__tests__/components/notifications/NotificationCenter.test.tsx` - Notification management interface testing
  - `src/__tests__/components/notifications/NotificationToast.test.tsx` - Toast notification display and interaction testing
  - `src/__tests__/hooks/useNotifications.test.ts` - Custom hooks testing for notification state management
  - `src/__tests__/hooks/useSSEConnection.test.ts` - SSE connection hook testing with mock EventSource
  - `src/__tests__/actions/notification-actions.test.ts` - Server action testing for notification operations
  - `src/__tests__/api/notifications/stream.test.ts` - SSE endpoint testing with connection simulation
  - `tests/e2e/realtime-notifications.spec.ts` - End-to-end real-time notification delivery testing
- **Testing Scenarios**:
  - Real-time notification delivery with SSE connection establishment and event streaming
  - Notification aggregation and rate limiting functionality with time-based testing
  - User preference application and notification filtering based on settings
  - Connection recovery and reconnection logic with network interruption simulation
  - Cross-browser SSE compatibility and fallback mechanism testing
  - Notification persistence and read status synchronization across sessions
  - Role-based notification targeting and permission validation
  - Database transaction integrity for notification operations and delivery logging
  - Error handling for failed SSE connections and notification delivery failures
  - Performance testing for high-volume notification scenarios and connection limits

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation for real-time workflow notifications | Claude Code |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent

### Implementation Status
**PENDING** - Story ready for development

### Completion Notes
*This section will be populated during implementation*

### File List
*This section will be populated during implementation*

### Debug Log References
*This section will be populated during implementation*

## QA Results

*This section will be populated by the QA agent during review*