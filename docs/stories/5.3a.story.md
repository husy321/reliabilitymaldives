# Story 5.3a: Manual Attendance Data Fetch from ZKT

## Status  
Done

## Story
**As an Admin,**
**I want to manually fetch attendance data from ZKT machines,**
**so that I can retrieve records on demand.**

## Acceptance Criteria
1. Manual trigger for fetching attendance data from ZKT machines
2. Attendance record storage with timestamp and employee mapping

## Tasks / Subtasks
- [x] Create ZKT service integration layer for manual data fetch (AC: 1)
  - [x] Build ZKT service wrapper using established service patterns from backend architecture
  - [x] Implement connection management with error handling and retry logic
  - [x] Add data fetch functionality with date range parameters
  - [x] Create configuration management for ZKT machine IP addresses and authentication
  - [x] Integrate with existing error handling patterns following coding standards
- [x] Build attendance data model and storage system (AC: 2)
  - [x] Extend Prisma schema with AttendanceRecord model following data model patterns
  - [x] Create database migration for attendance_records table with proper indexing
  - [x] Implement employee mapping using existing Staff model relationship
  - [x] Add data validation using Zod schemas following established validation patterns
  - [x] Create unique constraints to prevent duplicate records with proper error handling
- [x] Develop Server Actions for manual data fetch operations (AC: 1, 2)
  - [x] Create fetchZKTAttendance Server Action with admin role validation
  - [x] Implement data processing pipeline with employee ID matching to Staff model
  - [x] Add comprehensive error handling for ZKT communication failures
  - [x] Build data validation and sanitization layer for incoming attendance records
  - [x] Create audit trail for manual fetch operations with user tracking
- [x] Build admin interface for manual attendance fetch (AC: 1)
  - [x] Create AttendanceFetch component using shadcn/ui following UI patterns
  - [x] Add date range selector for targeted data retrieval
  - [x] Implement manual trigger button with loading states and progress feedback
  - [x] Build results display showing fetched records count and success/error status
  - [x] Add employee mapping validation results display with error highlighting
- [x] Add comprehensive testing for ZKT integration system (Testing requirement)
  - [x] Create unit tests for ZKT service layer with mocked ZKT responses
  - [x] Test Server Actions with admin role validation and error scenarios
  - [x] Add component tests for AttendanceFetch interface and user interactions
  - [x] Test data validation and employee mapping scenarios with edge cases
  - [x] Create integration tests for complete manual fetch workflow end-to-end

## Dev Notes

### Previous Story Insights
Building on the Staff Database and Profile Management system from Story 5.2. Key insights:
- Staff model with employeeId field already established for ZKT employee mapping
- Admin role-based access control patterns established and working
- Database schema patterns and Prisma integration ready for attendance data model
- Authentication and authorization middleware ready for admin-only operations
- Error handling patterns established for database and service operations

### Tech Stack Requirements  
[Source: architecture/tech-stack.md]
- Frontend Language: TypeScript 5.0+ for type-safe ZKT integration interface development
- Frontend Framework: Next.js 14+ with App Router for attendance management pages and components
- UI Component Library: shadcn/ui v4 for professional attendance management interface components
- State Management: Zustand 4.4+ for attendance fetch form data and UI state management
- Backend Language: TypeScript 5.0+ for type-safe ZKT service integration development
- Backend Framework: Next.js API Routes 14+ for ZKT integration endpoints
- API Style: Server Actions for attendance fetch operations following established patterns
- Database: PostgreSQL 15+ for attendance data storage with relational integrity
- Frontend Testing: Jest + Testing Library 29+/13+ for component and unit testing
- Backend Testing: Jest + Supertest 29+/6+ for API and integration testing

### ZKT Machine API Integration
[Source: architecture/external-apis.md]
**ZKT Machine API Integration**:
- Purpose: Automated staff attendance data retrieval for payroll processing workflow
- Base URL(s): Local network machine IP addresses (typically 192.168.x.x range)
- Authentication: Machine-specific authentication (SDK dependent)
- Key Endpoints Used:
  - `GET /attendance/data` - Fetch attendance records by date range
  - `GET /employees` - Retrieve employee list and ID mapping
  - `POST /test-connection` - Verify machine connectivity
- Integration Notes: The PRD identifies this as a high technical risk area requiring early investigation. The ZKT SDK integration will be wrapped in a service layer to abstract machine-specific details and provide fallback manual entry capabilities.

### Data Model Requirements
[Source: architecture/data-models.md]
**AttendanceRecord Data Model (New)**:
- Integration with existing Staff model for employee identification
- ZKT machine data mapping and validation requirements
- Support for manual fetch operations with admin audit tracking
- Relationship with Staff model for employee mapping validation

**AttendanceRecord Table Schema Requirements**:
- id: string (UUID) - Unique attendance record identifier for database relationships
- staffId: string - Foreign key to Staff table for employee identification
- employeeId: string - ZKT machine employee ID for cross-reference validation
- date: Date - Attendance date for daily record organization
- clockInTime: Date - Employee punch-in timestamp from ZKT machine
- clockOutTime: Date - Employee punch-out timestamp from ZKT machine
- totalHours: Decimal - Calculated work hours for payroll processing
- zkTransactionId: string - ZKT machine transaction ID for duplicate prevention
- fetchedAt: Date - Manual fetch timestamp for audit trail
- fetchedById: string - Foreign key to User table for admin accountability
- createdAt: Date - Record creation timestamp for audit trails
- updatedAt: Date - Last modification timestamp for change tracking

### Database Schema Requirements
[Source: architecture/database-schema.md]
**AttendanceRecord Table Creation**:
- UUID primary key with PostgreSQL uuid_generate_v4() function
- Unique constraint on (staffId, date, zkTransactionId) for duplicate prevention
- Foreign key relationship to staff table for employee identification
- Foreign key relationship to users table for fetch accountability
- Database indexes for performance: attendance queries (staffId, date), date range filtering
- Check constraints for data validation: clockInTime < clockOutTime, totalHours calculation

### Backend Architecture Requirements
[Source: architecture/backend-architecture.md]
**Service Organization**: 
- Create dedicated ZKT service following established service patterns
- Integrate with existing authentication middleware for admin role-based access
- Server Actions for attendance fetch operations following established API patterns
- Comprehensive error handling using standard error handler with structured logging

### HR Attendance Service Requirements
[Source: architecture/components.md#hr-attendance-service]
**ZKT Integration Service**:
- `fetchZKTData(dateRange)` - Manual and scheduled ZKT data retrieval
- `processAttendanceData(rawData)` - Data validation and employee matching
- Dependencies: ZKT Machine SDK, Authentication Service (admin permissions), PostgreSQL (attendance storage)
- Technology Stack: ZKT SDK integration via Next.js API routes, cron jobs for daily sync, Prisma for data persistence

### Frontend Architecture Requirements
[Source: architecture/frontend-architecture.md]
**Component Organization**:
- Attendance components in `src/components/business/attendance/` following component architecture
- Form components using Server Actions following established form patterns
- Integration with global state management using Zustand for attendance UI state
- Route protection using NextAuth.js middleware for admin-only access

### File Locations
[Source: architecture/unified-project-structure.md]
- AttendanceRecord Data Model: `prisma/schema.prisma` (extend existing schema)
- Database Migration: `prisma/migrations/` (new migration file)
- ZKT Service: `src/services/zktService.ts` (new file)
- Attendance Repository: `src/repositories/attendanceRepository.ts` (new file)
- Server Actions: `src/actions/attendanceActions.ts` (new file)
- Attendance Types: `types/attendance.ts` (new file)
- UI Components: `src/components/business/attendance/` (new directory)
  - `AttendanceFetch.tsx` - Manual fetch interface component
  - `AttendanceResults.tsx` - Fetch results display component
- Attendance Pages: `app/(dashboard)/attendance/` (new directory)
  - `page.tsx` - Main attendance management page
  - `fetch/page.tsx` - Manual fetch interface page
- Test Files: `src/__tests__/` (following established test structure)
  - `services/zktService.test.ts` - ZKT service layer tests
  - `components/business/attendance/` - Component tests directory

### Authentication and Role-Based Access
[Source: architecture/data-models.md#user and backend-architecture.md]
**Role Validation Requirements**:
- All attendance fetch operations limited to ADMIN role
- Role-based middleware validation for all attendance management endpoints
- Session management integration following established NextAuth.js patterns
- Audit trail for manual fetch operations with user accountability

### ZKT Service Integration Requirements
**ZKT Service Capabilities**:
- Connection management with retry logic for network reliability
- Data fetch with date range filtering for targeted retrieval
- Employee ID mapping validation against Staff model database
- Error handling for ZKT communication failures with fallback capabilities
- Configuration management for multiple ZKT machine environments
- Data sanitization and validation for incoming attendance records

### Coding Standards
[Source: architecture/coding-standards.md]
**Naming Conventions**:
- Components: PascalCase (AttendanceFetch, AttendanceResults)
- Hooks: camelCase with 'use' prefix (useAttendanceFetch, useZktConnection)
- API Routes: kebab-case following established patterns
- Database Tables: snake_case (attendance_records)
- Type Definitions: PascalCase following type sharing patterns

**Development Patterns**:
- Environment Variables: Access through config objects, never process.env directly
- Error Handling: All ZKT operations must use standard error handler
- State Management: Use Zustand for attendance form data and fetch state
- API Patterns: Follow established Server Action patterns for attendance operations

### Project Structure Notes
ZKT attendance integration system builds on existing Staff model relationship patterns. Database schema extends current User and Staff model relationship patterns. UI components follow established shadcn/ui component organization. Authentication and authorization use existing NextAuth.js admin role-based access patterns. Testing follows established Jest + Testing Library + Supertest patterns from previous stories. ZKT service layer provides abstraction for machine-specific implementation details.

## Testing
[Source: architecture/testing-strategy.md]
- **Frontend Unit Testing**: Jest + Testing Library 29+/13+ for component and form testing
- **Backend Unit Testing**: Jest + Supertest 29+/6+ for service and API testing  
- **Test Locations**:
  - `src/__tests__/services/zktService.test.ts` - ZKT service layer business logic
  - `src/__tests__/components/business/attendance/` - UI component testing directory
  - `src/__tests__/actions/attendanceActions.test.ts` - Server Actions testing
- **Testing Scenarios**:
  - ZKT connection management with network failure scenarios
  - Attendance data fetch with various date ranges and employee mapping
  - Role-based access control for admin-only operations
  - Employee ID mapping validation against Staff model
  - Data validation and sanitization for ZKT response data
  - Database constraints and unique attendance record enforcement
  - Audit trail creation for manual fetch operations
  - UI component rendering and user interactions for attendance fetch
  - Complete manual attendance fetch workflow testing
  - Error handling for ZKT communication failures and recovery

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-14 | 1.0 | Initial story creation for manual attendance data fetch from ZKT | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes
- Successfully implemented manual attendance data fetch from ZKT machines
- All tasks and subtasks completed according to acceptance criteria
- Created comprehensive ZKT service integration layer with error handling and retry logic
- Built complete attendance data model with Prisma schema extending Staff model
- Implemented Server Actions with admin role validation and audit trail
- Created professional UI components using shadcn/ui for manual attendance fetch
- Added comprehensive testing suite covering service layer, actions, repository, and components
- All functionality restricted to ADMIN role users only
- Employee mapping validation against existing Staff model implemented
- Database migration created and applied successfully

### File List
**Database Schema:**
- `prisma/schema.prisma` - Added AttendanceRecord model with relationships to Staff and User models

**Types:**
- `types/attendance.ts` - Comprehensive attendance-related type definitions

**Services and Repositories:**
- `src/services/zktService.ts` - Already existed, enhanced ZKT integration service layer
- `src/repositories/attendanceRepository.ts` - New attendance data repository with CRUD operations

**Server Actions:**
- `src/actions/attendanceActions.ts` - Admin-only Server Actions for manual attendance fetch operations

**UI Components:**
- `src/components/business/attendance/AttendanceFetch.tsx` - Manual attendance fetch interface
- `src/components/business/attendance/AttendanceResults.tsx` - Attendance records display component
- `src/components/business/attendance/AttendanceDashboard.tsx` - Main attendance dashboard component

**Pages:**
- `src/app/attendance/page.tsx` - Main attendance management page
- `src/app/attendance/fetch/page.tsx` - Manual attendance fetch page

**UI Dependencies:**
- `src/components/ui/tabs.tsx` - Added tabs component via shadcn/ui

**Test Files:**
- `src/__tests__/actions/attendanceActions.test.ts` - Comprehensive Server Actions testing
- `src/__tests__/repositories/attendanceRepository.test.ts` - Repository layer testing with mocked Prisma
- `src/__tests__/components/business/attendance/AttendanceFetch.test.tsx` - React component testing
- `src/__tests__/integration/attendance-manual-fetch.test.ts` - End-to-end integration testing

**Database Migration:**
- `prisma/migrations/20250914123924_add_attendance_records/migration.sql` - Database migration for AttendanceRecord table

## QA Results

*This section will be populated by the QA agent during review*