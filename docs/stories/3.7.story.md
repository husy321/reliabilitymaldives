# Story 3.7: Customer Statement Generation

## Status
Draft

## Story
**As an Accounts team member,**
**I want to generate and export customer statements,**
**so that I can provide customers with current payables information.**

## Acceptance Criteria
1. Customer statement generation with current balance and transaction history
2. PDF export functionality for customer statements with company letterhead and professional layout
3. Statement templates with professional formatting and company branding

## Tasks / Subtasks
- [ ] Create customer statement data aggregation service (AC: 1)
  - [ ] Build CustomerStatementService for retrieving customer financial data
  - [ ] Implement balance calculation logic with current and historical transactions
  - [ ] Create transaction history compilation with receivables and payment records
  - [ ] Add statement date range selection and filtering capabilities
  - [ ] Implement aging analysis for outstanding receivables (30, 60, 90+ days)
- [ ] Implement PDF generation with professional formatting (AC: 2, 3)
  - [ ] Extend PDF Generation Service for customer statement templates
  - [ ] Create professional statement layout with company letterhead and branding
  - [ ] Build transaction detail tables with proper formatting and pagination
  - [ ] Add summary sections with current balance, overdue amounts, and payment terms
  - [ ] Implement customer address formatting and statement delivery information
- [ ] Build statement generation interface and export functionality (AC: 1, 2)
  - [ ] Create StatementGenerator component with customer selection and date range
  - [ ] Implement statement preview functionality before final generation
  - [ ] Add bulk statement generation for multiple customers
  - [ ] Create statement delivery options (download, email, print)
  - [ ] Build statement generation history and tracking system

## Dev Notes

### PDF Generation Service Integration
[Source: architecture/components.md#pdf-generation-service]
PDF Generation Service interfaces:
- `generateCustomerStatement(customerId, options)` - Branded customer statements with transaction history
- `applyCompanyBranding(pdfBuffer)` - Consistent company letterhead and formatting
- Dependencies: Customer Management Service, Receivables Service (data sources)
- Technology Stack: react-pdf for client-side generation or Puppeteer for server-side

### Customer Management Service Integration
[Source: architecture/components.md#customer-management-service]
Key interfaces:
- `generateStatement(customerId, dateRange)` - PDF statement creation with transaction history
- `getCustomerBalance(customerId)` - Real-time balance calculation from receivables
- Dependencies: PostgreSQL (customer data), Document Management (statement files), PDF generation library

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Database: PostgreSQL 15+ for production database with complex financial queries
- Frontend Language: TypeScript 5.0+ for type-safe development
- UI Component Library: shadcn/ui v4 for professional statement generation interface

### Data Model Requirements
[Source: architecture/data-models.md]
Customer statement data structure:
```typescript
interface CustomerStatement {
  id: string;
  customerId: string;
  statementDate: Date;
  fromDate: Date;
  toDate: Date;
  currentBalance: Decimal;

  customer: {
    name: string;
    email: string;
    address: string;
    paymentTerms: number;
  };

  transactions: StatementTransaction[];
  aging: AgingAnalysis;
  summary: StatementSummary;
}

interface StatementTransaction {
  date: Date;
  type: 'INVOICE' | 'PAYMENT' | 'CREDIT' | 'ADJUSTMENT';
  reference: string; // Invoice number or payment reference
  description: string;
  amount: Decimal;
  balance: Decimal;
}

interface AgingAnalysis {
  current: Decimal;      // 0-30 days
  thirtyDays: Decimal;   // 31-60 days
  sixtyDays: Decimal;    // 61-90 days
  ninetyPlusDays: Decimal; // 90+ days
  totalOutstanding: Decimal;
}
```

### Database Queries for Statement Generation
```sql
-- Customer statement transaction query
WITH statement_transactions AS (
  SELECT
    r.invoice_date as date,
    'INVOICE' as type,
    r.invoice_number as reference,
    'Invoice ' || r.invoice_number as description,
    r.amount,
    r.id as receivable_id
  FROM receivables r
  WHERE r.customer_id = $1
    AND r.invoice_date BETWEEN $2 AND $3

  UNION ALL

  SELECT
    p.payment_date as date,
    'PAYMENT' as type,
    p.payment_reference as reference,
    'Payment received' as description,
    -p.amount as amount,
    p.receivable_id
  FROM payments p
  JOIN receivables r ON p.receivable_id = r.id
  WHERE r.customer_id = $1
    AND p.payment_date BETWEEN $2 AND $3
)
SELECT *,
  SUM(amount) OVER (ORDER BY date, type) as running_balance
FROM statement_transactions
ORDER BY date, type;
```

### Coding Standards
[Source: architecture/coding-standards.md]
- Components: Use PascalCase naming (StatementGenerator.tsx, CustomerStatementPDF.tsx)
- API Routes: Use kebab-case for statement endpoints (/api/statements/generate)
- Type Sharing: Define statement types in shared types directory

### File Locations
- Statement service: `src/services/customerStatementService.ts`
- Statement generator: `src/components/business/receivables/StatementGenerator.tsx`
- PDF templates: `src/components/pdf/CustomerStatementTemplate.tsx`
- Statement API: `app/api/statements/generate/route.ts`
- Export API: `app/api/statements/export/[statementId]/route.ts`
- Types: `types/statement.ts`

### Testing Requirements
[Source: architecture/testing-strategy.md]
- Frontend Testing: Jest + Testing Library for statement generation interface
- Backend Testing: Jest + Supertest for statement API and PDF generation
- PDF generation testing with various customer data scenarios

## Testing
[Source: architecture/testing-strategy.md]
- Test file location: `src/__tests__/components/business/receivables/StatementGenerator.test.tsx`
- Test standards: Jest + Testing Library for React components, Jest + Supertest for API testing
- Testing frameworks: Jest 29+ and Testing Library 13+ with TypeScript support
- Specific requirements: Test statement data aggregation, PDF generation, company branding application, aging analysis calculations, and bulk statement generation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation for customer statement generation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes
*This section will be populated by the development agent during implementation*

### File List
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*