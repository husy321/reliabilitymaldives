# Story 3.8: Team Coordination and Handoff Management

## Status
Draft

## Story
**As a Sales or Accounts team member,**
**I want clear responsibility tracking and handoff capabilities,**
**so that customer follow-ups are coordinated without duplication.**

## Acceptance Criteria
1. Responsibility assignment field (Sales/Accounts) per customer account
2. Handoff action buttons with status change notifications
3. Internal team notes separate from customer communication logs

## Tasks / Subtasks
- [ ] Implement responsibility assignment system for customer accounts (AC: 1)
  - [ ] Add assignedTo field to Customer model with Sales/Accounts team designation
  - [ ] Create responsibility assignment interface with role-based permissions
  - [ ] Implement automatic assignment logic based on customer lifecycle stage
  - [ ] Add responsibility history tracking for accountability and audit trails
  - [ ] Build responsibility dashboard showing team member workload distribution
- [ ] Create handoff functionality with status change notifications (AC: 2)
  - [ ] Build HandoffRequest component with recipient selection and handoff reason
  - [ ] Implement handoff approval workflow for receiving team member
  - [ ] Create automated notifications for handoff requests and approvals
  - [ ] Add handoff status tracking (PENDING, APPROVED, REJECTED, COMPLETED)
  - [ ] Build handoff history interface showing all customer responsibility changes
- [ ] Develop internal team notes system separate from customer logs (AC: 3)
  - [ ] Create InternalNotes model separate from customer-facing communication logs
  - [ ] Build internal notes interface with team member visibility controls
  - [ ] Implement note categorization (HANDOFF, STRATEGY, ISSUE, COORDINATION)
  - [ ] Add internal note search and filtering capabilities
  - [ ] Create internal note notifications for relevant team members

## Dev Notes

### Data Model Extensions
Building on existing Customer and User models:
```typescript
interface Customer {
  // ... existing fields
  assignedToId: string | null;
  assignedToRole: UserRole; // 'SALES' or 'ACCOUNTS'
  assignmentHistory: AssignmentHistory[];

  // Relationships
  assignedTo?: User;
  internalNotes: InternalNote[];
  handoffRequests: HandoffRequest[];
}

interface AssignmentHistory {
  id: string;
  customerId: string;
  previousAssigneeId: string | null;
  newAssigneeId: string;
  assignedBy: string;
  assignmentReason: string;
  assignedAt: Date;
}

interface HandoffRequest {
  id: string;
  customerId: string;
  fromUserId: string;
  toUserId: string;
  requestReason: string;
  status: HandoffStatus;
  approvedAt: Date | null;
  completedAt: Date | null;
  notes: string | null;
}

enum HandoffStatus {
  PENDING = 'PENDING',
  APPROVED = 'APPROVED',
  REJECTED = 'REJECTED',
  COMPLETED = 'COMPLETED'
}

interface InternalNote {
  id: string;
  customerId: string;
  createdById: string;
  noteType: InternalNoteType;
  content: string;
  isPrivate: boolean; // Visible only to creator's team
  taggedUserIds: string[]; // Users to be notified
  createdAt: Date;
}

enum InternalNoteType {
  HANDOFF = 'HANDOFF',
  STRATEGY = 'STRATEGY',
  ISSUE = 'ISSUE',
  COORDINATION = 'COORDINATION'
}
```

### Database Schema Extensions
```sql
-- Add assignment tracking to customers
ALTER TABLE customers ADD COLUMN assigned_to_id UUID REFERENCES users(id);
ALTER TABLE customers ADD COLUMN assigned_to_role user_role;

-- Assignment history table
CREATE TABLE assignment_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    previous_assignee_id UUID REFERENCES users(id),
    new_assignee_id UUID NOT NULL REFERENCES users(id),
    assigned_by_id UUID NOT NULL REFERENCES users(id),
    assignment_reason TEXT NOT NULL,
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Handoff requests table
CREATE TYPE handoff_status AS ENUM ('PENDING', 'APPROVED', 'REJECTED', 'COMPLETED');

CREATE TABLE handoff_requests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    from_user_id UUID NOT NULL REFERENCES users(id),
    to_user_id UUID NOT NULL REFERENCES users(id),
    request_reason TEXT NOT NULL,
    status handoff_status DEFAULT 'PENDING',
    approved_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Internal team notes table
CREATE TYPE internal_note_type AS ENUM ('HANDOFF', 'STRATEGY', 'ISSUE', 'COORDINATION');

CREATE TABLE internal_notes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    created_by_id UUID NOT NULL REFERENCES users(id),
    note_type internal_note_type NOT NULL,
    content TEXT NOT NULL,
    is_private BOOLEAN DEFAULT false,
    tagged_user_ids UUID[],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_assignment_history_customer ON assignment_history(customer_id, assigned_at DESC);
CREATE INDEX idx_handoff_requests_to_user ON handoff_requests(to_user_id, status);
CREATE INDEX idx_internal_notes_customer ON internal_notes(customer_id, created_at DESC);
```

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- UI Component Library: shadcn/ui v4 with Dialog, Form, Badge, and Select components
- Database: PostgreSQL 15+ for complex relationship queries
- State Management: Zustand 4.4+ for handoff workflow state management

### Notification Service Integration
[Source: architecture/components.md#notification-service]
Utilizing existing notification interfaces:
- `sendNotification(userId, message, type)` - Direct handoff request notifications
- `broadcastToRole(role, message)` - Team coordination announcements
- Dependencies: Authentication Service (user/role targeting), Vercel KV (notification queue)

### Coding Standards
[Source: architecture/coding-standards.md]
- Components: Use PascalCase naming (HandoffRequestDialog.tsx, InternalNotesPanel.tsx)
- API Routes: Use kebab-case for handoff endpoints (/api/customers/handoff)
- Database Tables: Use snake_case (handoff_requests, internal_notes)

### File Locations
- Handoff components: `src/components/business/customers/HandoffRequestDialog.tsx`
- Internal notes: `src/components/business/customers/InternalNotesPanel.tsx`
- Responsibility assignment: `src/components/business/customers/ResponsibilityAssignment.tsx`
- Handoff API: `app/api/customers/handoff/route.ts`
- Internal notes API: `app/api/customers/internal-notes/route.ts`
- Assignment service: `src/services/customerAssignmentService.ts`
- Types: `types/customerCoordination.ts`

### Testing Requirements
[Source: architecture/testing-strategy.md]
- Frontend Testing: Jest + Testing Library for handoff workflow and internal notes
- Backend Testing: Jest + Supertest for assignment and handoff API endpoints
- Integration testing for complete coordination workflow

## Testing
[Source: architecture/testing-strategy.md]
- Test file location: `src/__tests__/components/business/customers/HandoffRequestDialog.test.tsx`
- Test standards: Jest + Testing Library for React components, Jest + Supertest for API testing
- Testing frameworks: Jest 29+ and Testing Library 13+ with TypeScript support
- Specific requirements: Test handoff request workflow, responsibility assignment, internal notes functionality, notification delivery, and team coordination features

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation for team coordination and handoff management | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes
*This section will be populated by the development agent during implementation*

### File List
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*