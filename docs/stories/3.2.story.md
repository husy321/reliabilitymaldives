# Story 3.2: Receivables Data Entry System

## Status  
Ready for Review

## Story
**As a Sales or Accounts team member,**
**I want a unified interface for entering receivables data,**
**so that both teams can coordinate on customer payment tracking.**

## Acceptance Criteria
1. Receivables entry form with fields: customer, invoice date, amount, payment received date
2. Role-based access allowing both Sales and Accounts team data entry
3. Data validation ensuring required fields and proper date/amount formats

## Tasks / Subtasks
- [ ] Create Receivable data model and database schema (AC: 1)
  - [ ] Define Receivable interface in `types/receivable.ts` with all essential fields from data model specification
  - [ ] Implement Prisma schema for receivables table with proper field types, constraints, and foreign key relationships to customers
  - [ ] Create database migration for receivables table with proper indexes for customer lookup and due date calculations
  - [ ] Add ReceivableStatus enum and related receivable state enums as specified in data models
- [ ] Implement Receivable Server Actions for CRUD operations (AC: 2, 3)
  - [ ] Create `createReceivableAction` Server Action with comprehensive data validation using Zod schemas
  - [ ] Implement `updateReceivableAction` with proper error handling and user role validation for both Sales and Accounts teams
  - [ ] Add `getReceivablesAction` with pagination, sorting, and filtering capabilities for customer-specific listings
  - [ ] Create `getReceivableByIdAction` for individual receivable details and editing workflows
  - [ ] Add proper role-based access control allowing SALES, ACCOUNTS, ADMIN, and MANAGER roles
  - [ ] Implement automatic due date calculation based on customer payment terms and invoice date
- [ ] Build Receivable data entry forms using shadcn/ui components (AC: 1, 3)
  - [ ] Create `ReceivableForm` component with all essential fields using shadcn/ui Form (customer selection, invoice number, dates, amounts)
  - [ ] Implement form validation using react-hook-form and Zod validation schemas with proper date and decimal validation
  - [ ] Add customer dropdown selection component integrated with existing customer database
  - [ ] Create invoice number input with validation for uniqueness and proper format
  - [ ] Build date picker components for invoice date and payment received date with proper date validation
  - [ ] Implement amount input fields with proper decimal formatting and validation
  - [ ] Add proper TypeScript interfaces for form props and component state management
- [ ] Create Receivable management interface with listing and entry (AC: 2)
  - [ ] Build `ReceivableListTable` component using shadcn/ui DataTable following established customer management patterns
  - [ ] Implement receivable search functionality with invoice number, customer name, and date range searches
  - [ ] Add sorting capabilities for invoice date, due date, amount, and status with visual indicators
  - [ ] Create pagination controls consistent with existing table components
  - [ ] Add receivable quick actions (Edit, View Details, Update Status, Record Payment)
  - [ ] Implement receivable filtering by status (pending, paid, overdue) and customer
- [ ] Create receivables management page integration (Integration requirement)
  - [ ] Build `app/receivables/page.tsx` with proper authentication and role-based access for both Sales and Accounts
  - [ ] Integrate ReceivableListTable and ReceivableForm components with proper state management
  - [ ] Add proper page layouts and navigation consistent with existing app structure
  - [ ] Implement URL-based state management for search, pagination, and filtering
  - [ ] Add proper loading states and error boundaries for receivable operations
  - [ ] Create receivable creation modal/dialog using shadcn/ui Dialog component
- [ ] Add comprehensive testing for receivables management functionality (Testing requirement)
  - [ ] Create unit tests for Receivable Server Actions with role-based access testing for both Sales and Accounts teams
  - [ ] Test ReceivableForm component with various input scenarios, validation, and date/amount formatting
  - [ ] Test ReceivableListTable component with search, sorting, pagination, and status filtering
  - [ ] Add integration tests for receivable CRUD workflow end-to-end with customer relationships
  - [ ] Test receivable data validation and error handling scenarios including date logic and amount validation
  - [ ] Verify role-based access control allows both Sales and Accounts teams proper receivable access

## Dev Notes

### Previous Story Insights
From Story 3.1 Customer Database completion:
- Customer data model established with proper relationships for receivables linking
- Server Action security patterns established for role-based operations with comprehensive validation
- shadcn/ui component integration consistent throughout existing application
- Database architecture supports proper customer foreign key relationships for receivables
- Component testing patterns established with Jest and Testing Library for comprehensive coverage
- Form component patterns established using react-hook-form with Zod validation schemas

Key technical foundations to build upon:
- Customer selection components can leverage existing customer management components and Server Actions
- Database schema supports receivable-customer relationships through foreign key constraints
- Role-based access control patterns support both Sales and Accounts team coordination requirements
- Form validation patterns enable complex date and decimal amount validation for receivables
- Testing infrastructure supports comprehensive component and integration testing for receivables workflows

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Language: TypeScript v5.0+ for type-safe receivable interfaces, form handling, and date/amount validation
- Frontend Framework: Next.js v14+ App Router for receivable management pages with role-based authentication for Sales and Accounts
- UI Component Library: shadcn/ui v4 components for forms, date pickers, data tables, and receivable interfaces
- State Management: Zustand v4.4+ for receivable form state, listing state management, and customer selection state
- Backend Framework: Next.js Server Actions v14+ for secure receivable CRUD operations with role coordination
- Database: PostgreSQL v15+ with proper indexing for receivable-customer relationships and due date calculations
- Authentication: NextAuth.js v4+ for role-based receivable management access control supporting both Sales and Accounts teams

### Data Model Requirements
[Source: architecture/data-models.md#receivable]
Receivable interface for database and component integration:
```typescript
interface Receivable {
  id: string;
  invoiceNumber: string;
  customerId: string;
  amount: Decimal;
  invoiceDate: Date;
  dueDate: Date;
  paidAmount: Decimal;
  status: ReceivableStatus;
  assignedTo: UserRole;
  createdAt: Date;
  updatedAt: Date;
  
  // Relationships
  customer: Customer;
  followUps: FollowUp[];
  documents: Document[];
}

enum ReceivableStatus {
  PENDING = 'PENDING',
  PARTIALLY_PAID = 'PARTIALLY_PAID',
  PAID = 'PAID',
  OVERDUE = 'OVERDUE',
  DISPUTED = 'DISPUTED'
}
```

Receivable form and component interfaces:
```typescript
interface ReceivableFormData {
  invoiceNumber: string;
  customerId: string;
  amount: number;
  invoiceDate: Date;
  paidAmount?: number;
  paymentReceivedDate?: Date;
  assignedTo: UserRole;
}

interface ReceivableListTableProps {
  receivables: Receivable[];
  currentUserRole: UserRole;
  totalCount: number;
  page: number;
  pageSize: number;
  searchTerm?: string;
  statusFilter?: ReceivableStatus[];
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onSearch: (searchTerm: string) => void;
  onEdit: (receivableId: string) => void;
  onStatusUpdate: (receivableId: string, status: ReceivableStatus) => Promise<void>;
  loading?: boolean;
}

interface ReceivableFormProps {
  receivable?: Receivable;
  customers: Customer[];
  onSubmit: (data: ReceivableFormData) => Promise<void>;
  onCancel: () => void;
  isLoading?: boolean;
  mode: 'create' | 'edit';
  currentUserRole: UserRole;
}
```

### Receivables Workflow Service Integration  
[Source: architecture/components.md#receivables-workflow-service]
Receivables Workflow Service interfaces established in architecture:
- `createReceivable(invoiceData)` - New invoice entry with automatic due date calculation based on customer payment terms
- `recordPayment(receivableId, amount, date)` - Payment processing with balance updates and status management
- `getOverdueAccounts(teamRole)` - Role-specific overdue account lists for coordinated follow-up
- `scheduleFollowUp(receivableId, date, notes)` - Follow-up planning with cross-team notifications

### Frontend Architecture Integration
[Source: architecture/frontend-architecture.md]
Component architecture for receivables management:
- Business components: `src/components/business/ReceivableListTable.tsx` (new component)
- Form components: `src/components/business/ReceivableForm.tsx` (new component)  
- Page components: `app/receivables/page.tsx` (new page)
- Server Actions: `src/lib/actions/receivables.ts` (new action file)
- Type definitions: `types/receivable.ts` (new type definitions)

### shadcn/ui Component Integration
Required shadcn/ui components for receivables management:
- **Form**: Receivable creation and editing forms with complex validation for dates and amounts
- **Input**: Text inputs for invoice number with validation for uniqueness
- **Select**: Customer dropdown selection integrated with existing customer database
- **DatePicker**: Invoice date and payment received date inputs with proper validation and formatting
- **NumberInput**: Amount fields with decimal formatting and validation for currency values
- **Button**: Form submission, cancel, and action buttons with proper loading states
- **Dialog**: Receivable creation modal and confirmation dialogs for actions
- **DataTable**: Receivable listing with search, sort, pagination, and status filtering capabilities
- **Badge**: Status indicators (Pending, Paid, Overdue) and team assignment displays
- **Card**: Receivable detail display and form containers with customer relationship display

Enhanced ReceivableListTable component following established patterns:
```typescript
interface ReceivableListTableProps {
  receivables: Receivable[];
  currentUserRole: UserRole;
  totalCount: number;
  page: number;
  pageSize: number;
  searchTerm?: string;
  statusFilter?: ReceivableStatus[];
  customerFilter?: string;
  dateRange?: { from: Date; to: Date };
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
  onPageChange: (page: number) => void;
  onSort: (column: string, direction: 'asc' | 'desc') => void;
  onSearch: (searchTerm: string) => void;
  onFilter: (filters: ReceivableFilters) => void;
  onEdit: (receivableId: string) => void;
  onStatusUpdate: (receivableId: string, status: ReceivableStatus) => Promise<void>;
  onRecordPayment: (receivableId: string) => void;
  loading?: boolean;
}

interface ReceivableFilters {
  searchTerm?: string;
  statusFilter?: ReceivableStatus[];
  customerFilter?: string;
  dueDateRange?: { from: Date; to: Date };
  amountRange?: { min: number; max: number };
  assignedToFilter?: UserRole[];
}
```

### Server Action Integration  
[Source: architecture/backend-architecture.md]
Receivable Server Actions for secure CRUD operations with customer relationships:

```typescript
// Create new receivable with automatic due date calculation
export async function createReceivableAction(
  formData: ReceivableFormData
): Promise<ActionResult<Receivable>>

// Update existing receivable with proper authorization for Sales and Accounts teams
export async function updateReceivableAction(
  receivableId: string,
  formData: ReceivableFormData
): Promise<ActionResult<Receivable>>

// Record payment against receivable with status updates
export async function recordPaymentAction(
  receivableId: string,
  paymentData: { amount: number; date: Date }
): Promise<ActionResult<Receivable>>

// Get paginated receivables with search, filtering, and customer relationships
export async function getReceivablesAction(
  params: {
    page?: number;
    pageSize?: number;
    searchTerm?: string;
    statusFilter?: ReceivableStatus[];
    customerId?: string;
    sortBy?: string;
    sortOrder?: 'asc' | 'desc';
    userRole: UserRole;
  }
): Promise<ActionResult<{
  receivables: Receivable[];
  totalCount: number;
  page: number;
  pageSize: number;
}>>

// Get single receivable with customer relationship for editing
export async function getReceivableByIdAction(
  receivableId: string
): Promise<ActionResult<Receivable>>
```

### Database Schema Integration
[Source: architecture/database-schema.md]
Receivables table schema with proper customer relationships and indexing:
```sql
-- Receivables table with customer relationships
CREATE TABLE receivables (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    invoice_number VARCHAR(100) NOT NULL UNIQUE,
    customer_id UUID NOT NULL REFERENCES customers(id),
    amount DECIMAL(15,2) NOT NULL CHECK (amount > 0),
    invoice_date DATE NOT NULL,
    due_date DATE NOT NULL,
    paid_amount DECIMAL(15,2) DEFAULT 0.00 CHECK (paid_amount >= 0),
    status receivable_status NOT NULL DEFAULT 'PENDING',
    assigned_to user_role NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Constraints
    CONSTRAINT check_paid_amount_not_exceed_amount CHECK (paid_amount <= amount),
    CONSTRAINT check_due_date_after_invoice_date CHECK (due_date >= invoice_date)
);

-- Performance indexes for receivable operations
CREATE INDEX idx_receivables_customer_status ON receivables(customer_id, status);
CREATE INDEX idx_receivables_due_date ON receivables(due_date) WHERE status IN ('PENDING', 'OVERDUE');
CREATE INDEX idx_receivables_invoice_search ON receivables USING gin(to_tsvector('english', invoice_number));
CREATE INDEX idx_receivables_status_assigned ON receivables(status, assigned_to);
```

Receivable query patterns for business operations:
- Customer receivables: `WHERE customer_id = $customerId ORDER BY due_date ASC`
- Overdue receivables: `WHERE status = 'OVERDUE' OR (status = 'PENDING' AND due_date < CURRENT_DATE)`
- Team-specific receivables: `WHERE assigned_to = $userRole AND status IN ('PENDING', 'OVERDUE')`
- Invoice search: `WHERE to_tsvector('english', invoice_number) @@ plainto_tsquery('english', $searchTerm)`

### File Locations
Based on unified project structure:
- Receivable list component: `src/components/business/ReceivableListTable.tsx` (new component)
- Receivable form component: `src/components/business/ReceivableForm.tsx` (new component)  
- Receivable management page: `app/receivables/page.tsx` (new page)
- Receivable server actions: `src/lib/actions/receivables.ts` (new action file)
- Receivable type definitions: `types/receivable.ts` (new type file)
- Receivable component tests: `src/__tests__/components/business/ReceivableForm.test.tsx` (new test file)
- Receivable table tests: `src/__tests__/components/business/ReceivableListTable.test.tsx` (new test file)  
- Receivable action tests: `src/__tests__/actions/receivables.test.ts` (new test file)
- Receivable integration tests: `src/__tests__/integration/receivable-crud-flow.test.ts` (new integration test)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define Receivable interfaces in shared types directory for component and action consistency
- **API Calls**: Use Server Actions exclusively for receivable operations, never direct HTTP calls  
- **Environment Variables**: Access configuration through config objects for database connections
- **Error Handling**: Receivable components must handle Server Action errors using established error patterns
- **State Updates**: Use proper useState and Zustand patterns for receivable form state, never mutate receivable data directly
- **Naming Conventions**: Receivable components use PascalCase, receivable handlers use camelCase with 'handle' prefix

### Technical Constraints
- Invoice numbers must be unique across the entire system with proper validation
- Invoice dates cannot be in the future with proper date validation
- Due dates must be calculated automatically based on customer payment terms (customer.paymentTerms days after invoice date)
- Amounts must be positive decimals with proper currency formatting and validation
- Payment amounts cannot exceed invoice amounts with constraint validation
- Both Sales and Accounts teams must have full access to receivable creation and editing
- Receivable search must support partial invoice number matching and customer name lookup
- Status updates must be properly tracked with automatic overdue status calculation based on due dates
- All receivable operations must maintain audit trails for financial compliance requirements
- Receivable listing must support performance optimization for large datasets with proper pagination

### Project Structure Notes
Current Next.js App Router structure supports receivables management pages with proper authentication middleware for both Sales and Accounts teams. Component architecture supports new receivable components in existing `src/components/business/` directory. Server Actions pattern allows secure receivable CRUD operations with role-based access control for team coordination. Database schema supports receivable-customer relationships through foreign key constraints without structural conflicts. shadcn/ui patterns enable consistent receivables management UI integration building upon customer management foundations.

## Testing
[Source: architecture/testing-strategy.md]
- Frontend Unit Testing: Jest v29+ with Testing Library for receivable form and listing components
- Component testing locations:
  - `src/__tests__/components/business/ReceivableForm.test.tsx` for receivable form component with date and amount validation testing
  - `src/__tests__/components/business/ReceivableListTable.test.tsx` for receivable listing with search, pagination, and status filtering
- Server Action testing: `src/__tests__/actions/receivables.test.ts` for receivable CRUD Server Actions with role-based access for both Sales and Accounts
- Integration testing: `src/__tests__/integration/receivable-crud-flow.test.ts` for end-to-end receivable management workflow with customer relationships
- Testing scenarios:
  - Receivable form validation with required fields, date logic validation, and amount format validation
  - Customer selection integration with existing customer database and proper relationship handling
  - Invoice number uniqueness validation and proper error handling for duplicate entries
  - Due date calculation accuracy based on customer payment terms and invoice date logic
  - Receivable search functionality with invoice number and customer name partial matching
  - Receivable listing pagination, sorting, and status filtering with various dataset sizes
  - Role-based access control testing ensuring both Sales and Accounts teams can access receivable management
  - Receivable CRUD operations with proper error handling for database constraints and validation errors
  - Payment recording functionality with proper balance calculations and status updates
  - Date picker components with proper validation and formatting for invoice and payment dates
  - Amount input validation with decimal formatting and currency display
  - Receivable status management with automatic overdue calculation based on due dates
- Mock Prisma database operations, Customer relationships, and User sessions for test isolation
- Performance testing for receivable search and listing with datasets of 1000+ receivables
- Test receivable-customer relationship integrity and proper foreign key constraint handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | Initial story creation with comprehensive technical context and Sales/Accounts coordination requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Code (Sonnet 4) - Used for complete receivables management system implementation

### Debug Log References
- Fixed UUID validation in tests for proper customer ID format
- Updated Prisma schema to use SQLite-compatible Float type instead of Decimal  
- Implemented role-based access control allowing both Sales and Accounts teams

### Completion Notes List
- ✅ Complete receivables data model with Prisma schema and TypeScript interfaces
- ✅ Full CRUD Server Actions with role-based access control for Sales and Accounts teams
- ✅ Comprehensive ReceivableForm component with validation and due date calculation
- ✅ Feature-rich ReceivableListTable with search, filtering, sorting, and pagination
- ✅ Payment recording functionality with balance tracking and status management
- ✅ Complete receivables management page with dashboard statistics and dialogs
- ✅ Comprehensive test coverage including unit tests, component tests, and integration tests
- ✅ All acceptance criteria implemented and validated
- ✅ Role coordination between Sales and Accounts teams fully supported

### File List
**New Files Created:**
- `types/receivable.ts` - Complete receivable type definitions and interfaces
- `src/lib/actions/receivables.ts` - Server Actions for receivable CRUD operations
- `src/components/ui/date-picker.tsx` - Reusable date picker component
- `src/components/business/ReceivableForm.tsx` - Receivable creation and editing form
- `src/components/business/ReceivableListTable.tsx` - Receivable listing with advanced features
- `src/components/business/PaymentRecordDialog.tsx` - Payment recording interface
- `src/components/business/ReceivableCreateDialog.tsx` - Receivable creation dialog
- `src/components/business/ReceivableEditDialog.tsx` - Receivable editing dialog
- `src/__tests__/actions/receivables.test.ts` - Server Action unit tests
- `src/__tests__/components/business/ReceivableForm.test.tsx` - Form component tests
- `src/__tests__/components/business/ReceivableListTable.test.tsx` - Table component tests
- `src/__tests__/integration/receivables-crud-flow.test.ts` - End-to-end integration tests

**Modified Files:**
- `prisma/schema.prisma` - Added Receivable model and ReceivableStatus enum
- `src/app/receivables/page.tsx` - Complete receivables management page implementation
- Database migration: `prisma/migrations/20250909100641_add_receivable_model/migration.sql`

## QA Results

*This section will be populated by the QA agent during review*