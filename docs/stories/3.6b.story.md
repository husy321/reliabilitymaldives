# Story 3.6b: Automated Notification System

## Status
Draft

## Story
**As an Accounts team member,**
**I want automated notifications for payment due dates,**
**so that I'm proactively alerted about required follow-ups.**

## Acceptance Criteria
1. Daily automated check for due payments with notification generation
2. Email or in-app notifications for overdue accounts

## Tasks / Subtasks
- [ ] Implement daily automated check system for due payments (AC: 1)
  - [ ] Create scheduled job for daily receivables due date checking
  - [ ] Build due date calculation logic considering payment terms and business days
  - [ ] Implement notification generation for approaching and overdue payments
  - [ ] Add configurable notification thresholds (3 days before, due date, 7 days after)
  - [ ] Create batch processing for large numbers of receivables
- [ ] Build comprehensive notification system for overdue accounts (AC: 2)
  - [ ] Implement email notification service with professional templates
  - [ ] Create in-app notification system using Server-Sent Events
  - [ ] Build notification queue management with retry logic for failed deliveries
  - [ ] Add notification preferences and user subscription management
  - [ ] Implement notification digest functionality for multiple alerts
- [ ] Integrate with existing Notification Service architecture (AC: 1, 2)
  - [ ] Extend existing Notification Service with receivables-specific functionality
  - [ ] Connect automated alerts with role-based notification routing
  - [ ] Implement notification persistence and read status tracking
  - [ ] Add notification history and audit trail for compliance
  - [ ] Create notification management interface for user preferences

## Dev Notes

### Notification Service Architecture
[Source: architecture/components.md#notification-service]
Existing Notification Service interfaces:
- `sendNotification(userId, message, type)` - Direct user notification with persistence
- `broadcastToRole(role, message)` - Role-based team notifications for Accounts team
- `scheduleAlert(entityId, alertDate, message)` - Automated due date and follow-up alerts
- `getNotificationStream(userId)` - SSE connection for real-time updates

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Cache: Vercel KV (Redis) Latest for session and data caching with notification queue management
- Backend Framework: Next.js API Routes 14+ for scheduled job processing
- Monitoring: Vercel Analytics Latest for notification delivery tracking

### Notification Service Dependencies
[Source: architecture/components.md#notification-service]
- Dependencies: Authentication Service (user/role targeting), Vercel KV (notification queue), PostgreSQL (notification persistence)
- Technology Stack: Server-Sent Events via Next.js API routes, Vercel KV for message queue, React hooks for frontend integration

### Database Schema for Automated Notifications
Building on existing notification patterns:
```sql
-- Notification types specific to receivables
CREATE TYPE notification_type AS ENUM (
  'DUE_DATE_APPROACHING',
  'PAYMENT_OVERDUE',
  'PAYMENT_SEVERELY_OVERDUE',
  'FOLLOW_UP_REMINDER',
  'CUSTOMER_PAYMENT_RECEIVED'
);

-- Scheduled notifications table
CREATE TABLE scheduled_notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    receivable_id UUID NOT NULL REFERENCES receivables(id),
    notification_type notification_type NOT NULL,
    scheduled_date TIMESTAMP WITH TIME ZONE NOT NULL,
    recipient_role user_role NOT NULL,
    is_processed BOOLEAN DEFAULT false,
    processed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Notification delivery tracking
CREATE TABLE notification_deliveries (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    notification_id UUID NOT NULL,
    recipient_id UUID NOT NULL REFERENCES users(id),
    delivery_method VARCHAR(50) NOT NULL, -- 'EMAIL', 'IN_APP', 'SMS'
    delivered_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    delivery_status VARCHAR(20) DEFAULT 'PENDING' -- 'PENDING', 'SENT', 'DELIVERED', 'FAILED', 'READ'
);

CREATE INDEX idx_scheduled_notifications_date ON scheduled_notifications(scheduled_date) WHERE is_processed = false;
CREATE INDEX idx_notification_deliveries_recipient ON notification_deliveries(recipient_id, delivery_status);
```

### Receivables Workflow Service Integration
[Source: architecture/components.md#receivables-workflow-service]
Key interfaces to extend:
- `getOverdueAccounts(teamRole)` - Role-specific overdue account lists for notification targeting
- `scheduleFollowUp(receivableId, date, notes)` - Follow-up planning integrated with notification scheduling

### Coding Standards
[Source: architecture/coding-standards.md]
- API Routes: Use kebab-case for notification endpoints (/api/notifications/scheduled)
- Error Handling: All API routes must use the standard error handler
- Type Sharing: Define notification types in shared types directory

### File Locations
- Scheduled job service: `src/services/scheduledNotificationService.ts`
- Email notification service: `src/services/emailNotificationService.ts`
- Notification API: `app/api/notifications/scheduled/route.ts`
- Daily check cron job: `app/api/cron/daily-receivables-check/route.ts`
- Notification types: `types/notification.ts`
- Notification store: `src/stores/notificationStore.ts`
- Email templates: `src/templates/email/`

### Testing Requirements
[Source: architecture/testing-strategy.md]
- Backend Testing: Jest + Supertest for notification API and scheduled job testing
- Integration testing for complete notification workflow
- Email delivery testing with mock services

## Testing
[Source: architecture/testing-strategy.md]
- Test file location: `src/__tests__/services/scheduledNotificationService.test.ts`
- Test standards: Jest + Supertest for API testing, Jest for service testing
- Testing frameworks: Jest 29+ with TypeScript support
- Specific requirements: Test scheduled job execution, notification generation logic, email delivery, in-app notification display, and notification preference management

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation for automated notification system | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes
*This section will be populated by the development agent during implementation*

### File List
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*