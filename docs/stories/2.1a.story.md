# Story 2.1a: File Upload API Implementation

## Status  
Ready for Done

## Story
**As a developer,**
**I want a functional file upload API using Next.js Server Actions,**
**so that users can upload documents through secure backend processing.**

## Acceptance Criteria
1. Next.js Server Action created for file upload handling with proper TypeScript types
2. Multipart form data processing with file stream handling
3. file storage to organized directory structure (/uploads/{category}/)

## Tasks / Subtasks
- [x] Create file upload Server Action with TypeScript types (AC: 1)
  - [x] Define Server Action function in `src/lib/actions/documents.ts`
  - [x] Add FormData parameter handling for file uploads
  - [x] Implement proper TypeScript interfaces for file upload response
  - [x] Add error handling with ActionResult type pattern
  - [x] Include file validation for basic security checks
- [x] Implement multipart form data processing (AC: 2)
  - [x] Extract files from FormData using `getAll('files')` method
  - [x] Handle file stream processing for multiple file uploads
  - [x] Add file metadata extraction (name, size, type)
  - [x] Implement proper async/await error handling for file operations
- [x] Create organized file storage system (AC: 3)
  - [x] Set up directory structure `/uploads/{category}/` organization
  - [x] Implement file path generation with category-based folders
  - [x] Add file name sanitization and collision prevention
  - [x] Store files using Node.js file system operations
  - [x] Create database record for uploaded file metadata
- [x] Add comprehensive unit tests for file upload functionality (Testing requirement)
  - [x] Test Server Action with mock FormData and files
  - [x] Test file validation logic with various file types
  - [x] Test directory creation and file storage operations
  - [x] Test error handling for invalid files and storage failures
  - [x] Mock file system operations for test isolation

## Dev Notes

### Previous Story Insights
From Story 1.4 completion:
- PostgreSQL database with UUID primary keys established but migration pending
- Document model exists in Prisma schema with proper relationships
- User authentication system available for upload accountability
- File storage will need to link to users table via `uploaded_by_id`

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Backend Language: TypeScript v5.0+ for unified language stack across project
- Backend Framework: Next.js API Routes v14+ for serverless API endpoints
- API Style: Server Actions + REST - Server Actions for form processing and mutations
- File Storage: Vercel Blob (Latest) for document storage with integrated CDN
- Database: PostgreSQL v15+ for ACID compliance and financial data integrity
- Backend Testing: Jest v29+ + Supertest v6+ for API and integration testing

### Database Schema Requirements
[Source: architecture/database-schema.md]
Document table structure for file metadata storage:
```sql
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    original_name VARCHAR(500) NOT NULL,
    stored_path VARCHAR(1000) NOT NULL,
    category document_category NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    uploaded_by_id UUID NOT NULL REFERENCES users(id),
    linked_to_customer_id UUID REFERENCES customers(id),
    linked_to_receivable_id UUID REFERENCES receivables(id),
    linked_to_sales_report_id UUID REFERENCES sales_reports(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT valid_file_size CHECK (file_size > 0 AND file_size <= 10485760) -- 10MB limit
);
```

### Data Models
[Source: architecture/data-models.md#document]
Document TypeScript interface:
```typescript
interface Document {
  id: string;
  originalName: string;
  storedPath: string;
  category: DocumentCategory;
  fileSize: number;
  mimeType: string;
  uploadedById: string;
  linkedToCustomerId: string | null;
  linkedToReceivableId: string | null;
  linkedToSalesReportId: string | null;
  createdAt: Date;
  
  // Relationships
  uploadedBy: User;
  linkedToCustomer?: Customer;
  linkedToReceivable?: Receivable;
  linkedToSalesReport?: SalesReport;
}

enum DocumentCategory {
  INVOICE = 'INVOICE',        // INV.xxxx/xx pattern
  PURCHASE_ORDER = 'PURCHASE_ORDER',  // PO.xxxx/xx pattern  
  DELIVERY_ORDER = 'DELIVERY_ORDER',  // DO.xxxx/xx pattern
  SALES_RECEIPT = 'SALES_RECEIPT',
  OTHER = 'OTHER'
}
```

### API Specifications
[Source: architecture/api-specification.md#nextjs-server-actions-primary]
Server Action pattern for document upload:
```typescript
// Server Actions for form processing (src/lib/actions/documents.ts)
export async function uploadDocumentAction(formData: FormData): Promise<ActionResult<Document>> {
  const files = formData.getAll('files') as File[];
  const customerId = formData.get('customerId') as string;
  const category = formData.get('category') as DocumentCategory;
  
  try {
    // File validation, storage, and database insertion
    const documents = await uploadDocuments(files, customerId, category);
    revalidatePath('/documents');
    return { success: true, data: documents };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

type ActionResult<T> = {
  success: true;
  data: T;
} | {
  success: false;
  error: string;
}
```

### Backend Architecture
[Source: architecture/backend-architecture.md]
- Service Architecture: Next.js API Routes with controller organization by business domain
- Database Architecture: Prisma ORM with repository pattern for data access abstraction
- Authentication and Authorization: NextAuth.js integration with role-based middleware

### File Locations
Based on current flat Next.js project structure:
- Server Actions: `src/lib/actions/documents.ts`
- File Storage: `/uploads/{category}/` directory structure
- Database models: Already defined in `prisma/schema.prisma`
- Tests: `src/__tests__/actions/` following current test structure
- Types: `types/` directory for shared TypeScript interfaces

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define types in shared location, import consistently
- **API Calls**: Never make direct HTTP calls - use service layer
- **Environment Variables**: Access only through config objects, never process.env directly
- **Error Handling**: All Server Actions must use standard ActionResult pattern
- **State Updates**: Never mutate state directly - use proper state management patterns
- **Naming Conventions**: Server Actions use camelCase, database tables use snake_case

### Technical Constraints
- Must use Vercel Blob storage instead of local file system for production
- File size limit: 10MB maximum per file (enforced by database constraint)
- Must link uploaded files to user via `uploaded_by_id` foreign key
- All file operations must be async with proper error handling
- Server Actions must return ActionResult type for consistent error handling

### Project Structure Notes
Current project uses flat Next.js structure instead of documented monorepo structure. All file paths reflect actual project structure with root-level `src/`, `prisma/`, and `types/` directories.

## Testing
[Source: architecture/testing-strategy.md]
- Backend Unit Testing: Jest v29+ for Server Action and file processing testing
- Integration Testing: Jest + Supertest for file upload workflow testing
- Test files location: Create tests in `src/__tests__/actions/` following current structure
- Mock file operations and Vercel Blob storage for unit test isolation
- Test FormData handling, file validation, and database operations
- Ensure proper TypeScript types in all test files

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Minor TypeScript linting warning resolved in test file

### Completion Notes List
- ✅ Prisma schema updated with Document model and DocumentCategory enum
- ✅ TypeScript types defined in shared types directory
- ✅ Server Action implemented with comprehensive file validation (size, type, empty file checks)
- ✅ Multipart form data processing with proper file stream handling
- ✅ Organized file storage with category-based directory structure
- ✅ File name sanitization and collision prevention using timestamps
- ✅ Database record creation for uploaded file metadata
- ✅ Comprehensive unit tests with 12 test cases covering success/failure scenarios
- ✅ Proper error handling throughout the upload process
- ✅ Authentication verification before file uploads
- ✅ Support for multiple file uploads in single request

### File List
**Modified Files:**
- `prisma/schema.prisma` - Added Document model and DocumentCategory enum

**New Files:**
- `types/document.ts` - Shared TypeScript interfaces and types
- `src/lib/actions/documents.ts` - Server Actions for file upload and retrieval
- `src/__tests__/actions/documents.test.ts` - Comprehensive unit tests

**Directory Structure Created:**
- `uploads/{category}/` - Organized file storage directories

## QA Results
[To be filled by QA Agent]