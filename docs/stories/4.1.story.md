# Story 4.1: Sales Report Data Structure

## Status  
Done

## Story
**As a developer,**
**I want a comprehensive sales report data model,**
**so that daily sales data can be stored with proper validation and relationships.**

## Acceptance Criteria
1. Sales report table with fields: outlet, date, cash deposits, card settlements, total sales
2. Database constraints preventing duplicate date submissions per outlet
3. Foreign key relationships linking reports to outlets and users

## Tasks / Subtasks
- [x] Create Outlet data model and database table (AC: 1, 3)
  - [x] Define Outlet TypeScript interface with id, name, location, managerId fields
  - [x] Create Outlet Prisma model with proper relationships to users and sales reports
  - [x] Add database migration for outlets table with unique name constraint
  - [x] Create outlet type definitions file in types/outlet.ts
- [x] Create SalesReport data model and database table (AC: 1, 2, 3)
  - [x] Define SalesReport TypeScript interface matching acceptance criteria requirements
  - [x] Create SalesReport Prisma model with outlet, date, cash, card, and total sales fields
  - [x] Add unique constraint preventing duplicate date submissions per outlet
  - [x] Add foreign key relationships to outlets and users tables
  - [x] Create sales report type definitions file in types/sales-report.ts
- [x] Update existing document model relationships (AC: 3)
  - [x] Verify Document model linkedToSalesReportId foreign key constraint
  - [x] Update document types to include sales report relationship
- [x] Create database migration for sales report system (AC: 1, 2, 3)
  - [x] Generate Prisma migration for outlets and sales_reports tables
  - [x] Verify migration includes all constraints and indexes for performance
  - [x] Test migration on development database to ensure data integrity
- [x] Add comprehensive testing for data models (Testing requirement)
  - [x] Create unit tests for SalesReport and Outlet TypeScript interfaces
  - [x] Test database constraints preventing duplicate submissions
  - [x] Test foreign key relationships and cascading operations
  - [x] Verify data validation and error handling for invalid data
  - [x] Test migration rollback functionality for deployment safety

## Dev Notes

### Previous Story Insights
From Story 3.3 Invoice and Document Linking completion:
- Established patterns for data model creation with proper foreign key relationships
- Document model already includes linkedToSalesReportId field ready for sales report integration
- PostgreSQL database patterns established for ACID compliance and financial data integrity
- Prisma ORM integration ready for new business model creation with type-safe database operations
- Testing infrastructure supports comprehensive data model validation and constraint testing

### Tech Stack Requirements  
[Source: architecture/tech-stack.md]
- Backend Language: TypeScript v5.0+ for type-safe data model definitions and business logic validation
- Database: PostgreSQL v15+ with ACID compliance for financial data integrity and audit trail requirements
- API Style: Server Actions + REST with Next.js native patterns for sales report data operations
- Backend Framework: Next.js API Routes v14+ for serverless data processing and sales report endpoints
- Backend Testing: Jest + Supertest v29+/6+ for comprehensive API testing and data model validation

**Database Discrepancy Noted:** Architecture specifies PostgreSQL v15+ but current Prisma schema uses SQLite. This story should implement models compatible with PostgreSQL as per architecture requirements.

### Data Model Requirements
[Source: architecture/data-models.md and database-schema.md analysis]
**Missing Sales Report Data Model** (to be created):
```typescript
interface SalesReport {
  id: string;
  outletId: string;
  date: Date;
  cashDeposits: number;  // Cash amount deposited
  cardSettlements: number;  // Card settlement amount
  totalSales: number;    // Calculated total sales
  submittedById: string; // Manager who submitted the report
  status: SalesReportStatus;
  createdAt: Date;
  updatedAt: Date;
  
  // Relationships
  outlet: Outlet;
  submittedBy: User;
  documents: Document[];
}

enum SalesReportStatus {
  DRAFT = 'DRAFT',
  SUBMITTED = 'SUBMITTED', 
  APPROVED = 'APPROVED',
  REJECTED = 'REJECTED'
}
```

**Missing Outlet Data Model** (to be created):
```typescript
interface Outlet {
  id: string;
  name: string;
  location: string;
  managerId: string;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
  
  // Relationships
  manager: User;
  salesReports: SalesReport[];
}
```

**Existing Document Model Integration:**
Document model already includes linkedToSalesReportId field [Source: current Prisma schema line 136], ready for sales report document attachment functionality.

### Database Schema Requirements
[Source: architecture/database-schema.md]
Database schema creation requirements following PostgreSQL patterns:

```sql
-- Outlets table for sales location management
CREATE TABLE outlets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) UNIQUE NOT NULL,
    location VARCHAR(500) NOT NULL,
    manager_id UUID NOT NULL REFERENCES users(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Sales reports table with duplicate prevention
CREATE TABLE sales_reports (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    outlet_id UUID NOT NULL REFERENCES outlets(id),
    date DATE NOT NULL,
    cash_deposits DECIMAL(15,2) NOT NULL,
    card_settlements DECIMAL(15,2) NOT NULL,
    total_sales DECIMAL(15,2) NOT NULL,
    submitted_by_id UUID NOT NULL REFERENCES users(id),
    status sales_report_status DEFAULT 'DRAFT',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Prevent duplicate date submissions per outlet
    CONSTRAINT unique_outlet_date UNIQUE(outlet_id, date),
    -- Ensure financial data integrity
    CONSTRAINT valid_amounts CHECK (cash_deposits >= 0 AND card_settlements >= 0 AND total_sales >= 0)
);

-- Performance indexes for business queries
CREATE INDEX idx_sales_reports_outlet_date ON sales_reports(outlet_id, date DESC);
CREATE INDEX idx_sales_reports_status ON sales_reports(status);
CREATE INDEX idx_outlets_manager ON outlets(manager_id) WHERE is_active = true;
```

### Prisma Model Integration
Current Prisma schema requires enhancement with SalesReport and Outlet models:

```typescript
enum SalesReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model Outlet {
  id          String   @id @default(uuid())
  name        String   @unique
  location    String
  managerId   String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  manager      User          @relation(fields: [managerId], references: [id], onDelete: Restrict)
  salesReports SalesReport[]

  @@index([managerId])
  @@index([isActive])
  @@map("outlets")
}

model SalesReport {
  id              String            @id @default(uuid())
  outletId        String
  date            DateTime          @db.Date
  cashDeposits    Float
  cardSettlements Float
  totalSales      Float
  submittedById   String
  status          SalesReportStatus @default(DRAFT)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  outlet      Outlet @relation(fields: [outletId], references: [id], onDelete: Restrict)
  submittedBy User   @relation(fields: [submittedById], references: [id], onDelete: Restrict)

  @@unique([outletId, date], name: "unique_outlet_date")
  @@index([outletId, date])
  @@index([status])
  @@index([submittedById])
  @@map("sales_reports")
}
```

### File Locations
Based on unified project structure [Source: architecture/unified-project-structure.md]:
- Type definitions: `types/sales-report.ts` (new file) and `types/outlet.ts` (new file)
- Prisma schema updates: `prisma/schema.prisma` (existing file to enhance)
- Database migration: `prisma/migrations/` (new migration file via `npx prisma migrate dev`)
- Test files: `src/__tests__/models/sales-report.test.ts` and `src/__tests__/models/outlet.test.ts` (new test files)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define SalesReport and Outlet interfaces in types directory for consistent usage across components
- **Database Tables**: Use snake_case naming for PostgreSQL compatibility (outlets, sales_reports)
- **API Routes**: Future endpoints should follow kebab-case convention (/api/sales-reports)
- **Error Handling**: All data model operations must include proper validation and constraint error handling

### Technical Constraints
- Sales reports must prevent duplicate date submissions per outlet via unique database constraint
- Financial amounts (cash, card, total) must be non-negative with decimal precision for currency accuracy
- Foreign key relationships must use RESTRICT to prevent accidental deletion of referenced data
- Date field must use database date type for proper date comparison and indexing
- All monetary calculations should maintain precision for accounting accuracy
- Migration must be reversible for deployment safety and rollback capability

### Project Structure Notes
Current Next.js App Router structure supports new data models within existing architecture. Prisma ORM integration ready for additional business models with proper TypeScript type generation. Database migration system supports incremental schema updates without data loss. Type definitions directory follows established patterns for shared interfaces across frontend and backend components.

**Critical Database Migration Note:** Current schema uses SQLite but architecture specifies PostgreSQL. This story should create models compatible with both for development flexibility while maintaining PostgreSQL production readiness.

## Testing
[Source: architecture/testing-strategy.md]
- **Backend Unit Testing**: Jest v29+ for SalesReport and Outlet interface validation and business logic testing
- **Database Testing**: Comprehensive constraint testing for duplicate prevention and foreign key relationships
- **Test Locations**:
  - `src/__tests__/models/sales-report.test.ts` - SalesReport model validation, constraint testing, and relationship verification
  - `src/__tests__/models/outlet.test.ts` - Outlet model validation and manager relationship testing
- **Migration Testing**: Test database migration application and rollback procedures in development environment
- **Testing Scenarios**:
  - SalesReport unique constraint preventing duplicate outlet/date combinations
  - Foreign key relationship integrity between outlets, users, and sales reports
  - Data validation for negative amounts and invalid date formats
  - Cascade behavior testing for related model deletions
  - Migration rollback testing to ensure data integrity during deployment issues
  - Database constraint error handling and proper error message formatting

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-10 | 1.0 | Initial story creation with comprehensive sales report data model requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent

### Debug Log References
No critical debug issues encountered. Minor lint issues with unused imports were resolved during implementation.

### Completion Notes List
- Successfully created Outlet and SalesReport data models with proper TypeScript interfaces
- Implemented comprehensive database schema with required constraints and foreign key relationships
- Generated database migration (20250910064826_add_sales_reports_and_outlets) successfully applied to development database
- Created 43 comprehensive test cases covering all model functionality, constraints, and edge cases
- All acceptance criteria fulfilled: sales report fields, unique constraints, and foreign key relationships
- Models are compatible with existing Document system through linkedToSalesReportId relationship

### File List
**New Files Created:**
- `types/outlet.ts` - Outlet TypeScript interface and related types
- `types/sales-report.ts` - SalesReport TypeScript interface and related types  
- `src/__tests__/models/outlet.test.ts` - Comprehensive Outlet model tests (20 test cases)
- `src/__tests__/models/sales-report.test.ts` - Comprehensive SalesReport model tests (23 test cases)
- `prisma/migrations/20250910064826_add_sales_reports_and_outlets/migration.sql` - Database migration

**Modified Files:**
- `prisma/schema.prisma` - Added Outlet and SalesReport models with relationships and constraints

## QA Results

*This section will be populated by the QA agent during review*