# Story 2.3a: Document Pattern Recognition Logic

## Status  
done

## Story
**As a developer,**
**I want automatic document categorization based on filename patterns,**
**so that documents are sorted without manual intervention.**

## Acceptance Criteria
1. Pattern matching logic for naming conventions: DO.xxxx/xx, PO.xxxx/xx, INV.xxxx/xx
2. Automatic category assignment based on detected patterns
3. Database storage of document categories with proper relationships

## Tasks / Subtasks
- [x] Implement pattern matching logic for document categorization (AC: 1)
  - [x] Create regex patterns for DO.xxxx/xx (Delivery Order) format validation
  - [x] Create regex patterns for PO.xxxx/xx (Purchase Order) format validation
  - [x] Create regex patterns for INV.xxxx/xx (Invoice) format validation
  - [x] Build pattern detection service with priority ordering for pattern conflicts
  - [x] Add support for case-insensitive pattern matching
- [x] Implement automatic category assignment system (AC: 2)
  - [x] Create document categorization service using detected patterns
  - [x] Map patterns to DocumentCategory enum values (DELIVERY_ORDER, PURCHASE_ORDER, INVOICE)
  - [x] Add fallback logic for unrecognized patterns (assign OTHER category)
  - [x] Integrate categorization into existing uploadDocumentAction workflow
  - [x] Add pattern recognition results to upload response for UI feedback
- [x] Update database integration with proper category relationships (AC: 3)
  - [x] Extend existing Document model validation to ensure proper category storage
  - [x] Update uploadDocumentAction to use automatic categorization before database storage
  - [x] Add database constraints validation for category assignment integrity
  - [x] Create database queries for category-based document retrieval
  - [x] Test category assignment persistence and retrieval accuracy
- [x] Add comprehensive unit testing for pattern recognition (Testing requirement)
  - [x] Test pattern matching with valid document names for all three formats
  - [x] Test edge cases: malformed patterns, partial matches, case variations
  - [x] Test category assignment logic with various filename scenarios
  - [x] Test integration with existing upload workflow and database storage
  - [x] Mock database operations and validate category persistence

## Dev Notes

### Previous Story Insights
From Story 2.2 completion:
- Server Action `uploadDocumentAction` fully implemented in `src/lib/actions/documents.ts`
- Document model operational with category field using DocumentCategory enum
- File validation system from Story 2.1b provides secure foundation for pattern analysis
- Upload workflow established with progress tracking and user feedback systems

Key integration points for pattern recognition:
- uploadDocumentAction currently accepts category as form parameter
- Document validation system ensures safe file processing before pattern analysis
- Toast notification system can provide immediate feedback on category detection

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Backend Language: TypeScript v5.0+ for type-safe pattern matching and category logic
- Backend Framework: Next.js API Routes v14+ with Server Actions for form processing
- Database: PostgreSQL v15+ with proper enum constraints for document categories
- Backend Testing: Jest v29+ for comprehensive pattern matching and service testing

### Data Model Requirements
[Source: architecture/data-models.md#document]
Document TypeScript interface with category integration:
```typescript
interface Document {
  id: string;
  originalName: string;
  storedPath: string;
  category: DocumentCategory;  // Pattern recognition target field
  fileSize: number;
  mimeType: string;
  uploadedById: string;
  linkedToCustomerId: string | null;
  linkedToReceivableId: string | null;
  linkedToSalesReportId: string | null;
  createdAt: Date;
  
  // Relationships for category-based queries
  uploadedBy: User;
  linkedToCustomer?: Customer;
  linkedToReceivable?: Receivable;
  linkedToSalesReport?: SalesReport;
}

enum DocumentCategory {
  INVOICE = 'INVOICE',        // INV.xxxx/xx pattern target
  PURCHASE_ORDER = 'PURCHASE_ORDER',  // PO.xxxx/xx pattern target
  DELIVERY_ORDER = 'DELIVERY_ORDER',  // DO.xxxx/xx pattern target
  SALES_RECEIPT = 'SALES_RECEIPT',
  OTHER = 'OTHER'  // Fallback for unrecognized patterns
}
```

### Database Schema Constraints
[Source: architecture/database-schema.md]
Document table with category enum constraint:
```sql
CREATE TYPE document_category AS ENUM ('INVOICE', 'PURCHASE_ORDER', 'DELIVERY_ORDER', 'SALES_RECEIPT', 'OTHER');

CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    original_name VARCHAR(500) NOT NULL,
    stored_path VARCHAR(1000) NOT NULL,
    category document_category NOT NULL,  -- Pattern recognition result storage
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    uploaded_by_id UUID NOT NULL REFERENCES users(id),
    linked_to_customer_id UUID REFERENCES customers(id),
    -- ... other fields
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Index for category-based document retrieval
CREATE INDEX idx_documents_category_customer ON documents(category, linked_to_customer_id);
```

### Core Workflow Integration
[Source: architecture/core-workflows.md#document-upload-and-categorization-workflow]
Pattern recognition integration points in upload workflow:
```
1. User drags and drops files → UI components
2. UI calls Server Action uploadDocumentAction(formData)
3. Pattern Recognition Service analyzes filename → detectCategory(filename)
4. Auto-detected category shown to user for confirmation
5. User confirms category or manually overrides
6. Document saved to database with confirmed category
```

Workflow timing requirements:
- Pattern recognition must complete within upload workflow's 30-second target
- Category detection should provide immediate feedback to user interface

### Service Architecture Requirements
[Source: architecture/backend-architecture.md]
Service layer integration with existing upload system:
- Create new categorization service following repository pattern
- Integrate with existing Prisma ORM for type-safe database operations
- Follow controller organization by business domain (document management)

### API Integration Pattern
Server Action enhancement for pattern recognition:
```typescript
// Enhanced uploadDocumentAction with automatic categorization
export async function uploadDocumentAction(formData: FormData): Promise<ActionResult<{documents: Document[], categoryDetections: CategoryDetection[]}>> {
  const files = formData.getAll('files') as File[];
  const customerId = formData.get('customerId') as string;
  
  try {
    // File validation (existing from Story 2.1b)
    await validateFiles(files);
    
    // NEW: Pattern recognition for each file
    const categoryDetections = files.map(file => detectDocumentCategory(file.name));
    
    // Process uploads with detected categories
    const documents = await uploadDocuments(files, customerId, categoryDetections);
    revalidatePath('/documents');
    
    return { 
      success: true, 
      data: { documents, categoryDetections }  // Include detection results for UI
    };
  } catch (error) {
    return { success: false, error: error.message };
  }
}
```

### File Locations
Based on current flat Next.js project structure:
- Pattern recognition service: `src/lib/services/documentCategorization.ts` (new service file)
- Updated Server Action: `src/lib/actions/documents.ts` (extend existing implementation)
- Type definitions: `types/document.ts` (extend existing types with detection results)
- Tests: `src/__tests__/services/documentCategorization.test.ts` (new test file)
- Integration tests: `src/__tests__/actions/documents.categorization.test.ts` (extend existing tests)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Define CategoryDetection and pattern result types in shared types directory
- **API Calls**: Never make direct HTTP calls - integrate with existing service layer pattern
- **Environment Variables**: Access through config objects if pattern configuration needed
- **Error Handling**: All Server Actions must use standard ActionResult pattern established in previous stories
- **State Updates**: Pattern detection results passed to UI through Server Action response
- **Naming Conventions**: Service functions use camelCase (`detectDocumentCategory`)

### Technical Constraints
- Pattern recognition must work with existing file validation from Story 2.1b
- Must integrate seamlessly with current upload workflow timing (30-second target)
- Pattern detection should be case-insensitive for user flexibility
- Fallback to OTHER category required for unrecognized patterns
- Must preserve existing Server Action response format while adding category detection data
- Database category assignment must be atomic with document creation

### Pattern Recognition Specifications
Required filename pattern formats:
1. **Delivery Orders**: DO.xxxx/xx (e.g., "DO.1234/23", "do.5678/24")
2. **Purchase Orders**: PO.xxxx/xx (e.g., "PO.9876/23", "po.4321/24") 
3. **Invoices**: INV.xxxx/xx (e.g., "INV.2468/23", "inv.1357/24")

Pattern matching requirements:
- Case-insensitive matching for flexibility
- Exact format validation (prefix.number/2-digit-year)
- Priority handling if multiple patterns could match
- Robust error handling for malformed patterns

### Project Structure Notes
Current project uses flat Next.js structure. Pattern recognition service will be placed in `src/lib/services/` following established service layer pattern. Integration with existing document upload workflow maintains consistency with current architecture. No conflicts with existing structure identified.

## Testing
[Source: architecture/testing-strategy.md]
- Backend Unit Testing: Jest v29+ for pattern matching logic and categorization service
- Integration Testing: Jest + existing Server Action testing patterns for upload workflow
- Test files location: `src/__tests__/services/` for service tests, extend existing `src/__tests__/actions/` for integration
- Pattern recognition test scenarios:
  - Valid patterns: DO.1234/23, PO.5678/24, INV.9012/25
  - Invalid patterns: malformed formats, missing components, incorrect structures  
  - Edge cases: case variations, extra characters, boundary conditions
  - Integration: full upload workflow with pattern detection and database storage
- Mock database operations and file validation for test isolation
- Ensure proper TypeScript types in all test files

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-08 | 2.0 | Implementation completed - all tasks and tests passing | James (Development Agent) |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Pattern matching debugging performed during test development
- Regex pattern refinement based on actual test cases
- Performance optimization through debug logging removal

### Completion Notes List
- ✅ Document pattern recognition service fully implemented with priority-based matching
- ✅ Enhanced uploadDocumentAction with automatic category detection
- ✅ Comprehensive unit test suite with 32 passing tests covering all scenarios
- ✅ Pattern matching supports case-insensitive detection and flexible filename formats
- ✅ Integration with existing document upload workflow maintains backward compatibility
- ✅ Fallback logic handles unrecognized patterns gracefully
- ✅ Fixed basename extraction logic to properly handle document filename patterns
- ✅ Optimized pattern matching performance for production use

### File List
#### New Files Created
- `src/lib/services/documentCategorization.ts` - Core pattern recognition service
- `src/__tests__/services/documentCategorization.test.ts` - Comprehensive unit tests
- `src/__tests__/actions/documents.categorization.test.ts` - Integration tests

#### Files Modified
- `src/lib/actions/documents.ts` - Enhanced with automatic categorization
- `types/document.ts` - Added CategoryDetection and UploadDocumentWithDetectionResult types

## QA Results

*This section will be populated by the QA agent during review*