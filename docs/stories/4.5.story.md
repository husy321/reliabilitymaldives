# Story 4.5: Approval and Rejection Workflow

## Status
Pending

## Story
**As an accountant,**
**I want approval and rejection capabilities with detailed feedback,**
**so that managers understand what corrections are needed.**

## Acceptance Criteria
1. Approve/reject action buttons with required comment functionality
2. Rejection reason categorization (missing documents, calculation errors, etc.)
3. Batch approve functionality for multiple reports

## Tasks / Subtasks
- [ ] Create approval and rejection action components (AC: 1)
  - [ ] Build ApprovalActions component with approve/reject buttons and confirmation dialogs
  - [ ] Implement required comment functionality with text area validation
  - [ ] Add approval confirmation dialog with comment requirement
  - [ ] Add rejection confirmation dialog with mandatory feedback fields
  - [ ] Integrate with existing SalesReportReview component for seamless workflow
- [ ] Implement rejection reason categorization system (AC: 2)
  - [ ] Build RejectionReasonSelector component with predefined categories
  - [ ] Create rejection categories: missing documents, calculation errors, discrepancies, invalid amounts
  - [ ] Add custom reason input field for specific feedback beyond predefined categories
  - [ ] Implement reason validation to ensure meaningful feedback is provided
  - [ ] Add rejection reason templates for common issues to speed up feedback process
- [ ] Build batch approval functionality interface (AC: 3)
  - [ ] Create BatchApprovalInterface component for multiple report selection
  - [ ] Implement report selection with checkboxes and "select all" functionality
  - [ ] Add batch approval confirmation with summary of selected reports
  - [ ] Implement batch approval processing with progress indicators
  - [ ] Add batch operation error handling for partial failures and retry mechanisms
- [ ] Create server actions for approval and rejection operations (AC: 1, 2, 3)
  - [ ] Build approveReport server action with comment processing and status updates
  - [ ] Build rejectReport server action with categorized reason handling
  - [ ] Build batchApproveReports server action for multiple report processing
  - [ ] Implement database transactions for approval/rejection operations with audit trails
  - [ ] Add validation for user permissions and report status before processing actions
- [ ] Integrate with Sales Report Workflow and Notification Services (AC: 1, 2, 3)
  - [ ] Connect approval actions with Sales Report Workflow Service for status management
  - [ ] Integrate with Notification Service for real-time manager notifications
  - [ ] Implement approval/rejection notifications with detailed feedback content
  - [ ] Add escalation notifications for rejected reports requiring manager action
  - [ ] Create notification templates for consistent communication across approval workflows
- [ ] Create comprehensive testing for approval/rejection workflow (Testing requirement)
  - [ ] Create unit tests for ApprovalActions component interactions and validation
  - [ ] Test RejectionReasonSelector category selection and custom reason input
  - [ ] Test BatchApprovalInterface selection logic and batch processing
  - [ ] Test server actions for approval, rejection, and batch operations
  - [ ] Test integration with notification service and workflow state management
  - [ ] Test role-based permissions and security for approval operations

## Dev Notes

### Previous Story Dependencies
From Story 4.4a Basic Split-Screen Review Layout:
- SalesReportReview component provides the foundation for approval/rejection action integration
- Split-screen layout accommodates approval action panel and feedback interface
- Review status system established for status updates and visual feedback
- Protected routes and role-based access control established for accountants
- Document viewer integration supports review of supporting materials before approval decisions

From Story 4.4b Advanced Comparison and Analysis Tools:
- Analysis tools provide enhanced context for approval decisions
- Discrepancy detection results inform rejection reason categorization
- Historical comparison data supports informed approval decisions
- Analysis results integration with approval workflow for data-driven feedback
- Pattern validation findings contribute to rejection reason specificity

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Framework: Next.js v14+ App Router for approval workflow routing and Server Components
- UI Component Library: shadcn/ui v4 for professional approval interface components and dialogs
- State Management: Zustand v4.4+ for approval workflow state and batch selection management
- Database: PostgreSQL v15+ for approval status updates and audit trail storage
- Backend Framework: Next.js Server Actions for approval/rejection processing with transaction support
- Authentication: NextAuth.js v4+ for role-based approval permissions and user validation
- Frontend Testing: Jest + Testing Library v29+/13+ for approval workflow component testing

### Component Architecture Requirements
[Source: architecture/components.md and frontend-architecture.md]
**Approval Component Location**: `src/components/approvals/` directory for approval workflow components
**Integration Pattern**: Enhance existing review components with approval action capabilities
**State Management**: React Query for server state management, Zustand for UI state and batch selections
**Dialog Components**: shadcn/ui Dialog components for confirmation workflows and feedback forms
**Form Handling**: React Hook Form for approval comment validation and reason categorization

### Sales Report Workflow Service Integration
[Source: architecture/components.md#sales-report-workflow-service]
**Enhanced Service Interfaces Required**:
- `approveReport(reportId, comments)` - Accountant approval with notification to manager
- `rejectReport(reportId, corrections)` - Rejection with specific correction requirements
- `batchApproveReports(reportIds, batchComments)` - Bulk approval processing with transaction management
- `getApprovalHistory(reportId)` - Historical approval/rejection tracking for audit trails
**Dependencies**: Document Management Service (supporting files), Authentication Service (role verification), Notification Service
**Technology Stack**: Server Actions for approval processing, shadcn/ui for approval interface components

### Notification Service Integration
[Source: architecture/components.md#notification-service]
**Required Notification Interfaces**:
- `sendNotification(managerId, approvalMessage, 'APPROVAL')` - Approval confirmation to manager
- `sendNotification(managerId, rejectionMessage, 'REJECTION')` - Rejection notice with correction details
- `broadcastToRole('MANAGER', batchApprovalMessage)` - Batch approval notifications to relevant managers
- `scheduleAlert(reportId, followUpDate, correctionReminder)` - Follow-up alerts for rejected reports
**Integration Requirements**: Real-time notifications for approval/rejection decisions with detailed feedback content

### Database Schema Requirements
**Enhanced SalesReport Status Management**:
```sql
-- Add approval tracking columns to existing sales_reports table
ALTER TABLE sales_reports ADD COLUMN approved_by UUID REFERENCES users(id);
ALTER TABLE sales_reports ADD COLUMN approved_at TIMESTAMPTZ;
ALTER TABLE sales_reports ADD COLUMN rejection_reason TEXT;
ALTER TABLE sales_reports ADD COLUMN rejection_category VARCHAR(50);

-- Create approval audit trail table
CREATE TABLE approval_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sales_report_id UUID REFERENCES sales_reports(id) NOT NULL,
  action VARCHAR(20) NOT NULL, -- 'APPROVED', 'REJECTED'
  performed_by UUID REFERENCES users(id) NOT NULL,
  comments TEXT,
  rejection_reason TEXT,
  rejection_category VARCHAR(50),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Create batch approval tracking table
CREATE TABLE batch_approvals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  batch_id UUID NOT NULL,
  performed_by UUID REFERENCES users(id) NOT NULL,
  report_count INTEGER NOT NULL,
  success_count INTEGER NOT NULL,
  failure_count INTEGER NOT NULL,
  comments TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_approval_history_report ON approval_history(sales_report_id);
CREATE INDEX idx_approval_history_user ON approval_history(performed_by);
CREATE INDEX idx_batch_approvals_user ON batch_approvals(performed_by);
```

### Data Model Extensions
[Source: Previous stories and sales-report types]
**Enhanced SalesReport Interface with Approval Data**:
```typescript
interface SalesReportWithApproval extends SalesReport {
  approvedBy?: User;
  approvedAt?: Date;
  rejectionReason?: string;
  rejectionCategory?: RejectionCategory;
  approvalHistory: ApprovalHistoryEntry[];
}

interface ApprovalHistoryEntry {
  id: string;
  action: 'APPROVED' | 'REJECTED';
  performedBy: User;
  comments?: string;
  rejectionReason?: string;
  rejectionCategory?: RejectionCategory;
  createdAt: Date;
}

enum RejectionCategory {
  MISSING_DOCUMENTS = 'MISSING_DOCUMENTS',
  CALCULATION_ERRORS = 'CALCULATION_ERRORS',
  DISCREPANCIES = 'DISCREPANCIES',
  INVALID_AMOUNTS = 'INVALID_AMOUNTS',
  INCOMPLETE_DATA = 'INCOMPLETE_DATA',
  POLICY_VIOLATION = 'POLICY_VIOLATION',
  OTHER = 'OTHER'
}

interface BatchApprovalRequest {
  reportIds: string[];
  comments?: string;
  batchId: string;
}

interface BatchApprovalResult {
  batchId: string;
  successCount: number;
  failureCount: number;
  errors: BatchApprovalError[];
  approvedReports: string[];
}
```

### Approval Action Component Design
**ApprovalActions Component Structure**:
```typescript
interface ApprovalActionsProps {
  report: SalesReportWithApproval;
  onApprove: (reportId: string, comments: string) => Promise<void>;
  onReject: (reportId: string, reason: RejectionData) => Promise<void>;
  disabled?: boolean;
}

interface RejectionData {
  category: RejectionCategory;
  reason: string;
  customReason?: string;
  correctionInstructions: string;
}
```

**Approval Workflow States**:
- **Initial State**: Display approve/reject buttons based on report status
- **Approval Flow**: Comment input → confirmation dialog → processing → success notification
- **Rejection Flow**: Category selection → reason input → correction instructions → confirmation → processing
- **Batch Flow**: Report selection → batch confirmation → progress tracking → results summary

### Rejection Reason Categories and Templates
**Predefined Rejection Categories**:
1. **Missing Documents**: Required supporting documents not attached or incomplete
2. **Calculation Errors**: Mathematical errors in cash, card, or total calculations
3. **Discrepancies**: Inconsistencies between reported amounts and supporting evidence
4. **Invalid Amounts**: Unrealistic or impossible amount values
5. **Incomplete Data**: Missing required fields or incomplete information
6. **Policy Violation**: Violations of company reporting policies or procedures
7. **Other**: Custom rejection reason with detailed explanation

**Rejection Reason Templates**:
- Standard templates for each category to ensure consistent feedback
- Customizable templates for outlet-specific or recurring issues
- Template variables for automatic population of report details
- Merge templates with custom comments for comprehensive feedback

### Batch Approval Requirements
**Batch Selection Interface**:
- Multi-select functionality with individual report checkboxes
- "Select All" and "Clear All" options for efficiency
- Smart filtering for batch-eligible reports (same outlet, date range, etc.)
- Visual indicators for reports with potential issues or discrepancies
- Batch size limits to prevent performance issues

**Batch Processing Logic**:
- Transaction-based processing for data consistency
- Individual report validation before batch approval
- Progress tracking and real-time status updates
- Rollback capability for failed batch operations
- Detailed results summary with success/failure breakdown

### User Interface Design Requirements
**Approval Action Panel**:
- Contextual action buttons that appear based on report status and user permissions
- Approval button: Green color with checkmark icon, requires comment confirmation
- Rejection button: Red color with X icon, opens rejection reason dialog
- Batch mode toggle: Switch between individual and batch approval interfaces
- Action history display showing previous approval/rejection decisions

**Confirmation Dialogs**:
- Approval confirmation: Simple comment input with character validation
- Rejection confirmation: Category selector, reason input, correction instructions
- Batch confirmation: Summary of selected reports with final approval confirmation
- Progress dialogs: Real-time progress indicators for batch operations

**Visual Feedback System**:
- Loading states during approval/rejection processing
- Success/error notifications with appropriate messaging
- Status badge updates reflecting approval/rejection decisions
- Audit trail display showing approval history and decision rationale

### File Locations
[Source: architecture/unified-project-structure.md]
- Approval Components: `src/components/approvals/` directory (new)
  - `ApprovalActions.tsx` - Main approval/rejection action component
  - `RejectionReasonSelector.tsx` - Rejection category and reason selection
  - `BatchApprovalInterface.tsx` - Batch approval functionality
  - `ApprovalConfirmationDialog.tsx` - Approval confirmation with comments
  - `RejectionConfirmationDialog.tsx` - Rejection confirmation with categorization
- Enhanced Review Component: `src/components/reviews/SalesReportReview.tsx` (modify existing)
- Server Actions: `app/actions/approval-actions.ts` (new file)
- Type Definitions: `types/approval.ts` (new file), extend existing `types/sales-report.ts`
- Test Files: `src/__tests__/components/approvals/` directory (new)
- Database Migrations: `prisma/migrations/add-approval-fields.sql` (new)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Component Naming**: Use PascalCase for approval components (`ApprovalActions.tsx`)
- **API Routes**: Use kebab-case for approval routes if needed (`/api/approvals`)
- **Type Sharing**: Define approval types in `types/approval.ts` for consistent interfaces
- **Error Handling**: All approval operations must use standard error handling patterns
- **State Updates**: Use proper state management patterns with immutable updates
- **Validation**: Implement comprehensive input validation for comments and reasons

### Authentication and Role-Based Access
[Source: architecture/components.md#authentication-service]
**Required Role Validation**:
- Approval actions restricted to ACCOUNTANT role with proper permissions validation
- Batch approval operations require elevated SENIOR_ACCOUNTANT or ADMIN permissions
- Approval history access controlled through proper authentication
- User session validation before processing approval/rejection operations
- Audit trail tracking for all approval decisions with user identification

### Performance Considerations
**Optimization Requirements**:
- Debounce batch selection changes to prevent excessive re-renders
- Implement pagination for approval history and batch results
- Cache approval permissions and user roles for efficient authorization
- Optimize database queries for batch operations with proper indexing
- Use React.memo for approval components to prevent unnecessary re-renders

### Integration with Existing Workflow
**Review Interface Enhancement**:
- Integrate approval actions seamlessly into existing SalesReportReview component
- Maintain split-screen layout with approval panel as additional section
- Preserve analysis tool integration for informed approval decisions
- Support approval actions from both individual and batch review interfaces

**Status Management Integration**:
- Update report status immediately upon approval/rejection decisions
- Trigger notification workflows for status changes
- Update dashboard counts and pending queues in real-time
- Maintain status audit trail for compliance and reporting

### Project Structure Notes
Approval workflow components integrate seamlessly with existing sales report review infrastructure. Server actions leverage established patterns for database operations and transaction management. Notification integration maintains consistency with existing alert systems. Role-based permissions align with established authentication patterns. Batch processing capabilities built on solid foundation of individual approval workflows.

## Testing
[Source: architecture/testing-strategy.md]
- **Frontend Unit Testing**: Jest + Testing Library v29+/13+ for approval workflow component validation
- **Integration Testing**: Jest + Supertest for approval server actions and database operations
- **E2E Testing**: Playwright for complete approval workflow validation across user roles
- **Test Locations**:
  - `src/__tests__/components/approvals/ApprovalActions.test.tsx` - Approval/rejection action testing
  - `src/__tests__/components/approvals/RejectionReasonSelector.test.tsx` - Category selection and validation
  - `src/__tests__/components/approvals/BatchApprovalInterface.test.tsx` - Batch selection and processing
  - `src/__tests__/actions/approval-actions.test.ts` - Server action testing for approval operations
  - `tests/e2e/approval-workflow.spec.ts` - End-to-end approval workflow testing
- **Testing Scenarios**:
  - Individual report approval with comment validation and status updates
  - Rejection workflow with category selection and custom reason input
  - Batch approval functionality with selection logic and progress tracking
  - Server action validation for approval/rejection operations
  - Integration with notification service for real-time updates
  - Role-based permissions and security for approval operations
  - Database transaction integrity for approval status changes
  - Error handling for failed approval operations and partial batch failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation for approval and rejection workflow | Claude Code |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent

### Implementation Status
**PENDING** - Story ready for development

### Completion Notes
*This section will be populated during implementation*

### File List
*This section will be populated during implementation*

### Debug Log References
*This section will be populated during implementation*

## QA Results

*This section will be populated by the QA agent during review*