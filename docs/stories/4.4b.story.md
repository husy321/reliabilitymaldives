# Story 4.4b: Advanced Comparison and Analysis Tools

## Status
Pending

## Story
**As an accountant,**
**I want comparison tools for detailed report analysis,**
**so that I can identify discrepancies and validate accuracy.**

## Acceptance Criteria
1. Comparison tools highlighting discrepancies or unusual patterns
2. Historical data comparison for trend analysis

## Tasks / Subtasks
- [ ] Create discrepancy detection and highlighting system (AC: 1)
  - [ ] Build DiscrepancyAnalyzer component with automatic detection algorithms
  - [ ] Implement variance calculation for cash vs card vs total sales relationships
  - [ ] Add threshold-based detection for unusual amounts or patterns
  - [ ] Create visual highlighting system for identified discrepancies with color coding
  - [ ] Add manual discrepancy flagging capability for accountant observations
- [ ] Implement pattern recognition and validation tools (AC: 1)
  - [ ] Build PatternValidator component for common sales report inconsistencies
  - [ ] Add calculation verification (cash + card â‰  total sales detection)
  - [ ] Implement suspicious amount detection (round numbers, duplicate amounts)
  - [ ] Add missing document pattern detection and alerts
  - [ ] Create business rule validation (weekend sales patterns, outlet-specific thresholds)
- [ ] Build historical comparison and trend analysis (AC: 2)
  - [ ] Create HistoricalComparison component with date range selection
  - [ ] Implement same-date comparison across multiple years/months
  - [ ] Add trend line visualization for outlet performance over time
  - [ ] Build week-over-week and month-over-month comparison views
  - [ ] Create seasonal pattern analysis and deviation detection
- [ ] Implement advanced analysis dashboard (AC: 1, 2)
  - [ ] Build SalesAnalyticsDashboard component with multiple analysis views
  - [ ] Add outlet comparison functionality for multi-location analysis
  - [ ] Implement statistical analysis (averages, medians, standard deviations)
  - [ ] Create export functionality for analysis reports and findings
  - [ ] Add filtering and sorting capabilities for analysis results
- [ ] Enhance review interface with analysis integration (AC: 1, 2)
  - [ ] Integrate analysis tools into existing SalesReportReview component
  - [ ] Add analysis panel toggle for expanded review capabilities
  - [ ] Implement real-time analysis updates as reports are reviewed
  - [ ] Create analysis summary cards for quick discrepancy overview
  - [ ] Add analysis-based approval recommendations and warnings
- [ ] Create comprehensive testing for analysis tools (Testing requirement)
  - [ ] Create unit tests for DiscrepancyAnalyzer algorithms and detection logic
  - [ ] Test PatternValidator business rules and calculation verification
  - [ ] Test HistoricalComparison data retrieval and trend calculations
  - [ ] Test SalesAnalyticsDashboard filtering, sorting, and export functionality
  - [ ] Test integration with existing review interface and user workflows

## Dev Notes

### Previous Story Dependencies
From Story 4.4a Basic Split-Screen Review Layout:
- SalesReportReview component provides the foundation for analysis tool integration
- Split-screen layout can accommodate additional analysis panel or overlay
- Document viewer integration supports analysis of supporting materials
- Review status system provides foundation for analysis-based recommendations
- Protected routes and role-based access control established for accountants

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- Frontend Framework: Next.js v14+ App Router for analysis route management and Server Components
- UI Component Library: shadcn/ui v4 for professional analysis interface components and data visualization
- State Management: Zustand v4.4+ for analysis state management and comparison data caching
- Database: PostgreSQL v15+ for historical data queries and trend analysis calculations
- Frontend Testing: Jest + Testing Library v29+/13+ for analysis algorithm and component testing

### Component Architecture Requirements
[Source: architecture/components.md and frontend-architecture.md]
**Analysis Component Location**: `src/components/analysis/` directory for advanced analysis tools
**Integration Pattern**: Extend existing review components with analysis capabilities
**State Management**: React Query for historical data fetching, Zustand for analysis UI state
**Visualization**: Chart.js or Recharts for trend analysis and pattern visualization
**Performance**: Implement virtualization for large historical datasets and analysis results

### Sales Report Workflow Service Integration
[Source: architecture/components.md#sales-report-workflow-service]
**Enhanced Service Interfaces Required**:
- `getHistoricalReports(outletId, dateRange, filters)` - Historical data for trend analysis
- `detectDiscrepancies(reportData, historicalContext)` - Automatic discrepancy detection
- `generateAnalysisReport(analysisType, parameters)` - Comprehensive analysis reporting
- `validateBusinessRules(reportData, outletRules)` - Business rule validation and pattern checking
**Dependencies**: Existing Document Management Service, Authentication Service, enhanced with statistical analysis capabilities

### Database Schema Requirements
**New Analysis Tables Required**:
```sql
CREATE TABLE analysis_rules (
  id UUID PRIMARY KEY,
  rule_type VARCHAR(50) NOT NULL, -- 'DISCREPANCY', 'PATTERN', 'THRESHOLD'
  rule_name VARCHAR(100) NOT NULL,
  rule_parameters JSONB NOT NULL,
  outlet_id UUID REFERENCES outlets(id), -- NULL for global rules
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE analysis_results (
  id UUID PRIMARY KEY,
  sales_report_id UUID REFERENCES sales_reports(id),
  analysis_type VARCHAR(50) NOT NULL,
  findings JSONB NOT NULL, -- Structured findings data
  severity VARCHAR(20) NOT NULL, -- 'LOW', 'MEDIUM', 'HIGH', 'CRITICAL'
  is_resolved BOOLEAN DEFAULT false,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_analysis_results_report ON analysis_results(sales_report_id);
CREATE INDEX idx_analysis_results_type ON analysis_results(analysis_type);
CREATE INDEX idx_analysis_results_severity ON analysis_results(severity);
```

### Data Model Extensions
[Source: Previous stories and sales-report types]
**Enhanced SalesReport Interface**:
```typescript
interface SalesReportWithAnalysis extends SalesReport {
  analysisResults: AnalysisResult[];
  discrepancies: Discrepancy[];
  historicalComparison: HistoricalComparison;
  patternFlags: PatternFlag[];
}

interface AnalysisResult {
  id: string;
  analysisType: 'DISCREPANCY' | 'PATTERN' | 'TREND' | 'THRESHOLD';
  findings: Record<string, any>;
  severity: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  isResolved: boolean;
  createdBy: string;
  createdAt: Date;
}

interface Discrepancy {
  id: string;
  type: 'CALCULATION' | 'PATTERN' | 'UNUSUAL_AMOUNT' | 'MISSING_DOC';
  field: string;
  expectedValue?: number;
  actualValue: number;
  variance: number;
  severity: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  description: string;
}

interface HistoricalComparison {
  previousPeriod: SalesReport[];
  sameDate: SalesReport[];
  trends: TrendAnalysis;
  averages: OutletAverages;
  deviations: DeviationAnalysis;
}
```

### Discrepancy Detection Algorithms
**Core Detection Logic**:
1. **Calculation Verification**: Ensure cash + card = total sales within acceptable tolerance
2. **Pattern Analysis**: Detect unusual patterns (all round numbers, repeated amounts)
3. **Threshold Detection**: Flag amounts significantly above/below historical averages
4. **Business Rule Validation**: Check against outlet-specific rules and seasonal patterns
5. **Document Correlation**: Verify reported amounts align with attached supporting documents

**Detection Thresholds**:
- Minor discrepancy: 1-5% variance from expected values
- Moderate discrepancy: 5-15% variance or suspicious patterns
- Major discrepancy: >15% variance or clear calculation errors
- Critical discrepancy: Impossible values or systematic errors

### Historical Analysis Requirements
**Comparison Types**:
1. **Same Date Analysis**: Compare current report with same date in previous periods
2. **Trend Analysis**: Analyze performance trends over weeks, months, quarters
3. **Seasonal Comparison**: Compare against seasonal patterns and expectations
4. **Outlet Benchmarking**: Compare outlet performance against peer outlets
5. **Day-of-Week Patterns**: Analyze typical patterns by day of week

**Statistical Analysis**:
- Calculate rolling averages, medians, and standard deviations
- Identify statistical outliers and anomalies
- Generate confidence intervals for expected values
- Perform regression analysis for trend identification

### User Interface Design Requirements
**Analysis Panel Layout**:
- Toggle-able analysis panel that extends the existing split-screen layout
- Tabbed interface for different analysis types (Discrepancies, Trends, Patterns)
- Interactive charts and visualizations using Chart.js or Recharts
- Expandable detail views for in-depth analysis results
- Export capabilities for analysis reports and findings

**Visual Indicators**:
- Color-coded severity levels (green: normal, yellow: minor, red: major, dark red: critical)
- Progress indicators for analysis completion
- Interactive tooltips explaining analysis findings
- Contextual help and documentation for analysis features

### File Locations
[Source: architecture/unified-project-structure.md]
- Analysis Components: `src/components/analysis/` directory (new)
  - `DiscrepancyAnalyzer.tsx` - Core discrepancy detection component
  - `PatternValidator.tsx` - Pattern recognition and validation
  - `HistoricalComparison.tsx` - Historical data comparison interface
  - `SalesAnalyticsDashboard.tsx` - Main analytics dashboard
- Enhanced Review Component: `src/components/reviews/SalesReportReview.tsx` (modify existing)
- Server Actions: `app/actions/analysis-actions.ts` (new file)
- Analysis Routes: `app/dashboard/sales-reports/analysis/` directory (new)
- Type Definitions: `types/analysis.ts` (new file), extend existing `types/sales-report.ts`
- Test Files: `src/__tests__/components/analysis/` directory (new)

### Coding Standards
[Source: architecture/coding-standards.md]
- **Component Naming**: Use PascalCase for analysis components (`DiscrepancyAnalyzer.tsx`)
- **API Routes**: Use kebab-case for analysis routes (`/dashboard/sales-reports/analysis`)
- **Type Sharing**: Define analysis types in `types/analysis.ts` for consistent interfaces
- **Error Handling**: All analysis operations must use standard error handling patterns
- **Performance**: Implement debouncing for real-time analysis and caching for historical data

### Authentication and Role-Based Access
[Source: architecture/components.md#authentication-service]
**Required Role Validation**:
- Analysis tools restricted to ACCOUNTANT role with extended permissions
- Historical data access controlled through proper authentication
- Analysis configuration requires ADMIN or SENIOR_ACCOUNTANT permissions
- Analysis results are auditable and tracked for compliance

### Performance Considerations
**Optimization Requirements**:
- Implement pagination for large historical datasets
- Use virtual scrolling for analysis results with many items
- Cache historical data and analysis results using Vercel KV
- Implement debounced analysis updates to prevent excessive calculations
- Use React.memo and useMemo for expensive analysis computations

### Integration with Notification Service
**Analysis-Based Notifications**:
- Automatic alerts for critical discrepancies detected
- Daily summary of analysis findings for supervisors
- Trend alerts for significant deviations from historical patterns
- Integration with existing notification infrastructure

### Business Rules Configuration
**Configurable Rules System**:
- Admin interface for managing analysis rules and thresholds
- Outlet-specific rules and parameters
- Seasonal adjustment factors for analysis
- Rule versioning and audit trail for compliance

### Project Structure Notes
Analysis components integrate seamlessly with existing sales report review workflow. Historical data analysis leverages existing PostgreSQL database with optimized queries. Discrepancy detection algorithms are modular and extensible. Analysis results are persisted for audit trails and continuous improvement. Integration with existing authentication and notification systems maintains security and user experience consistency.

## Testing
[Source: architecture/testing-strategy.md]
- **Frontend Unit Testing**: Jest + Testing Library v29+/13+ for analysis algorithms and component validation
- **Integration Testing**: Jest + Supertest for analysis API endpoints and data processing
- **Test Locations**:
  - `src/__tests__/components/analysis/DiscrepancyAnalyzer.test.tsx` - Algorithm validation and detection logic
  - `src/__tests__/components/analysis/PatternValidator.test.tsx` - Pattern recognition and business rules
  - `src/__tests__/components/analysis/HistoricalComparison.test.tsx` - Historical data processing and trends
  - `src/__tests__/components/analysis/SalesAnalyticsDashboard.test.tsx` - Dashboard functionality and user interactions
  - `src/__tests__/actions/analysis-actions.test.ts` - Server action testing for analysis operations
- **Testing Scenarios**:
  - Discrepancy detection accuracy with various test cases and edge conditions
  - Pattern recognition effectiveness with historical data samples
  - Historical comparison calculations and trend analysis accuracy
  - Analysis dashboard filtering, sorting, and export functionality
  - Integration with existing review interface and user workflows
  - Performance testing with large historical datasets
  - Analysis rule configuration and validation testing
  - Role-based access control for analysis features

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation for advanced comparison and analysis tools | Claude Code |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent

### Implementation Status
**PENDING** - Story ready for development

### Completion Notes
*This section will be populated during implementation*

### File List
*This section will be populated during implementation*

### Debug Log References
*This section will be populated during implementation*

## QA Results

*This section will be populated by the QA agent during review*